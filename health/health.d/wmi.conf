
## CPU

 template: wmi_10min_cpu_usage
       on: wmi.cpu_utilization_total
    class: Utilization
     type: Windows
component: CPU
       os: linux
    hosts: *
   lookup: average -10m unaligned match-names of dpc,user,privileged,interrupt
    units: %
    every: 1m
     warn: $this > (($status >= $WARNING)  ? (75) : (85))
     crit: $this > (($status == $CRITICAL) ? (85) : (95))
    delay: down 15m multiplier 1.5 max 1h
     info: average CPU utilization over the last 10 minutes
       to: sysadmin


## Memory

 template: wmi_ram_in_use
       on: wmi.memory_utilization
    class: Utilization
     type: Windows
component: Memory
       os: linux
    hosts: *
     calc: ($used) * 100 / ($used + $available)
    units: %
    every: 10s
     warn: $this > (($status >= $WARNING)  ? (80) : (90))
     crit: $this > (($status == $CRITICAL) ? (90) : (98))
    delay: down 15m multiplier 1.5 max 1h
     info: memory utilization
       to: sysadmin

 template: wmi_swap_in_use
       on: wmi.memory_swap_utilization
    class: Utilization
     type: Windows
component: Memory
       os: linux
    hosts: *
     calc: ($used) * 100 / ($used + $available)
    units: %
    every: 10s
     warn: $this > (($status >= $WARNING)  ? (80) : (90))
     crit: $this > (($status == $CRITICAL) ? (90) : (98))
    delay: down 15m multiplier 1.5 max 1h
     info: swap memory utilization
       to: sysadmin


## Network

 template: wmi_inbound_packets_discarded
       on: wmi.net_discarded
    class: Errors
     type: Windows
component: Network
       os: linux
    hosts: *
 families: *
   lookup: sum -10m unaligned absolute match-names of inbound
    units: packets
    every: 1m
     warn: $this >= 5
    delay: down 1h multiplier 1.5 max 2h
     info: number of inbound discarded packets for the network interface in the last 10 minutes
       to: sysadmin

 template: wmi_outbound_packets_discarded
       on: wmi.net_discarded
    class: Errors
     type: Windows
component: Network
       os: linux
    hosts: *
 families: *
   lookup: sum -10m unaligned absolute match-names of outbound
    units: packets
    every: 1m
     warn: $this >= 5
    delay: down 1h multiplier 1.5 max 2h
     info: number of outbound discarded packets for the network interface in the last 10 minutes
       to: sysadmin

 template: wmi_inbound_packets_errors
       on: wmi.net_errors
    class: Errors
     type: Windows
component: Network
       os: linux
    hosts: *
 families: *
   lookup: sum -10m unaligned absolute match-names of inbound
    units: packets
    every: 1m
     warn: $this >= 5
    delay: down 1h multiplier 1.5 max 2h
     info: number of inbound errors for the network interface in the last 10 minutes
       to: sysadmin

 template: wmi_outbound_packets_errors
       on: wmi.net_errors
    class: Errors
     type: Windows
component: Network
       os: linux
    hosts: *
 families: *
   lookup: sum -10m unaligned absolute match-names of outbound
    units: packets
    every: 1m
     warn: $this >= 5
    delay: down 1h multiplier 1.5 max 2h
     info: number of outbound errors for the network interface in the last 10 minutes
       to: sysadmin


## Disk

 template: wmi_disk_in_use
       on: wmi.logical_disk_utilization
    class: Utilization
     type: Windows
component: Disk
       os: linux
    hosts: *
     calc: ($used) * 100 / ($used + $free)
    units: %
    every: 10s
     warn: $this > (($status >= $WARNING)  ? (80) : (90))
     crit: $this > (($status == $CRITICAL) ? (90) : (98))
    delay: down 15m multiplier 1.5 max 1h
     info: disk space utilization
       to: sysadmin

### TCP
 template: wmi_1m_ip_tcp_resets
       on: wmi.tcp_conns_resets
    class: Errors
     type: Windows
component: Network
       os: *
    hosts: *
   lookup: average -1m unaligned absolute of ipv4,ipv6
    units: tcp resets/s
    every: 10s
     info: average number of TCP RESETS over the last minute

 template: wmi_10s_ip_tcp_resets
       on: wmi.tcp_conns_resets
    class: Errors
     type: System
component: Network
       os: *
    hosts: *
   lookup: average -10s unaligned absolute of ipv4,ipv6
    units: tcp resets/s
    every: 10s
     warn: $netdata.uptime.uptime > (1 * 60) AND $this > ((($wmi_1m_ip_tcp_resets < 5)?(5):($wmi_1m_ip_tcp_resets)) * (($status >= $WARNING)  ? (1) : (10)))
    delay: up 20s down 60m multiplier 1.2 max 2h
  options: no-clear-notification
     info: average number of sent TCP RESETS over the last 10 seconds. \
           This can indicate a port scan, \
           or that a service running on this host has crashed. \
           Netdata will not send a clear notification for this alarm.
       to: sysadmin

### IIS
 template: iis_request_throughput
       on: iis.website_requests_rate
    class: Utilization
     type: Windows
component: IIS
       os: *
    hosts: *
   lookup: average -1m of requests
    units: requests
    every: 10s
     warn: ($this > 120) ? ($requests < (($status >= $WARNING) ?  ($this * 0.5) : ($this * 0.4)) ) : (0)
     crit: ($this > 120) ? ($requests < (($status == $CRITICAL) ? ($this * 0.2) : ($this * 0.4)) ) : (0)
    delay: up 2m down 15m multiplier 1.5 max 1h
     info: A rapid decrease in requests can indicate infra issues.
       to: sysadmin

# Keeping this silent, because a log analysis is also necessary for this event
 template: iis_error_locked
       on: iis.website_errors_rate
    class: Utilization
     type: Windows
component: IIS
       os: *
    hosts: *
   lookup: average -1m of document_locked
    units: requests
    every: 10s
     warn: ($netdata.uptime.uptime > (60) AND $document_locked > (0)) ? ( $document_locked > (($status >= $WARNING ) ? ( $this ) : ( 2 * $this )) ) : ( 0 )
     info: A high number of requests returning 423 for $label:website.
       to: silent

 template: iis_uptime
       on: iis.website_uptime
    class: Utilization
     type: Windows
component: IIS
       os: *
    hosts: *
     calc: ($uptime > 0) ? (1) : (0)
    units: requests
    every: 10s
     warn: $this == 0
     info: The site $label:website is unavailable.
       to: sysadmin

### MSSQL
# Source: https://www.aimbetter.com/cache-hit-ratio/
 template: wmi_mssql_hit_ratio
       on: wmi.mssql_instance_cache_hit_ratio
    class: Workload
     type: Windows
component: MSSQL
       os: *
    hosts: *
   lookup: average -1m unaligned of hit_ratio
    units: %
    every: 10s
     warn: $this < (($status >= $WARNING)  ? (80) : (70))
     crit: $this < (($status == $CRITICAL) ? (69) : (50))
    delay: down 15m multiplier 1.5 max 1h
     info: Average cache hit ratio in db $label:mssql_instance over the last minute
       to: sysadmin

 template: wmi_mssql_blocked_processes
       on: wmi.mssql_instance_blocked_processes
    class: Workload
     type: Windows
component: MSSQL
       os: *
    hosts: *
   lookup: average -30s unaligned of blocked
    units: %
    every: 10s
     warn: $this > (($status >= $WARNING)  ? (25) : (30))
     crit: $this > (($status == $CRITICAL) ? (40) : (50))
    delay: down 5m multiplier 2.0 max 1h
     info: A high number of process has been blocked in past 30s for $label:mssql_instance
       to: sysadmin

 template: wmi_mssql_error_offline
       on: wmi.mssql_instance_sql_errors_total
    class: Error
     type: Windows
component: MSSQL
       os: *
    hosts: *
   lookup: average -30s unaligned of offline
    units: errors
    every: 10s
     crit: $netdata.uptime.uptime > (60) AND $this != 0
    delay: down 1m multiplier 2.0 max 30m
     info: Instance $label:mssql_instance is offline
       to: sysadmin

 template: wmi_mssql_error_kill_connection
       on: wmi.mssql_instance_sql_errors_total
    class: Error
     type: Windows
component: MSSQL
       os: *
    hosts: *
   lookup: sum -1m unaligned of Kill*
    units: errors
    every: 10s
     warn: $this > (($status >= $WARNING)  ? (15) : (10))
     crit: $this > (($status == $CRITICAL) ? (30) : (20))
    delay: down 1m multiplier 2.0 max 30m
     info: High number of killed connection for $label:mssql_instance.
       to: sysadmin

 template: wmi_mssql_lock_wait
       on: wmi.mssql_instance_locks_lock_wait
    class: Utilization
     type: Windows
component: MSSQL
       os: *
    hosts: *
   lookup: average -1m unaligned foreach *
    units: miliseconds
    every: 30s
     warn: $this > (($status >= $WARNING)  ? (1000) : (2000))
     crit: $this > (($status == $CRITICAL) ? (5000) : (2000))
    delay: down 10m multiplier 1.5 max 1h
     info: A long wait to lock for $label:mssql_instance.
       to: sysadmin

 template: wmi_mssql_user_connection
       on: wmi.mssql_instance_user_connection
    class: Utilization
     type: Windows
component: MSSQL
       os: *
    hosts: *
   lookup: sum -10s of active
    units: connections
    every: 10s
     warn: $this > (($status >= $WARNING)  ? (375) : (325))
     crit: $this > (($status == $CRITICAL) ? (425) : (375))
    delay: up 20s down 20m multiplier 1.2 max 2h
     info: You are having a higher number of active connections for $label:mssql_instance, \
           depending of hardware and configuration you can reach TCP congestion.
       to: sysadmin

