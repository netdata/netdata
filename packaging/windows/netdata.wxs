<?xml version="1.0" encoding="utf-8"?>

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
    <Package Name="Netdata Agent Installer"
             Manufacturer="Netdata Inc."
             Version="2.0.0.0"
             UpgradeCode="0d949b90-a54d-4aae-9616-e15fbc410530">

        <MediaTemplate EmbedCab="yes"/>

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

        <Feature Id="Main">
            <ComponentGroupRef Id="NetdataComponents" />
            <ComponentRef Id="WevtManifestComponent" />
            <ComponentRef Id="WevtDllComponent" />
            <!-- ComponentRef Id="NetdataService" /-->
        </Feature>

        <StandardDirectory Id="ProgramFilesFolder">
            <Directory Id="INSTALLFOLDER" Name="Netdata Agent">
                <Directory Id="USRDIR" Name="usr">
                    <Directory Id="USRBINDIR" Name="bin" />
                </Directory>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="SystemFolder">
        </StandardDirectory>

    </Package>

    <Fragment>
        <!-- All the files except for the ones we need to handle specially -->
        <ComponentGroup Id="NetdataComponents" Directory="INSTALLFOLDER">
            <Files Include="C:\msys64\opt\netdata\**">
                <Exclude Files="C:\msys64\opt\netdata\usr\bin\netdata.exe" />
                <Exclude Files="C:\msys64\opt\netdata\usr\bin\wevt_netdata_manifest.xml" />
                <Exclude Files="C:\msys64\opt\netdata\usr\bin\wevt_netdata.dll" />
            </Files>
        </ComponentGroup>

        <!-- Install wevt manifest file -->
        <Component Id="WevtManifestComponent" Directory="SystemFolder" Guid="*">
            <File Id="WevtManifest" Name="wevt_netdata_manifest.xml" Source="C:\msys64\opt\netdata\usr\bin\wevt_netdata_manifest.xml" KeyPath="yes" />
        </Component>

        <!-- Install wevt dll file -->
        <Component Id="WevtDllComponent" Directory="SystemFolder" Guid="*">
            <File Id="WevtDll" Name="wevt_netdata.dll" Source="C:\msys64\opt\netdata\usr\bin\wevt_netdata.dll" KeyPath="yes" />
        </Component>

        <!-- Comment out once it's ready:
            <Component Id="NetdataService" Directory="USRBINDIR" Guid="*">
                <File Id="NetdataExe" Name="netdata.exe" Source="C:\msys64\opt\netdata\usr\bin\netdata.exe" KeyPath="yes" />

                <ServiceInstall Id="NetdataServiceInstaller"
                                Name="Netdata"
                                DisplayName="Netdata Agent"
                                Description="Netdata is distributed, real-time, performance and health monitoring for systems and applications."
                                Type="ownProcess"
                                Start="auto"
                                ErrorControl="normal" />

                <ServiceControl Id="StartService"
                                Start="install"
                                Stop="both"
                                Remove="uninstall"
                                Name="Netdata"
                                Wait="yes" />
            </Component>
        -->
    </Fragment>
</Wix>
