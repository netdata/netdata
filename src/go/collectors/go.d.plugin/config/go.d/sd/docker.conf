name: 'docker'

discover:
  - discoverer: docker
    docker:
      tags: "unk"
      address: "unix:///var/run/docker.sock"

classify:
  - name: "Skip"
    selector: "unknown"
    tags: "skip"
    match:
      - tags: "skip"
        expr: |
          {{ $netNOK := eq .NetworkMode "host" -}}
          {{ $protoNOK := not (eq .PortProtocol "tcp") -}}
          {{ $portNOK := empty .PrivatePort -}}
          {{ $addrNOK := or (empty .IPAddress) (glob .PublicPortIP ":") -}}
          {{ or $netNOK $protoNOK $portNOK $addrNOK }}
  - name: "Applications"
    selector: "!skip unknown"
    tags: "-unknown app"
    match:
      - tags: "apache"
        expr: '{{ glob .Image "httpd*" "**/httpd*" }}'
      - tags: "cockroachdb"
        expr: '{{ glob .Image "**/cockroach*" }}'
      - tags: "nginx"
        expr: '{{ glob .Image "nginx*" "**/nginx*" }}'
compose:
  - name: "Applications"
    selector: "app"
    config:
      - selector: "nginx"
        template: |
          module: nginx
          name: docker_{{.Name}}
          url: http://{{.Address}}/basic_status
