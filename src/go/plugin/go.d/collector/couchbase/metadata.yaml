plugin_name: go.d.plugin
modules:
  - meta:
      id: collector-go.d.plugin-couchbase
      plugin_name: go.d.plugin
      module_name: couchbase
      monitored_instance:
        name: Couchbase
        link: https://www.couchbase.com/
        icon_filename: couchbase.svg
        categories:
          - data-collection.databases
      keywords:
        - couchbase
        - databases
      related_resources:
        integrations:
          list: []
      info_provided_to_referring_integrations:
        description: ""
      most_popular: false
    overview:
      data_collection:
        metrics_description: |
          This collector monitors Couchbase servers.
        method_description: ""
      supported_platforms:
        include: []
        exclude: []
      multi_instance: true
      additional_permissions:
        description: ""
      default_behavior:
        auto_detection:
          description: ""
        limits:
          description: ""
        performance_impact:
          description: ""
    setup:
      prerequisites:
        list: []
      configuration:
        file:
          name: go.d/couchbase.conf
        options:
          description: |
            The following options can be defined globally: update_every, autodetection_retry.
          folding:
            title: All options
            enabled: true
          list:
            - name: update_every
              description: Data collection interval (seconds).
              default_value: 5
              required: false
              group: Collection
            - name: autodetection_retry
              description: Autodetection retry interval (seconds). Set 0 to disable.
              default_value: 0
              required: false
              group: Collection

            - name: url
              description: Target endpoint URL.
              default_value: http://127.0.0.1:8091
              required: true
              group: Target
            - name: timeout
              description: HTTP request timeout (seconds).
              default_value: 1
              required: false
              group: Target

            - name: username
              description: Username for Basic HTTP authentication.
              default_value: ""
              required: false
              group: HTTP Auth
            - name: password
              description: Password for Basic HTTP authentication.
              default_value: ""
              required: false
              group: HTTP Auth
            - name: bearer_token_file
              description: "Path to a file containing a bearer token (used for `Authorization: Bearer`)."
              default_value: ""
              required: false
              group: HTTP Auth

            - name: tls_skip_verify
              description: Skip TLS certificate and hostname verification (insecure).
              default_value: no
              required: false
              group: TLS
            - name: tls_ca
              description: Path to CA bundle used to validate the server certificate.
              default_value: ""
              required: false
              group: TLS
            - name: tls_cert
              description: Path to client TLS certificate (for mTLS).
              default_value: ""
              required: false
              group: TLS
            - name: tls_key
              description: Path to client TLS private key (for mTLS).
              default_value: ""
              required: false
              group: TLS

            - name: proxy_url
              description: HTTP proxy URL.
              default_value: ""
              required: false
              group: Proxy
            - name: proxy_username
              description: Username for proxy Basic HTTP authentication.
              default_value: ""
              required: false
              group: Proxy
            - name: proxy_password
              description: Password for proxy Basic HTTP authentication.
              default_value: ""
              required: false
              group: Proxy

            - name: method
              description: HTTP method to use.
              default_value: "GET"
              required: false
              group: Request
            - name: body
              description: Request body (e.g., for POST/PUT).
              default_value: ""
              required: false
              group: Request
            - name: headers
              description: "Additional HTTP headers (one per line as key: value)."
              default_value: ""
              required: false
              group: Request
            - name: not_follow_redirects
              description: Do not follow HTTP redirects.
              default_value: no
              required: false
              group: Request
            - name: force_http2
              description: Force HTTP/2 (including h2c over TCP).
              default_value: no
              required: false
              group: Request

            - name: functions.top_queries.disabled
              description: Disable the [top-queries](#top-queries) function.
              default_value: false
              required: false
              group: Functions
            - name: functions.top_queries.timeout
              description: Query timeout (seconds). Uses collector timeout if not set.
              default_value: ""
              required: false
              group: Functions
            - name: functions.top_queries.limit
              description: Maximum number of queries to return.
              default_value: 500
              required: false
              group: Functions

            - name: vnode
              description: Associates this data collection job with a [Virtual Node](https://learn.netdata.cloud/docs/netdata-agent/configuration/organize-systems-metrics-and-alerts#virtual-nodes).
              default_value: ""
              required: false
              group: Virtual Node
        examples:
          folding:
            title: Config
            enabled: true
          list:
            - name: Basic
              description: An example configuration.
              config: |
                jobs:
                  - name: local
                    url: http://127.0.0.1:8091
            - name: Basic HTTP auth
              description: Local server with basic HTTP authentication.
              config: |
                jobs:
                  - name: local
                    url: http://127.0.0.1:8091
                    username: foo
                    password: bar
            - name: Multi-instance
              description: |
                > **Note**: When you define multiple jobs, their names must be unique.

                Collecting metrics from local and remote instances.
              config: |
                jobs:
                  - name: local
                    url: http://127.0.0.1:8091
                
                  - name: remote
                    url: http://203.0.113.0:8091
    troubleshooting:
      problems:
        list: []
    alerts: []
    functions:
      description: |
        This collector exposes real-time functions for interactive troubleshooting in the Top tab.
      list:
        - id: top-queries
          name: Top Queries
          description: |
            Retrieves completed N1QL query statistics from Couchbase [system:completed_requests](https://docs.couchbase.com/server/current/manage/monitor/monitoring-n1ql-query.html#sys-completed-req) keyspace.

            This function queries the `system:completed_requests` keyspace which stores information about recently completed N1QL requests. It provides timing metrics, result statistics, and error/warning counts for each completed query.

            Use cases:
            - Identify slow N1QL queries consuming the most elapsed time
            - Find queries with high error or warning counts
            - Analyze query patterns by user to understand workload distribution

            Statement text is truncated at 4096 characters for display purposes.
          parameters:
            - id: __sort
              name: Filter By
              description: Select the primary sort column. Options include elapsed time, service time, request time, and result count. Defaults to elapsed time to focus on slowest queries.
              type: select
              required: true
              default: elapsedTime
              options: []
          returns:
            description: Completed N1QL request statistics. Each row represents a single completed query with its timing and result metrics.
            columns:
              - name: Request ID
                type: string
                unit: ""
                visibility: hidden
                description: "Unique identifier for the N1QL request. Can be used for correlation with Couchbase logs."
              - name: Request Time
                type: timestamp
                unit: ""
                description: "Timestamp when the request was received by the query service."
              - name: Statement
                type: string
                unit: ""
                description: "The N1QL statement that was executed. Truncated to 4096 characters."
              - name: Elapsed Time
                type: duration
                unit: "milliseconds"
                description: "Total time from request receipt to response completion, including queue time, planning, execution, and result streaming."
              - name: Service Time
                type: duration
                unit: "milliseconds"
                description: "Time spent actively processing the request, excluding network latency and queue wait time. Compare with elapsed time to identify network or queueing delays."
              - name: Result Count
                type: integer
                unit: ""
                description: "Number of documents/rows returned by the query. High values may indicate queries returning excessive data."
              - name: Result Size
                type: integer
                unit: ""
                visibility: hidden
                description: "Total size of the result set in bytes. Large result sizes may indicate inefficient queries or missing projections."
              - name: Error Count
                type: integer
                unit: ""
                visibility: hidden
                description: "Number of errors encountered during query execution. Non-zero values require investigation."
              - name: Warning Count
                type: integer
                unit: ""
                visibility: hidden
                description: "Number of warnings generated during query execution. Warnings may indicate suboptimal query patterns or index usage."
              - name: User
                type: string
                unit: ""
                description: "Couchbase user who executed the query. Useful for identifying workload by user or application."
              - name: Client Context ID
                type: string
                unit: ""
                visibility: hidden
                description: "Client-provided context identifier for request tracking and correlation."
          performance: |
            Queries `system:completed_requests` via the N1QL query service:<br/>• The `completed_requests` keyspace has a configurable size limit (`completed-limit` setting)<br/>• Default limit of 500 rows balances usefulness with performance
          security: |
            Query text may contain unmasked literal values including potentially sensitive data:<br/>• Personal information in WHERE clauses or INSERT values<br/>• Business data embedded in queries<br/>• Access should be restricted to authorized personnel only
          prerequisites:
            list:
              - title: Grant access to `system:completed_requests`
                description: |
                  The user must have appropriate privileges to query system keyspaces and the N1QL service must be available.

                  1. Ensure the N1QL (Query) service is running on the cluster

                  2. Grant query system catalog privileges to the monitoring user:

                     ```sql
                     GRANT QUERY_SYSTEM_CATALOG TO netdata_user;
                     ```

                  3. Verify access to `completed_requests`:

                     ```sql
                     SELECT * FROM system:completed_requests LIMIT 1;
                     ```

                     :::info

                     - The `system:completed_requests` keyspace stores recently completed queries based on Couchbase server settings `completed-limit` and `completed-threshold`
                     - Only queries exceeding `completed-threshold` (default 1000ms) are logged to `completed_requests`
                     - Adjust `completed-threshold` in Couchbase Query Settings to capture faster queries if needed

                     :::
          availability: |
            Available when:<br/>• The collector has successfully connected to Couchbase<br/>• The N1QL (Query) service is running<br/>• Returns HTTP 503 if collector is still initializing<br/>• Returns HTTP 500 if the query fails<br/>• Returns HTTP 504 if the query times out
          require_cloud: true
    metrics:
      folding:
        title: Metrics
        enabled: false
      description: ""
      availability: []
      scopes:
        - name: global
          description: These metrics refer to the entire monitored application.
          labels: []
          metrics:
            - name: couchbase.bucket_quota_percent_used
              description: Quota Percent Used Per Bucket
              unit: percentage
              chart_type: line
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_ops_per_sec
              description: Operations Per Second Per Bucket
              unit: ops/s
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_disk_fetches
              description: Disk Fetches Per Bucket
              unit: fetches
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_item_count
              description: Item Count Per Bucket
              unit: items
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_disk_used_stats
              description: Disk Used Per Bucket
              unit: bytes
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_data_used
              description: Data Used Per Bucket
              unit: bytes
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_mem_used
              description: Memory Used Per Bucket
              unit: bytes
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
            - name: couchbase.bucket_vb_active_num_non_resident
              description: Number Of Non-Resident Items Per Bucket
              unit: items
              chart_type: stacked
              dimensions:
                - name: a dimension per bucket
