{
  "jsonSchema": {
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Kubernetes Service Discovery",
    "description": "Discovers services running in Kubernetes cluster.",
    "type": "object",
    "properties": {
      "name": {
        "title": "Name",
        "description": "Pipeline name (must be unique).",
        "type": "string",
        "minLength": 1
      },
      "discoverer": {
        "title": "Discoverer",
        "type": "object",
        "properties": {
          "k8s": {
            "title": "Kubernetes",
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "properties": {
                "role": {
                  "title": "Role",
                  "description": "Kubernetes resource role to discover.",
                  "type": "string",
                  "enum": [
                    "pod",
                    "service"
                  ],
                  "default": "pod"
                },
                "namespaces": {
                  "title": "Namespaces",
                  "description": "Namespaces to watch (empty = all namespaces).",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "selector": {
                  "title": "Selector",
                  "description": "Label and field selectors for filtering resources.",
                  "type": "object",
                  "properties": {
                    "label": {
                      "title": "Label selector",
                      "description": "Label selector (e.g., 'app=nginx').",
                      "type": "string"
                    },
                    "field": {
                      "title": "Field selector",
                      "description": "Field selector (e.g., 'metadata.name=my-pod').",
                      "type": "string"
                    }
                  }
                },
                "pod": {
                  "title": "Pod options",
                  "description": "Pod-specific options.",
                  "type": "object",
                  "properties": {
                    "local_mode": {
                      "title": "Local mode",
                      "description": "Only discover pods on the same node as the agent.",
                      "type": "boolean",
                      "default": false
                    }
                  }
                }
              },
              "required": [
                "role"
              ]
            }
          }
        },
        "required": [
          "k8s"
        ]
      },
      "services": {
        "title": "Service rules",
        "description": "- Match discovered Kubernetes resources and generate collector configurations.\n- Each rule specifies match criteria and a config template.\n- When a pod or service matches, a data collection job is created.",
        "type": "array",
        "minItems": 1,
        "items": {
          "type": "object",
          "properties": {
            "id": {
              "title": "Rule ID",
              "description": "Unique identifier for this rule. Used in logs to identify which rule matched a resource.",
              "type": "string"
            },
            "match": {
              "title": "Match expression",
              "description": "Go template expression that must evaluate to 'true' for the rule to match the discovered pod or service.",
              "type": "string"
            },
            "config_template": {
              "title": "Config template",
              "description": "**Uses the same fields as match expression**. Go template that generates the data collection job configuration in YAML format. **Must include 'module' and 'name' fields**, plus any module-specific settings.",
              "type": "string"
            }
          },
          "required": [
            "id",
            "match"
          ]
        }
      }
    },
    "required": [
      "name",
      "discoverer",
      "services"
    ]
  },
  "uiSchema": {
    "uiOptions": {
      "fullPage": true
    },
    "ui:flavour": "tabs",
    "ui:options": {
      "tabs": [
        {
          "title": "Base",
          "fields": [
            "name",
            "discoverer"
          ]
        },
        {
          "title": "Services",
          "fields": [
            "services"
          ]
        }
      ]
    },
    "discoverer": {
      "k8s": {
        "ui:listFlavour": "list",
        "items": {
          "selector": {
            "label": {
              "ui:placeholder": "app=nginx"
            },
            "field": {
              "ui:placeholder": "metadata.name=my-pod"
            }
          }
        }
      }
    },
    "services": {
      "ui:listFlavour": "list",
      "items": {
        "id": {
          "ui:placeholder": "nginx-pods",
          "ui:help": "Use descriptive names like 'nginx-pods', 'mysql-service', 'prometheus-metrics'"
        },
        "match": {
          "ui:widget": "textarea",
          "ui:placeholder": "{{ eq .Namespace \"default\" }}",
          "ui:help": "**Pod role fields:**\n| Field | Description |\n|-------|-------------|\n| `.Address` | Pod IP:Port |\n| `.Namespace` | Pod namespace |\n| `.Name` | Pod name |\n| `.Annotations` | Annotations (map) |\n| `.Labels` | Labels (map) |\n| `.NodeName` | Node name |\n| `.PodIP` | Pod IP |\n| `.ControllerName` | Controller name |\n| `.ControllerKind` | Controller kind |\n| `.ContName` | Container name |\n| `.Image` | Container image |\n| `.Env` | Env vars (map) |\n| `.Port` | Container port |\n| `.PortName` | Port name |\n| `.PortProtocol` | Port protocol |\n\n**Service role fields:**\n| Field | Description |\n|-------|-------------|\n| `.Address` | ClusterIP:Port |\n| `.Namespace` | Service namespace |\n| `.Name` | Service name |\n| `.Annotations` | Annotations (map) |\n| `.Labels` | Labels (map) |\n| `.Port` | Service port |\n| `.PortName` | Port name |\n| `.PortProtocol` | Port protocol |\n| `.ClusterIP` | Cluster IP |\n| `.ExternalName` | External name |\n\n**Functions:** eq, ne, glob, regexp, and, or, not\n\n**Map access:** {{ index .Labels \"key\" }}"
        },
        "config_template": {
          "ui:widget": "textarea",
          "ui:placeholder": "module: nginx\nname: {{.Namespace}}-{{.Name}}\nurl: http://{{.Address}}/stub_status"
        }
      }
    }
  }
}
