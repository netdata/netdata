import crypto from 'node:crypto';

import { describe, expect, it, vi } from 'vitest';

import type { MCPTool } from '../../types.js';

import { XmlToolTransport } from '../../xml-transport.js';
import { extractNonceFromMessages } from '../phase2-harness-scenarios/infrastructure/harness-helpers.js';

const MOCK_UUID = 'abcd1234-abcd-abcd-abcd-abcd12345678';

const tools: MCPTool[] = [
  { name: 'agent__final_report', description: 'final', inputSchema: { type: 'object' } },
];

describe('harness helpers', () => {
  it('extracts the XML nonce from xml-next messages generated by XmlToolTransport', () => {
    vi.spyOn(crypto, 'randomUUID').mockReturnValue(MOCK_UUID);
    const transport = new XmlToolTransport();
    const build = transport.buildMessages({
      turn: 1,
      maxTurns: 3,
      tools,
      maxToolCallsPerTurn: 1,
      taskStatusToolEnabled: false,
      finalReportToolName: 'agent__final_report',
      resolvedFormat: 'markdown',
      expectedJsonSchema: undefined,
      attempt: 1,
      maxRetries: 3,
      contextPercentUsed: 5,
    });

    const extracted = extractNonceFromMessages([build.nextMessage], 'unit-harness-nonce');
    expect(extracted).toBe(build.nonce);
  });
});
