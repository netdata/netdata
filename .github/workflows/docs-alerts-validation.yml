name: Validate Alert Documentation

on:
  push:
    paths:
      - "docs/alerts/**/*.md"
  pull_request:
    paths:
      - "docs/alerts/**/*.md"

jobs:
  validate-alerts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build stock alert list from source
        run: |
          find src/health/health.d -name "*.conf" -exec grep -hE "^\s*(template|alarm):" {} \; 2>/dev/null | \
            sed -E 's/^[[:space:]]*(template|alarm):[[:space:]]+//' | sort | uniq > /tmp/stock_alerts.txt
          echo "STOCK_COUNT=$(wc -l < /tmp/stock_alerts.txt)" >> $GITHUB_ENV

      - name: Find alerts in docs
        run: |
          find docs/alerts -name "*.md" -exec grep -hoE "^\s*(template|alarm):[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]+" {} \; 2>/dev/null | \
            sed 's/.*://' | sed 's/^[[:space:]]*//' | sort | uniq > /tmp/docs_alerts.txt
          echo "DOCS_COUNT=$(wc -l < /tmp/docs_alerts.txt)" >> $GITHUB_ENV

      - name: Validate each doc alert
        id: validate
        run: |
          FAILED=0
          INVALID=""
          while IFS= read -r alert; do
            if ! grep -qxF "$alert" /tmp/stock_alerts.txt 2>/dev/null; then
              echo "::error title=Non-stock alert::$alert"
              FAILED=1
              INVALID="$INVALID\n$alert"
            fi
          done < /tmp/docs_alerts.txt

          if [ $FAILED -eq 0 ]; then
            echo "✅ All ${{ env.DOCS_COUNT }} alert examples use real stock alerts"
            cat /tmp/docs_alerts.txt
          else
            echo "❌ Found non-stock alerts in docs$INVALID"
            exit 1
          fi