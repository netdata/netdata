# VM Templates and Clones

When creating VM templates or cloning VMs, you need to reset the node identity so each clone gets a unique identity in Netdata Cloud.

## Two Types of Identity

Netdata uses two separate identities:

### Machine GUID (Node Identity)

The **machine GUID** is the unique identifier for this specific node. It is used by Netdata Cloud and Parents to uniquely identify this node.

- Generated once on the first start of Netdata
- Stored in `/var/lib/netdata/registry/netdata.public.unique.id` (primary)
- Backed up in `/var/lib/netdata/status-netdata.json` (last status file)
- Backed up in `/var/lib/netdata/cloud.d/cloud.conf` (Netdata Cloud authentication)
- Never changes

### Claimed ID (ACLK Authentication)

The **claimed ID** is used for authenticating the Agent-Cloud Link (ACLK). It is separate from the node identity and can be regenerated without affecting the node's identity in Cloud.

- Created when claiming completes
- Stored in `/var/lib/netdata/cloud.d/claimed_id` and `/var/lib/netdata/cloud.d/cloud.conf`
- Can be regenerated by removing cloud.d directory, provided that there is claiming information in `/etc/netdata/claim.conf`
- Does not affect node identity

The kickstart script automatically creates `/etc/netdata/claim.conf` if called with claiming information (e.g. when the kickstart command is copied from Netdata Cloud).
`/etc/netdata/claim.conf` ensures that Netdata Agents and Parents know to which Netdata Cloud they belong and how to authenticate.

## Preparing a Template

To ensure each cloned VM gets a unique identity:

```bash
# Stop Netdata
sudo systemctl stop netdata

# Remove the machine GUID file
sudo rm -f /var/lib/netdata/registry/netdata.public.unique.id

# Remove the last status files
sudo rm -f /var/lib/netdata/status-netdata.json
sudo rm -f /tmp/status-netdata.json
sudo rm -f /run/status-netdata.json
sudo rm -f /var/run/status-netdata.json

# Remove Netdata Cloud (ACLK authentication)
sudo rm -rf /var/lib/netdata/cloud.d/

# DO NOT remove /etc/netdata/claim.conf - it is used for re-connecting to Netdata Cloud under the new identity
# DO NOT start Netdata - the template should have no identity stored for its clones to create new identities
```

After this, convert the VM to a template.

## Cloning from Template

When you clone a VM from the template:

1. First boot â†’ Netdata generates a new unique machine GUID
2. Auto-claims to Cloud (if `/etc/netdata/claim.conf` exists)
3. Node appears in Netdata Cloud with unique identity

## Troubleshooting Cloned VMs

If cloned VMs share the same identity in Cloud:

- The template still had a machine GUID stored
- You must reset the GUID before templating (steps above)
- Each clone must start fresh to generate its own GUID

## FAQ

### Proxmox

**Q: How do I prepare a template in Proxmox?**

A: Install Netdata on a VM, run the reset commands from "Preparing a Template" above, then right-click the VM and select "Convert to Template".

**Q: Can I use cloud-init with Netdata templates?**

A: Yes. Cloud-init runs before the first boot, and Netdata generates a new machine GUID on first boot. The cloud-init configuration is preserved in the template.

### Vagrant

**Q: How to create a Vagrant box with Netdata?**

A: Install Netdata on the base VM, run the reset commands, then run `vagrant package --output my-box.box`. Users who run `vagrant up` will get a unique identity on first boot.

### libvirt/KVM

**Q: How to clone a KVM VM with Netdata?**

A: Use `virt-sysprep` to reset the machine GUID:

```bash
virt-sysprep -a myvm.qcow2 --delete /var/lib/netdata/registry/netdata.public.unique.id --delete /var/lib/netdata/status-netdata.json --delete /var/lib/netdata/cloud.d/
```

Alternatively, clone the VM normally and run the reset commands manually.

### Cloud Images (AWS, Azure, GCP)

**Q: How to create a custom AMI with Netdata?**

A: Launch an instance, install Netdata, run the reset commands, create an AMI from the instance. Users who launch instances from your AMI will get unique identities on first boot.

### Terraform

**Q: How to provision VMs with Netdata using Terraform?**

A: Use cloud-init to install Netdata on first boot:

```yaml
# cloud-init config
runcmd:
  - curl https://get.netdata.io/kickstart.sh -- --claim-token TOKEN --claim-rooms ROOM_ID | sh
```

Netdata will generate a unique GUID and auto-claim on first boot.

### Containers

**Q: Do I need to reset identity for containers?**

A: No. Containers get a unique machine GUID on first start automatically. Each new container instance has its own identity.

### General

**Q: What happens if I reboot a cloned VM?**

A: The machine GUID stays the same. Netdata does not regenerate the GUID on reboot, so the node keeps its identity and claiming status.

**Q: Can I use the same claim token for multiple clones?**

A: Yes. Each clone gets a unique machine GUID but can use the same claim token. They will appear as separate nodes in Netdata Cloud.

**Q: What happens if two VMs share the same machine GUID?**

A: Both VMs will have the same identity in Netdata Cloud and cannot connect concurrently:

1. **Parent connections**: Only one VM can stream to a Parent at a time. The second VM will fail to connect.
2. **Cloud connections**: The second VM will kick the first VM out of the connection. The cloud detects the duplicate and generates a heuristic update to sanitize the state, effectively disconnecting the old client.

This causes unstable connections and duplicate node entries in Cloud. Always reset the machine GUID before templating.
