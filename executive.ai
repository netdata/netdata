#!/usr/bin/env ai-agent
---
description: |
  Bbusiness analytics, revenue, churn, subscriptions, products, ARR, MRR, growth, trends
usage: |
  business data query
models:
  - anthropic/claude-sonnet-4-20250514
#  - anthropic/claude-3-haiku-20240307
#  - openrouter/deepseek/deepseek-chat-v3.1
#  - openrouter/openai/gpt-oss-120b
#  - openrouter/openai/gpt-oss-20b
#  - openai/gpt-5
tools:
  - bigquery
  - batch
llmTimeout: 120000
toolTimeout: 60000
toolResponseMaxBytes: 15000
maxConcurrentTools: 2
temperature: 0.7
topP: 1
maxOutputTokens: 16384
repeatPenalty: 1.1
maxRetries: 5
maxToolTurns: 50
parallelToolCalls: true
---
Your Mission: provide business intelligence.

${include:tone-and-language.md}

Output Format: ${FORMAT}
Current Date and Time: ${DATETIME}, ${DAY}

Tools at Hand:
- execute_sql: Run SQL queries on production data
- list_dataset_ids: See available datasets
- list_table_ids: List tables in a dataset
- get_dataset_info / get_table_info: Schema metadata

## Grafana Dashboard BigQuery Queries (auto-generated)

Source file: Netdata Executive Dashboard-1757119976379.json
Extracted at: 2025-09-06T01:02:10.833Z

### $ Realized ARR - Forecasts (panel 7)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: .
- Tables: netdata-analytics-bi.watch_towers.new_arr_forecast, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: ARR actuals vs forecast

```sql
WITH main_timeseries AS (
  Select
    d.date,
    ARR_TARGET,
    
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      DATE as date,
      ARR_TARGET,
    FROM
      `netdata-analytics-bi.watch_towers.new_arr_forecast`

  ) a ON d.date = timestamp(a.DATE)
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "ai_credits_space_revenue"),
                metric_value,
                NULL
              )
            ),
            0
          )
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
  ) b on d.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.ARR_TARGET,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `REALIZED_ARR`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  ARR_TARGET,
  
FROM
  combined
WHERE
  date is not null
ORDER BY
  date;
```

### Realized ARR $ (panel 195)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: .
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, business_arr_discount, homelab_arr_discount, ai_credits_space_revenue from netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    business_arr_discount,
    homelab_arr_discount,
    ai_credits_space_revenue
  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as date,
            MAX(
              IF(
                (metric_name = "arr_business_discount"),
                metric_value,
                NULL
              )
            ) as business_arr_discount,
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ) as homelab_arr_discount,
            MAX(
              IF(
                (metric_name = "ai_credits_space_revenue"),
                metric_value,
                NULL
              )
            ) as ai_credits_space_revenue
            

          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28")
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on d.date = b.date
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.business_arr_discount,
    m.homelab_arr_discount,
    m.ai_credits_space_revenue,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date = s.date
)
SELECT
  date,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) AS on_prem,
  business_arr_discount as business,
  homelab_arr_discount as homelab,
  ai_credits_space_revenue as `AI Bundles`,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + business_arr_discount + homelab_arr_discount as total,
FROM
  combined
WHERE
  date is not null
  and date(date) < CURRENT_DATE()
ORDER BY
  date;
```

### Realized ARR % (panel 196)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: .
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, business_arr_discount, homelab_arr_discount, ai_credits_space_revenue from netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    business_arr_discount,
    homelab_arr_discount,
    ai_credits_space_revenue
  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as date,
            MAX(
              IF(
                (metric_name = "arr_business_discount"),
                metric_value,
                NULL
              )
            ) as business_arr_discount,
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ) as homelab_arr_discount,
            MAX(
              IF(
                (metric_name = "ai_credits_space_revenue"),
                metric_value,
                NULL
              )
            ) as ai_credits_space_revenue
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28")
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on d.date = b.date
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.business_arr_discount,
    m.homelab_arr_discount,
    m.ai_credits_space_revenue,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date = s.date
),
pre as (SELECT
  date,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) AS on_prem,
  business_arr_discount as business,
  homelab_arr_discount as homelab,
  ai_credits_space_revenue as `AI Bundles`,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + business_arr_discount + homelab_arr_discount as total,
FROM
  combined
WHERE
  date is not null
  and date(date) < CURRENT_DATE()
ORDER BY
  date)

SELECT 
  date,
  (on_prem / total) * 100 as on_prem,
  (business / total) * 100 as business,
  (homelab / total ) * 100 as homelab,
  (`AI Bundles` / total) * 100 as `AI Bundles`
from pre
```

### Trials total (panel 91)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "trials_total"), metric_value, NULL)) AS `trials_tota from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "trials_total"), metric_value, NULL)) AS `trials_total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### Trial metrics (panel 197)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, -- MAX(IF((metric_name = "spaces_active_members_sum"), metric_value, NULL)) from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  -- MAX(IF((metric_name = "spaces_active_members_sum"), metric_value, NULL)) AS `member sum`,
  MAX(IF((metric_name = "trial_6_or_more_nodes_reachable_sum"), metric_value, NULL)) * 2 * 12 AS `6+ nodes Est Value`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### Total ARR + Unrealized ARR (panel 51)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Business+OnPrem+Homelab

```sql
WITH main_timeseries AS (
  Select
    d.date,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "business_45d_monthly_newcomer_arr"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "homelab_45d_monthly_newcomer_arr"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "ai_credits_space_revenue"),
                metric_value,
                NULL
              )
            ),
            0
          )
          
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    -- UNION
    -- ALL
    -- select
    --   timestamp(date(_partitiontime)) as date,
    --   12 * sum(
    --     if(
    --       has_subscription_business = 1,
    --       subscription_mrr_estimated,
    --       0
    --     )
    --   ) as `total ARR`,
    --   -- null AS `monthly subs ARR`,
    --   -- null AS `annual subs ARR`,
    --   0 AS `total ARR discounted`
    -- from
    --   `netdata-analytics-bi.data360.space360_daily`
    -- where
    --   -- date(_partitiontime) >= date('${__from:date}')and 
    --   date(_partitiontime) <= date('2023-11-28')
    --   and (
    --     has_subscription = 1
    --     and subscription_trial_ends_at IS NULL
    --   )
    -- group by
    --   1

  ) b on d.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR discounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
--   `Target_ARR__2_8M__`,
--   `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date;
```

### Unrealized ARR (panel 192)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Monthly subscribers that haven't yet paid (estimate)

```sql
SELECT 
  date,
  run_date,
  Business,
  Homelab
FROM
  (SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF((metric_name = "business_45d_monthly_newcomer_arr"), metric_value, NULL)) AS Business,
    MAX(IF((metric_name = "homelab_45d_monthly_newcomer_arr"), metric_value, NULL)) AS Homelab
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') - 1
  GROUP BY
    run_date
  ORDER BY
    run_date ASC
)
ORDER BY
  run_date ASC
```

### Unrealized ARR (panel 208)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: UNKNOWN
- Interpretation: Monthly subscribers that haven't yet paid (estimate)

```sql
DECLARE table_name STRING DEFAULT (
  'netdata-analytics-bi.watch_towers.spaces_asat_' || FORMAT_DATE('%Y%m%d', DATE('${__to:date}')-1)
);

EXECUTE IMMEDIATE '''
  SELECT 
    sum(bq_arr_discount) as `to-be-realized`,
    timestamp(cx_arr_realized_at)
  FROM ''' || table_name || '''
  WHERE
    ax_trial_ends_at IS NULL 
    AND ce_plan_class = "Business_45d_monthly_newcomer" 
    AND bq_arr_discount > 0
  group by cx_arr_realized_at
  ORDER BY 
    cx_arr_realized_at
''';
```

### $ Realized ARR  (panel 191)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Business+OnPrem+Homelab

```sql
WITH main_timeseries AS (
  Select
    d.date,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "ai_credits_space_revenue"),
                metric_value,
                NULL
              )
            ),
            0
          )
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR discounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on d.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    -- m.`Target_ARR__2_8M__`,
    -- m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ` `,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `  `,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
--   `Target_ARR__2_8M__`,
--   `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date;
```

### (untitled panel) (panel 137)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, `total ARR discounted`, from netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "ai_credits_space_revenue"),
                metric_value,
                NULL
              )
            ),
            0
          )
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR discounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on d.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    -- m.`Target_ARR__2_8M__`,
    -- m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
),

final as (
  select 
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR discounted`,  
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
--   `Target_ARR__2_8M__`,
--   `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date)

SELECT 
  date,
 -- `total ARR discounted`,
  (`total ARR discounted` - LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`total ARR discounted` - LAG(`total ARR discounted`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`total ARR discounted` - LAG(`total ARR discounted`, 90) OVER (ORDER BY date)) AS last_90_days,
  from final
WHERE
  date is not null
ORDER BY
  date;
```

### Ending Trial Spaces (panel 209)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: UNKNOWN
- Interpretation: Sum of reachable nodes from trial spaces, grouped by expiration date

```sql
DECLARE table_name STRING DEFAULT (
  'netdata-analytics-bi.watch_towers.spaces_asat_' || FORMAT_DATE('%Y%m%d', DATE('${__to:date}')-1)
);

EXECUTE IMMEDIATE '''
  SELECT 
    sum(ae_reachable_nodes) as `reachable_nodes_sum`,
    date(ax_trial_ends_at) as ax_trial_ends_at
  FROM ''' || table_name || '''
  WHERE
    ax_trial_ends_at IS NOT NULL 
  group by date(ax_trial_ends_at)
  ORDER BY 
    ax_trial_ends_at
''';
```

### New Business Subscriptions (panel 92)
- Type: state-timeline
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT
  timestamp(date(run_date)) AS date,
  MAX(IF((metric_name = "new_subs" OR metric_name = "new_business_subs"), metric_value, NULL)) AS `-`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') 
  AND run_date >= DATE('${__from:date}') 
  AND run_date < CURRENT_DATE()
GROUP BY
  date
```

### Churned Business Subscriptions (panel 193)
- Type: state-timeline
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, #run_date, MAX(IF((metric_name = "churn_subs" or metric_name = "churn_business_subs") from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  #run_date,
  MAX(IF((metric_name = "churn_subs" or metric_name = "churn_business_subs"), metric_value, NULL)) AS `-`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  date
```

### AI Bundle metrics (panel 215)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: .
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = 'Bundle625.00'), metric_value, NULL)) AS `Bundle625`, from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = 'Bundle625.00'), metric_value, NULL)) AS `Bundle625`,
  MAX(IF((metric_name = 'Bundle300.00'), metric_value, NULL)) AS `Bundle300`,
  MAX(IF((metric_name = 'Bundle1100.00'), metric_value, NULL)) AS `Bundle1100`,
  MAX(IF((metric_name = 'Bundle2000.00'), metric_value, NULL)) AS `Bundle2000`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### Spaces with AI Credits (panel 216)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: .
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = 'ai_credits_space_count'), metric_value, NULL)) AS `s from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = 'ai_credits_space_count'), metric_value, NULL)) AS `spaces`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### Business Subscriptions (panel 50)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT 
  date,
  run_date,
  `cloud_subscriptions`,
 -- (`cloud_subscriptions` - LAG(`cloud_subscriptions`, 7) OVER (ORDER BY date)) AS change_over_7_days,
 -- (`cloud_subscriptions` - LAG(`cloud_subscriptions`, 30) OVER (ORDER BY date)) AS change_over_30_days,
 -- (`cloud_subscriptions` - LAG(`cloud_subscriptions`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF((metric_name = "subscriptions_total" or metric_name = "total_business_subscriptions"), metric_value, NULL)) AS `cloud_subscriptions` 
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') - 1
  GROUP BY
    run_date
  ORDER BY
    run_date ASC
)
ORDER BY
  run_date ASC
```

### Business ARR  (panel 56)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date, run_date, `discounted_arr`, -- (`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS change_over_7 from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  date,
  run_date,
  `discounted_arr`,
 -- (`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS change_over_7_days,
 -- (`discounted_arr` - LAG(`discounted_arr`, 30) OVER (ORDER BY date)) AS change_over_30_days,
 -- (`discounted_arr` - LAG(`discounted_arr`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (
  SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL)) AS `discounted_arr`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') - 1 and run_date > DATE("2023-11-28")
  GROUP BY
      run_date
  ORDER BY
      run_date ASC
)
ORDER BY
  run_date ASC
```

### Business Nodes (panel 55)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Paid Nodes  (annual+monthly)

```sql
SELECT 
  date,
  run_date,
  `total`,
 -- (`total` - LAG(`total`, 7) OVER (ORDER BY date)) AS change_over_7_days,
 -- (`total` - LAG(`total`, 30) OVER (ORDER BY date)) AS change_over_30_days,
 -- (`total` - LAG(`total`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (
  SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)) as `total`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') -1
  GROUP BY
    run_date
  ORDER BY 
    run_date ASC
)
ORDER BY
  run_date ASC
```

### Windows Reachable Nodes (panel 205)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "windows_reachable_nodes"), metric_value, NULL)) AS ` from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "windows_reachable_nodes"), metric_value, NULL)) AS `WindowsNodes`,
  FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### SaaS Spaces (panel 198)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: UNKNOWN
- Interpretation: nodes are reachable nodes

```sql
select 
Business,
`Business_<45d`,
Homelab,
`Homelab_<45d`,
Trials_0_nodes,
`Trials_1-5_nodes`,
`Trials_6+_nodes`,
Community_0_nodes,
Community_w_nodes,
Total,
-- if(CAST(calculated_total / total * 100 AS INT) = 100 ,0,999999) as check,
  from (
  SELECT 
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", 1, 0)) as Business,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", 1, 0)) as `Business_<45d`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", 1, 0)) as Homelab,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", 1, 0)) as `Homelab_<45d`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) as Trials_0_nodes,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , 1, 0)) as `Trials_1-5_nodes`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, 1, 0)) as `Trials_6+_nodes`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) as Community_0_nodes,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, 1, 0)) as Community_w_nodes,

    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", 1, 0)) as calculated_total,

    count(*) as total

FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX =  FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  )
```

### SaaS Spaces Total view (panel 200)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: UNKNOWN
- Interpretation: nodes are reachable nodes

```sql
select 
Business / total * 100 as Business,
`Business_<45d` / total * 100 as `Business_<45d`,
Homelab / total * 100 as Homelab,
`Homelab_<45d` / total * 100 as `Homelab_<45d`,
Trials_0_nodes / total * 100 as Trials_0_nodes,
`Trials_1-5_nodes` / total * 100 as `Trials_1-5_nodes`,
`Trials_6+_nodes` / total * 100 as `Trials_6+_nodes`,
Community_0_nodes / total * 100 as Community_0_nodes,
Community_w_nodes / total * 100 as Community_w_nodes,
if(CAST(calculated_total / total * 100 AS INT) = 100 ,0,999999) as check,
  from (
  SELECT 
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", 1, 0)) as Business,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", 1, 0)) as `Business_<45d`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", 1, 0)) as Homelab,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", 1, 0)) as `Homelab_<45d`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) as Trials_0_nodes,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , 1, 0)) as `Trials_1-5_nodes`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, 1, 0)) as `Trials_6+_nodes`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) as Community_0_nodes,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, 1, 0)) as Community_w_nodes,

    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", 1, 0)) as calculated_total,

    count(*) as total

FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX =  FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  )
```

### Nodes Total View (panel 203)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: UNKNOWN
- Interpretation: nodes are reachable nodes

```sql
select 

Business / total * 100 as Business,
`Business_<45d` / total * 100 as `Business_<45d`,
Homelab / total * 100 as Homelab,
`Homelab_<45d` / total * 100 as `Homelab_<45d`,
`Trials_1-5_nodes` / total * 100 as `Trials_1-5_nodes`,
`Trials_6+_nodes` / total * 100 as `Trials_6+_nodes`,
Community_w_nodes / total * 100 as Community_w_nodes,
if(CAST(calculated_total / total * 100 AS INT) = 100 ,0,999999) as check,



  from (
  SELECT 
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", ae_reachable_nodes, 0)) as Business,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", ae_reachable_nodes, 0)) as `Business_<45d`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", ae_reachable_nodes, 0)) as Homelab,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", ae_reachable_nodes, 0)) as `Homelab_<45d`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) as Trials_0_nodes,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , ae_reachable_nodes, 0)) as `Trials_1-5_nodes`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, ae_reachable_nodes, 0)) as `Trials_6+_nodes`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) as Community_0_nodes,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, ae_reachable_nodes, 0)) as Community_w_nodes,

    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", ae_reachable_nodes, 0)) as calculated_total,

    sum(ae_reachable_nodes) as total

FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX =  FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  )
```

### (untitled panel) (panel 139)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT 
  date,
  run_date,
 -- `cloud_subscriptions`,
  (`cloud_subscriptions` - LAG(`cloud_subscriptions`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`cloud_subscriptions` - LAG(`cloud_subscriptions`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`cloud_subscriptions` - LAG(`cloud_subscriptions`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF((metric_name = "subscriptions_total" or metric_name = "total_business_subscriptions"), metric_value, NULL)) AS `cloud_subscriptions` 
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') - 1
  GROUP BY
    run_date
  ORDER BY
    run_date ASC
)
ORDER BY
  run_date ASC
```

### (untitled panel) (panel 141)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date, run_date, -- `discounted_arr`, (`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS last_7_days,  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  date,
  run_date,
 -- `discounted_arr`,
  (`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`discounted_arr` - LAG(`discounted_arr`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`discounted_arr` - LAG(`discounted_arr`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (
  SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL)) AS `discounted_arr`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') - 1 and run_date > DATE("2023-11-28")
  GROUP BY
      run_date
  ORDER BY
      run_date ASC
)
ORDER BY
  run_date ASC
```

### (untitled panel) (panel 142)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Paid Nodes

```sql
SELECT 
  date,
  run_date,
--  `total`,
  (`total` - LAG(`total`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`total` - LAG(`total`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`total` - LAG(`total`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (
  SELECT
    timestamp(date(run_date)) as date,
    run_date,
    MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)) as `total`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') -1
  GROUP BY
    run_date
  ORDER BY 
    run_date ASC
)
ORDER BY
  run_date ASC
```

### Homelab Subscriptions (panel 124)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT 
  date,
  run_date,
  `homelab_subs`,
  --(`homelab_subs` - LAG(`homelab_subs`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  --(`homelab_subs` - LAG(`homelab_subs`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  --(`homelab_subs` - LAG(`homelab_subs`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)) AS `homelab_subs` 
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') -1
GROUP BY
  run_date
ORDER BY
  run_date ASC
)
ORDER BY
  run_date
```

### Homelab ARR (panel 125)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date, run_date, `discounted_arr`, --(`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS change_over_7_ from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  date,
  run_date,
  `discounted_arr`,
  --(`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  --(`discounted_arr` - LAG(`discounted_arr`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  --(`discounted_arr` - LAG(`discounted_arr`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (SELECT
        timestamp(date(run_date)) as date,
        run_date,
        MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL)) AS `discounted_arr`
    FROM
        `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
        run_date <= DATE('${__to:date}') -1
    GROUP BY
        run_date
    ORDER BY
        run_date ASC
)
ORDER BY
  run_date
```

### Homelab nodes (panel 127)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Paid Nodes

```sql
SELECT 
  date,
  run_date,
  `total`,
  --(`total` - LAG(`total`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  --(`total` - LAG(`total`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  --(`total` - LAG(`total`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) as `total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') -1 and run_date >= date('${__from:date}')
GROUP BY
  run_date
ORDER BY 
  run_date
)
ORDER BY
  run_date
```

### Nodes (panel 204)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: UNKNOWN
- Interpretation: nodes are reachable nodes

```sql
select 

Business,
`Business_<45d`,
Homelab,
`Homelab_<45d`,
`Trials_1-5_nodes`,
`Trials_6+_nodes`,
Community_w_nodes,
Total,
-- if(CAST(calculated_total / total * 100 AS INT) = 100 ,0,999999) as check,



  from (
  SELECT 
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", ae_reachable_nodes, 0)) as Business,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", ae_reachable_nodes, 0)) as `Business_<45d`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", ae_reachable_nodes, 0)) as Homelab,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", ae_reachable_nodes, 0)) as `Homelab_<45d`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) as Trials_0_nodes,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , ae_reachable_nodes, 0)) as `Trials_1-5_nodes`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, ae_reachable_nodes, 0)) as `Trials_6+_nodes`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) as Community_0_nodes,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, ae_reachable_nodes, 0)) as Community_w_nodes,

    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", ae_reachable_nodes, 0)) as calculated_total,

    sum(ae_reachable_nodes) as total

FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX =  FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  )
```

### Windows Reachable Nodes (panel 210)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "windows_reachable_nodes_business"), metric_value, NU from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "windows_reachable_nodes_business"), metric_value, NULL)) AS `Business`,
  MAX(IF((metric_name = "windows_reachable_nodes_trial"), metric_value, NULL)) AS `Trial`,
  MAX(IF((metric_name = "windows_reachable_nodes_community"), metric_value, NULL)) AS `Community`,
  MAX(IF((metric_name = "windows_reachable_nodes_homelab"), metric_value, NULL)) AS `Homelab`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### (untitled panel) (panel 140)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT 
  date,
  run_date,
 -- `homelab_subs`,
  (`homelab_subs` - LAG(`homelab_subs`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`homelab_subs` - LAG(`homelab_subs`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`homelab_subs` - LAG(`homelab_subs`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)) AS `homelab_subs` 
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') -1
GROUP BY
  run_date
ORDER BY
  run_date ASC
)
ORDER BY
  run_date ASC
```

### (untitled panel) (panel 143)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date, run_date, -- `discounted_arr`, (`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS last_7_days,  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  date,
  run_date,
 -- `discounted_arr`,
  (`discounted_arr` - LAG(`discounted_arr`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`discounted_arr` - LAG(`discounted_arr`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`discounted_arr` - LAG(`discounted_arr`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (SELECT
        timestamp(date(run_date)) as date,
        run_date,
        MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL)) AS `discounted_arr`
    FROM
        `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
        run_date <= DATE('${__to:date}') -1
    GROUP BY
        run_date
    ORDER BY
        run_date ASC
)
ORDER BY
  run_date ASC
```

### (untitled panel) (panel 144)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Paid Nodes

```sql
SELECT 
  date,
  run_date,
 -- `total`,
  (`total` - LAG(`total`, 7) OVER (ORDER BY date)) AS last_7_days,
  (`total` - LAG(`total`, 30) OVER (ORDER BY date)) AS last_30_days,
  (`total` - LAG(`total`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) as `total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
    run_date <= DATE('${__to:date}') -1
GROUP BY
  run_date
ORDER BY 
  run_date
)
ORDER BY
  run_date ASC
```

### SaaS Spaces Drill-down (panel 199)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: UNKNOWN
- Interpretation: nodes are reachable nodes

```sql
select 
Business / total * 100 as Business,
`Business_<45d` / total * 100 as `Business_<45d`,
Homelab / total * 100 as Homelab,
`Homelab_<45d` / total * 100 as `Homelab_<45d`,
Trials_0_nodes / total * 100 as Trials_0_nodes,
`Trials_1-5_nodes` / total * 100 as `Trials_1-5_nodes`,
`Trials_6+_nodes` / total * 100 as `Trials_6+_nodes`,
Community_0_nodes / total * 100 as Community_0_nodes,
Community_w_nodes / total * 100 as Community_w_nodes,
if(CAST(calculated_total / total * 100 AS INT) = 100 ,0,999999) as check,
  from (
  SELECT 
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", 1, 0)) as Business,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", 1, 0)) as `Business_<45d`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", 1, 0)) as Homelab,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", 1, 0)) as `Homelab_<45d`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) as Trials_0_nodes,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , 1, 0)) as `Trials_1-5_nodes`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, 1, 0)) as `Trials_6+_nodes`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) as Community_0_nodes,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, 1, 0)) as Community_w_nodes,

    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , 1, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", 1, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", 1, 0)) as calculated_total,

    count(*) as total

FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX =  FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  )
```

### Nodes Drill-Down (panel 202)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: _
- Tables: UNKNOWN
- Interpretation: nodes are reachable nodes

```sql
select 

Business / total * 100 as Business,
`Business_<45d` / total * 100 as `Business_<45d`,
Homelab / total * 100 as Homelab,
`Homelab_<45d` / total * 100 as `Homelab_<45d`,
`Trials_1-5_nodes` / total * 100 as `Trials_1-5_nodes`,
`Trials_6+_nodes` / total * 100 as `Trials_6+_nodes`,
Community_w_nodes / total * 100 as Community_w_nodes,
if(CAST(calculated_total / total * 100 AS INT) = 100 ,0,999999) as check,



  from (
  SELECT 
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", ae_reachable_nodes, 0)) as Business,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", ae_reachable_nodes, 0)) as `Business_<45d`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", ae_reachable_nodes, 0)) as Homelab,
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", ae_reachable_nodes, 0)) as `Homelab_<45d`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) as Trials_0_nodes,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , ae_reachable_nodes, 0)) as `Trials_1-5_nodes`,
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, ae_reachable_nodes, 0)) as `Trials_6+_nodes`,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) as Community_0_nodes,
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, ae_reachable_nodes, 0)) as Community_w_nodes,

    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Business", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Homelab", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 1 and COALESCE(ae_reachable_nodes,0) <= 5 , ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is not null and COALESCE(ae_reachable_nodes,0) >= 6, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) < 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class = "Community" and COALESCE(ae_reachable_nodes,0) >= 1, ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Business_%", ae_reachable_nodes, 0)) +
    sum(IF(ax_trial_ends_at is null and ce_plan_class LIKE "Homelab_%", ae_reachable_nodes, 0)) as calculated_total,

    sum(ae_reachable_nodes) as total

FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX =  FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  )
```

### On Prem & Support Subscriptions (panel 129)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: UNKNOWN
- Interpretation: On Prem & Agent Support Subscriptions

```sql
SELECT 5 as onprem

-- SELECT COUNT(*) FROM netdata-analytics-bi.watch_towers.manual_360_bq WHERE customer IS NOT NULL;
```

### On Prem ARR  (panel 57)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes (SELECT SUM(annual_price) from netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
SELECT 
  (SELECT SUM(annual_price) 
   FROM `netdata-analytics-bi.watch_towers.manual_360_bq` LIMIT 500) 
  AS total_onprem_arr
```

### On Prem Nodes (panel 130)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: UNKNOWN
- Interpretation: Paid Nodes

```sql
--SELECT 2 as onprem

SELECT SUM(current_node_count) AS total_current_node_count FROM netdata-analytics-bi.watch_towers.manual_360_bq WHERE customer IS NOT NULL;
```

### (untitled panel) (panel 156)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT 
--  date,
--  run_date,
 -- `homelab_subs`,
  2 AS onprem,
  4 AS support,
  1 AS services,
  

--FROM
--  (SELECT
--  timestamp(date(run_date)) as date,
--  run_date,
--  MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)) AS `homelab_subs` 
--FROM
--  `netdata-analytics-bi.metrics.metrics_daily`
--WHERE
--  run_date <= DATE('${__to:date}') -1
--GROUP BY
--  run_date
--ORDER BY
--  run_date ASC
--)
--ORDER BY
--  run_date ASC
```

### (untitled panel) (panel 157)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes 43680 AS licenses, 33300 AS support, 18900 AS services, /*FROM (SELECT timestamp(date(run_date)) as date, run_date, MAX( from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  43680 AS licenses,
  33300 AS support,
  18900 AS services,
  

/*FROM
  (SELECT
        timestamp(date(run_date)) as date,
        run_date,
        MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL)) AS `discounted_arr`
    FROM
        `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
        run_date <= DATE('${__to:date}') -1
    GROUP BY
        run_date
    ORDER BY
        run_date ASC
)
ORDER BY
  run_date ASC
*/
```

### (untitled panel) (panel 158)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Paid Nodes

```sql
SELECT 
  date,
  run_date,
 -- `total`,
  0 AS last_7_days,
  0 AS last_30_days,
  0 AS last_90_days,
  

FROM
  (
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) as `total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
    run_date <= DATE('${__to:date}') -1
GROUP BY
  run_date
ORDER BY 
  run_date
)
ORDER BY
  run_date ASC
```

### Monthly % growth ARR discounted (panel 190)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes d.date, `Target_ARR__2_8M__`, `Target_ARR__1M__`, `total ARR discounted`, from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR discounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
),
final_table as(
SELECT
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR discounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
  ),

daily_data as (select date, `total ARR discounted` as arr from final_table order by date),

monthly_aggregation AS (
  -- Get the last ARR value of each month
  SELECT
    EXTRACT(YEAR FROM date) AS year,
    EXTRACT(MONTH FROM date) AS month,
    DATE(EXTRACT(YEAR FROM date) || '-' || EXTRACT(MONTH FROM date) || '-01') AS date,  -- Ensure it's a DATE
    ARRAY_AGG(arr ORDER BY date DESC LIMIT 1)[OFFSET(0)] AS total_arr  -- Take the last ARR value for the month
  FROM 
    daily_data
  GROUP BY 
    year, month, date
),
arr_growth AS (
  -- Calculate month-over-month ARR growth
  SELECT
    year,
    month,
    date,
    total_arr,
    LAG(total_arr) OVER (ORDER BY year, month) AS previous_arr
  FROM 
    monthly_aggregation
)
SELECT
  -- year,
  -- month,
  timestamp(date),  -- Total ARR for the last day of the month
  -- total_arr,  -- ARR at the end of the month
  -- previous_arr,  -- ARR of the previous month
  SAFE_DIVIDE(total_arr - previous_arr, previous_arr) * 100 AS `growth percentage`  -- MoM growth
FROM
  arr_growth
WHERE date <= CURRENT_DATE and date >= date("2024-02-01") and SAFE_DIVIDE(total_arr - previous_arr, previous_arr) * 100 IS NOT NULL
ORDER BY 
  date;
```

### % Direct vs Indirect ARR (panel 183)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, indirect_arr, direct_arr from netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    indirect_arr,
    direct_arr

  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as date,
            MAX(
              IF(
                (metric_name = "direct_arr"),
                metric_value,
                NULL
              )
            ) AS direct_arr,
            MAX(
              IF(
                (metric_name = "indirect_arr"),
                metric_value,
                NULL
              )
            ) AS indirect_arr,            
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28") -- and run_date <= date('${__to:date}')
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on d.date = b.date
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (reseller = 0 and sum(annual_price) > 0, sum(annual_price), 0) AS `arr_on_prem_direct`,
    IF (reseller = 1 and sum(annual_price) > 0, sum(annual_price), 0) AS `arr_on_prem_indirect`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date, reseller
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.direct_arr,
    m.indirect_arr,
    COALESCE(s.arr_on_prem_direct, 0) AS arr_on_prem_direct,
    COALESCE(s.arr_on_prem_indirect, 0) AS arr_on_prem_indirect
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date = s.date
)
SELECT
  date,
  direct / total * 100 as direct,
  indirect / total * 100 as indirect
 FROM(
SELECT
  date,
  SUM(arr_on_prem_direct) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + direct_arr AS direct,
  SUM(arr_on_prem_indirect) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + indirect_arr AS indirect,
  SUM(arr_on_prem_direct) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) +
  SUM(arr_on_prem_indirect) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + direct_arr + indirect_arr as total,
FROM
  combined
WHERE
  date is not null and date(date) < CURRENT_DATE()
ORDER BY
  date);
```

### New Added Revenue Monthly (Existing vs New) (panel 174)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes on_prem_date as date, on_prem_total, discounted_arr + on_prem_total as discounted_arr, COALESCE(net_new_diff,0) as net_n from netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH daily_metrics AS (
SELECT
  on_prem_date as date,
  on_prem_total,
  discounted_arr + on_prem_total as discounted_arr,
  COALESCE(net_new_diff,0) as net_new_diff,
  existing_customers_arr_diff,
  test  
FROM
  (
    SELECT
      timestamp(date(run_date)) as business_date,
      MAX(IF((metric_name = "arr_business_discount"),metric_value,NULL)) + MAX(IF((metric_name = "arr_homelab_discount"),metric_value,NULL)) as discounted_arr,
      MAX(IF((metric_name = "already_customers_arr_diff_daily"), metric_value, NULL)) AS existing_customers_arr_diff,
      MAX(IF((metric_name = "net_new_arr_diff_this_month"), metric_value, NULL)) AS net_new_diff,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE run_date < CURRENT_DATE()
    GROUP BY timestamp(date(run_date))
  )
LEFT JOIN (
    Select
      on_prem_date,
      sum(annual_price) OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as on_prem_total,
      sum(annual_price) as test
    FROM
        (
          SELECT
            timestamp(date) as on_prem_date
          FROM
            UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
        ) d
        LEFT JOIN (
          SELECT
            timestamp(date(start_date)) as sheet_date,
            annual_price,
          FROM
            `netdata-analytics-bi.watch_towers.manual_360_bq`
          -- WHERE
          --   plan_type = "on-prem"
        ) a on a.sheet_date = d.on_prem_date
    GROUP BY
      on_prem_date,
      annual_price
    ) a on business_date = a.on_prem_date
WHERE
  date(on_prem_date) < CURRENT_DATE()
  -- and  date(on_prem_date) >= date('${__from:date}') - 90 and date(on_prem_date) <= DATE('${__to:date}')
)

SELECT
  TIMESTAMP(dm.date) AS date,
  dm.date,
  -- dm.test,
  -- dm.net_new_diff as net_new_diff_amount,
  -- dm.discounted_arr,
  -- dm.on_prem_total,
  --  as on_prem_diff,
  -- lme.discounted_arr AS last_month_discounted_arr,
  -- dm.discounted_arr - lme.discounted_arr AS last_month_increase,
  (dm.net_new_diff + (dm.on_prem_total - lme.on_prem_total)) / (dm.discounted_arr - lme.discounted_arr) * 100 as net_new_diff,
  ((dm.discounted_arr - lme.discounted_arr) - (dm.net_new_diff + (dm.on_prem_total - lme.on_prem_total))) / (dm.discounted_arr - lme.discounted_arr) * 100 as existing_customers,
  
  (dm.net_new_diff + (dm.on_prem_total - lme.on_prem_total)) as net_new_diff_number,
  ((dm.discounted_arr - lme.discounted_arr) - (dm.net_new_diff + (dm.on_prem_total - lme.on_prem_total))) as existing_customers_number
  
FROM
  daily_metrics dm
LEFT JOIN
  daily_metrics lme
ON
  lme.date = DATE_SUB(DATE_TRUNC(dm.date, MONTH), INTERVAL 1 DAY)
WHERE
  -- date(dm.date) <= DATE('${__to:date}') - 1 
  -- -- AND dm.run_date > DATE('${__from:date}')
  -- AND date(dm.date) > DATE("2023-01-01")
  -- AND dm.run_date < CURRENT_DATE()
  -- AND 
  date(dm.date) = LAST_DAY(date(dm.date), MONTH)
  and dm.net_new_diff is not null
  and dm.discounted_arr is not null
ORDER BY
  dm.date ASC
```

### Business node states (panel 179)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "business_reachable_node_sum"), metric_value, NULL))  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "business_reachable_node_sum"), metric_value, NULL)) AS `live`,
  MAX(IF((metric_name = "business_unreachable_node_sum"), metric_value, NULL)) AS `offline`,
  MAX(IF((metric_name = "business_stale_node_sum"), metric_value, NULL)) AS `stale`,
  MAX(IF((metric_name = "business_unseen_node_sum"), metric_value, NULL)) AS `unseen`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Homelab node states (panel 178)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "homelab_reachable_node_sum"), metric_value, NULL)) A from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "homelab_reachable_node_sum"), metric_value, NULL)) AS `live`,
  MAX(IF((metric_name = "homelab_unreachable_node_sum"), metric_value, NULL)) AS `offline`,
  MAX(IF((metric_name = "homelab_stale_node_sum"), metric_value, NULL)) AS `stale`,
  MAX(IF((metric_name = "homelab_unseen_node_sum"), metric_value, NULL)) AS `unseen`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### % ARR Split by Commitment, Overage, Pay as you go (panel 177)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Business + Homelab + On prem

```sql
WITH main_timeseries AS (
  Select
    d.date as date_series,*
  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as metrics_date,
            MAX(
              IF(
                (metric_name = "annual_usage_arr"),
                metric_value,
                NULL
              )
            ) AS `annual_usage`,
            MAX(
              IF(
                (metric_name = "annual_overage_arr"),
                metric_value,
                NULL
              )
            ) AS `annual_overage`,
            MAX(
              IF(
                (metric_name = "monthly_usage_arr"),
                metric_value,
                NULL
              )
            ) AS `monthly_usage`,
            MAX(
              IF(
                (metric_name = "monthly_usage_arr"),
                metric_value,
                NULL
              )
            ) + MAX(
              IF(
                (metric_name = "annual_overage_arr"),
                metric_value,
                NULL
              )
            ) + MAX(
              IF(
                (metric_name = "annual_usage_arr"),
                metric_value,
                NULL
              )
            ) as `total`
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28") -- and run_date <= date('${__to:date}')
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on date = metrics_date
),

spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (sum(annual_price) > 0, sum(annual_price), 0) AS `on_prem_annual_usage`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date
),

combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.annual_usage,
    m.annual_overage,
    m.monthly_usage,
    COALESCE(s.`on_prem_annual_usage`, 0) AS spike_value,
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date_series = s.date
)
SELECT 
  date,
  IF(total > 0, (annual_plan_usage / total * 100), 0) AS `annual`,
  IF(total > 0, (annual_plan_overage / total * 100), 0) AS `overage`,
  IF(total > 0, (monthly_plan_usage / total * 100), 0) AS `monthly`
  
 FROM (
SELECT
  date,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + COALESCE(annual_usage,0) AS `annual_plan_usage`,
  annual_overage as annual_plan_overage,
  monthly_usage as monthly_plan_usage,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + COALESCE(annual_usage,0) + COALESCE(annual_overage,0) + COALESCE(monthly_usage,0) as total

FROM
  combined
WHERE
  date is not null and date(date) < CURRENT_DATE()
ORDER BY
  date);
```

### Trial node states (panel 181)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "trial_reachable_node_sum"), metric_value, NULL)) AS  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "trial_reachable_node_sum"), metric_value, NULL)) AS `live`,
  MAX(IF((metric_name = "trial_unreachable_node_sum"), metric_value, NULL)) AS `offline`,
  MAX(IF((metric_name = "trial_stale_node_sum"), metric_value, NULL)) AS `stale`,
  MAX(IF((metric_name = "trial_unseen_node_sum"), metric_value, NULL)) AS `unseen`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Community node states (panel 180)
- Type: piechart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "community2311_reachable_node_sum"), metric_value, NU from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "community2311_reachable_node_sum"), metric_value, NULL)) AS `live`,
  MAX(IF((metric_name = "community2311_unreachable_node_sum"), metric_value, NULL)) AS `offline`,
  MAX(IF((metric_name = "community2311_stale_node_sum"), metric_value, NULL)) AS `stale`,
  MAX(IF((metric_name = "community2311_unseen_node_sum"), metric_value, NULL)) AS `unseen`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Nodes Reachable (panel 84)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "nodes_reachable"), metric_value, NULL)) AS `nodes_re from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "nodes_reachable"), metric_value, NULL)) AS `nodes_reachable`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### ARR Split by Revenue Source (panel 163)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, aws_business_arr, stripe_business_arr, stripe_homelab_arr -- `Target_ARR__2_8M__`, -- `Target_ARR__1M__`, -- `to from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    aws_business_arr,
    stripe_business_arr,
    stripe_homelab_arr
    -- `Target_ARR__2_8M__`,
    -- `Target_ARR__1M__`,
    -- `total ARR discounted`,
  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    -- LEFT JOIN (
    --   SELECT
    --     Date as date,
    --     Target_ARR__2_8M__,
    --     Target_ARR__1M__
    --   FROM
    --     `netdata-analytics-bi.watch_towers.arr_forecast`
    -- ) a ON d.date = a.date
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as date,
            MAX(
              IF(
                (metric_name = "stripe_business_arr"),
                metric_value,
                NULL
              )
            ) AS stripe_business_arr,
            MAX(
              IF(
                (metric_name = "stripe_homelab_arr"),
                metric_value,
                NULL
              )
            ) AS stripe_homelab_arr,
            MAX(
              IF(
                (metric_name = "aws_business_arr"),
                metric_value,
                NULL
              )
            ) AS aws_business_arr,
            
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28") -- and run_date <= date('${__to:date}')
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on d.date = b.date
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.aws_business_arr,
    m.stripe_business_arr,
    m.stripe_homelab_arr,
    -- m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date = s.date
)
SELECT
  date,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) AS `on-prem arr`,
  aws_business_arr,
  stripe_business_arr,
  stripe_homelab_arr,
FROM
  combined
WHERE
  date is not null and date(date) < CURRENT_DATE()
ORDER BY
  date;
```

### $ Direct vs Indirect ARR (panel 182)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, indirect_arr, direct_arr from netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    indirect_arr,
    direct_arr

  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as date,
            MAX(
              IF(
                (metric_name = "direct_arr"),
                metric_value,
                NULL
              )
            ) AS direct_arr,
            MAX(
              IF(
                (metric_name = "indirect_arr"),
                metric_value,
                NULL
              )
            ) AS indirect_arr,            
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28") -- and run_date <= date('${__to:date}')
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on d.date = b.date
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (reseller = 0 and sum(annual_price) > 0, sum(annual_price), 0) AS `arr_on_prem_direct`,
    IF (reseller = 1 and sum(annual_price) > 0, sum(annual_price), 0) AS `arr_on_prem_indirect`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date, reseller
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.direct_arr,
    m.indirect_arr,
    COALESCE(s.arr_on_prem_direct, 0) AS arr_on_prem_direct,
    COALESCE(s.arr_on_prem_indirect, 0) AS arr_on_prem_indirect
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date = s.date
)
SELECT
  date,
  SUM(arr_on_prem_direct) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + direct_arr AS direct,
  SUM(arr_on_prem_indirect) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + indirect_arr AS indirect,
  SUM(arr_on_prem_direct) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) +
  SUM(arr_on_prem_indirect) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + direct_arr + indirect_arr as total,
FROM
  combined
WHERE
  date is not null and date(date) < CURRENT_DATE()
ORDER BY
  date;
```

### Spaces Active (panel 85)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "spaces_active"), metric_value, NULL)) AS `spaces_act from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "spaces_active"), metric_value, NULL)) AS `spaces_active`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Nodes Created (panel 86)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "nodes_created" and metric_granularity="daily"), metr from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "nodes_created" and metric_granularity="daily"), metric_value, NULL)) AS `nodes_created`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Nodes on Subscriptions (panel 89)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)) + M from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)) as `paid business`,
  MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) as `reachable homelab`,
  MAX(IF(metric_name = "paid_on_prem_nodes", metric_value, NULL)) as `paid on-prem`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY 
  run_date
```

### $ ARR Split by Commitment, Overage, Pay as you go (panel 176)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Business + Homelab + On prem

```sql
WITH main_timeseries AS (
  Select
    d.date as date_series,*
  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as metrics_date,
            MAX(
              IF(
                (metric_name = "annual_usage_arr"),
                metric_value,
                NULL
              )
            ) AS `annual_usage`,
            MAX(
              IF(
                (metric_name = "annual_overage_arr"),
                metric_value,
                NULL
              )
            ) AS `annual_overage`,
            MAX(
              IF(
                (metric_name = "monthly_usage_arr"),
                metric_value,
                NULL
              )
            ) AS `monthly_usage`,
            MAX(
              IF(
                (metric_name = "monthly_usage_arr"),
                metric_value,
                NULL
              )
            ) + MAX(
              IF(
                (metric_name = "annual_overage_arr"),
                metric_value,
                NULL
              )
            ) + MAX(
              IF(
                (metric_name = "annual_usage_arr"),
                metric_value,
                NULL
              )
            ) as `total`
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28") -- and run_date <= date('${__to:date}')
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on date = metrics_date
),

spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (sum(annual_price) > 0, sum(annual_price), 0) AS `on_prem_annual_usage`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date
),

combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.annual_usage,
    m.annual_overage,
    m.monthly_usage,
    COALESCE(s.`on_prem_annual_usage`, 0) AS spike_value,
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date_series = s.date
)
SELECT
  date,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + COALESCE(annual_usage,0) AS `annual_plan_usage`,
  annual_overage as annual_plan_overage,
  monthly_usage as monthly_plan_usage,
  SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) + COALESCE(annual_usage,0) + COALESCE(annual_overage,0) + COALESCE(monthly_usage,0) as total

FROM
  combined
WHERE
  date is not null and date(date) < CURRENT_DATE()
ORDER BY
  date;
```

### Active Users (panel 83)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Total members of all active spaces

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "spaces_active_members_sum"), metric_value, NULL)) AS `member sum`,
  -- MAX(IF((metric_name = "spaces_active_members_homelab_sum"), metric_value, NULL)) AS `Homelab member sum`,
  -- MAX(IF((metric_name = "spaces_active_members_business_sum"), metric_value, NULL)) AS `Business member sum`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Pending nodes to 3M at 3.6$/node/mo (panel 214)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Number of nodes to add to get to 3M - assuming average price of 3.65$/node/month

```sql
WITH main_timeseries AS (
  Select
    d.date,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "business_45d_monthly_newcomer_arr"),
                metric_value,
                NULL
              )
            ),
            0
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "homelab_45d_monthly_newcomer_arr"),
                metric_value,
                NULL
              )
            ),
            0
          )
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    -- UNION
    -- ALL
    -- select
    --   timestamp(date(_partitiontime)) as date,
    --   12 * sum(
    --     if(
    --       has_subscription_business = 1,
    --       subscription_mrr_estimated,
    --       0
    --     )
    --   ) as `total ARR`,
    --   -- null AS `monthly subs ARR`,
    --   -- null AS `annual subs ARR`,
    --   0 AS `total ARR discounted`
    -- from
    --   `netdata-analytics-bi.data360.space360_daily`
    -- where
    --   -- date(_partitiontime) >= date('${__from:date}')and 
    --   date(_partitiontime) <= date('2023-11-28')
    --   and (
    --     has_subscription = 1
    --     and subscription_trial_ends_at IS NULL
    --   )
    -- group by
    --   1

  ) b on d.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  (3000000 - (`total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)))/(12*3.65),
FROM
  combined
WHERE
  date is not null
ORDER BY
  date;
```

### Accounts Created (panel 87)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "accounts_created" and metric_granularity="daily"), m from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "accounts_created" and metric_granularity="daily"), metric_value, NULL)) AS `accounts_created`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### ARR Split % by Revenue Source (panel 164)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: Computes d.date, aws_business_arr, stripe_business_arr, stripe_homelab_arr -- `Target_ARR__2_8M__`, -- `Target_ARR__1M__`, -- `to from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq.

```sql
WITH main_timeseries AS (
  Select
    d.date,
    aws_business_arr,
    stripe_business_arr,
    stripe_homelab_arr
    -- `Target_ARR__2_8M__`,
    -- `Target_ARR__1M__`,
    -- `total ARR discounted`,
  from
    (
      SELECT
        timestamp(date) as date
      FROM
        UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
    ) d
    -- LEFT JOIN (
    --   SELECT
    --     Date as date,
    --     Target_ARR__2_8M__,
    --     Target_ARR__1M__
    --   FROM
    --     `netdata-analytics-bi.watch_towers.arr_forecast`
    -- ) a ON d.date = a.date
    LEFT JOIN (
      SELECT
        *
      FROM
        (
          SELECT
            timestamp(date(run_date)) as date,
            MAX(
              IF(
                (metric_name = "stripe_business_arr"),
                metric_value,
                NULL
              )
            ) AS stripe_business_arr,
            MAX(
              IF(
                (metric_name = "stripe_homelab_arr"),
                metric_value,
                NULL
              )
            ) AS stripe_homelab_arr,
            MAX(
              IF(
                (metric_name = "aws_business_arr"),
                metric_value,
                NULL
              )
            ) AS aws_business_arr,
            
          FROM
            `netdata-analytics-bi.metrics.metrics_daily`
          WHERE
            run_date > DATE("2023-11-28") -- and run_date <= date('${__to:date}')
            and run_date < CURRENT_DATE()
          GROUP BY
            run_date
        )
    ) b on d.date = b.date
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
    timestamp(date(start_date)) as date,
    IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,
  FROM
    `netdata-analytics-bi.watch_towers.manual_360_bq`
  GROUP BY
    date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.aws_business_arr,
    m.stripe_business_arr,
    m.stripe_homelab_arr,
    -- m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    -- m.aws_business_arr + m.stripe_business_arr + m.stripe_homelab_arr + COALESCE(s.`total ARR on-prem`, 0) AS total,
    
  FROM
    main_timeseries m
    LEFT JOIN spikes s ON m.date = s.date
)
SELECT
  date,
  (SUM(spike_value) OVER (
    ORDER BY
      date ROWS BETWEEN UNBOUNDED PRECEDING
      AND CURRENT ROW
  ) / (aws_business_arr+stripe_business_arr+stripe_homelab_arr+SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW))) * 100  AS `on-prem`,
  (aws_business_arr / (aws_business_arr+stripe_business_arr+stripe_homelab_arr+SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW))) * 100 as `aws`,
  (stripe_business_arr / (aws_business_arr+stripe_business_arr+stripe_homelab_arr+SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW))) * 100 as `business`,
  (stripe_homelab_arr / (aws_business_arr+stripe_business_arr+stripe_homelab_arr+SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW))) * 100 as `homelab`,
  
  -- total,
  
FROM
  combined
WHERE
  date is not null and date(date) < CURRENT_DATE()
ORDER BY
  date;
```

### AWS ARR (panel 187)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "aws_business_arr"), metric_value, NULL)) AS `total A from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "aws_business_arr"), metric_value, NULL)) AS `total AWS ARR`,
  MAX(IF((metric_name = "aws_annual_business_arr"), metric_value, NULL)) AS `annual AWS ARR`,
  MAX(IF((metric_name = "aws_monthly_business_arr"), metric_value, NULL)) AS `monthly AWS ARR`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### AWS Subscription count (panel 188)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "aws_business_subscriptions"), metric_value, NULL)) A from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "aws_business_subscriptions"), metric_value, NULL)) AS `total`,
  MAX(IF((metric_name = "aws_annual_business_subscriptions"), metric_value, NULL)) AS `annual`,
  MAX(IF((metric_name = "aws_monthly_business_subscriptions"), metric_value, NULL)) AS `monthly`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Business + On-prem | ARR Split % By Space Node Count (panel 173)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: (discounted from Jan 4 onwards)

```sql
SELECT
  on_prem_date as date,
  (business_empty + onprem_empty) / (business_arr_total + on_prem_total) * 100 as `empty`,
  (business_e + onprem_e) / (business_arr_total + on_prem_total) * 100 as `e <= 5`,
  (business_d + onprem_d) / (business_arr_total + on_prem_total) * 100 as `d <= 25`,
  (business_c + onprem_c) / (business_arr_total + on_prem_total) * 100 as `c <= 100`,
  (business_b + onprem_b) / (business_arr_total + on_prem_total) * 100 as `b <= 500`,
  (business_a + onprem_a) / (business_arr_total + on_prem_total) * 100 as `a > 500`,
FROM
  (
    SELECT
      timestamp(date(run_date)) as business_date,
      MAX(IF((metric_name = "arr_business_grade_empty"),metric_value,NULL)) AS business_empty,
      MAX(IF((metric_name = "arr_business_grade_e"),metric_value,NULL)) AS business_e,
      MAX(IF((metric_name = "arr_business_grade_d"),metric_value,NULL)) AS business_d,
      MAX(IF((metric_name = "arr_business_grade_c"),metric_value,NULL)) AS business_c,
      MAX(IF((metric_name = "arr_business_grade_b"),metric_value,NULL)) AS business_b,
      MAX(IF((metric_name = "arr_business_grade_a"),metric_value,NULL)) AS business_a,
      MAX(IF((metric_name = "arr_business_discount"),metric_value,NULL)) as business_arr_total
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE run_date < CURRENT_DATE()
    GROUP BY timestamp(date(run_date))
  )
LEFT JOIN (
    Select
      on_prem_date,
      sum(IF(grade = "EMPTY", annual_price, 0)) OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_empty,
      sum(IF(grade = "E", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_e,
      sum(IF(grade = "D", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_d,
      sum(IF(grade = "C", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_c,
      sum(IF(grade = "B", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_b,
      sum(IF(grade = "A", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_a,
      sum(annual_price) OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as on_prem_total
    FROM
        (
          SELECT
            timestamp(date) as on_prem_date
          FROM
            UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date
        ) d
        LEFT JOIN (
          SELECT
            timestamp(date(start_date)) as sheet_date,
            annual_price,
            CASE
              WHEN current_node_count > 0
              and current_node_count <= 5 THEN "E"
              WHEN current_node_count > 0
              and current_node_count <= 25 THEN "D"
              WHEN current_node_count > 0
              and current_node_count <= 100 THEN "C"
              WHEN current_node_count > 0
              and current_node_count <= 500 THEN "B"
              WHEN current_node_count > 500 THEN "A"
              ELSE "EMPTY"
            END as grade,
          FROM
            `netdata-analytics-bi.watch_towers.manual_360_bq`
          WHERE
            plan_type = "on-prem" -- GROUP BY
            --   date,grade
        ) a on a.sheet_date = d.on_prem_date
    GROUP BY
      on_prem_date,
      grade,
      annual_price
    ) a on business_date = a.on_prem_date
  -- WHERE
  --     on_prem_date <= DATE('${__to:date}')
  --     and run_date >= date('${__from:date}')
  --     and run_date < CURRENT_DATE()
    -- GROUP BY
    --   on_prem_date)
WHERE
  date(on_prem_date) < CURRENT_DATE()
  and  date(on_prem_date) >= date('${__from:date}') and date(on_prem_date) <= DATE('${__to:date}')
-- GROUP BY on_prem_date
```

### Business % Space distribution on node count (panel 186)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, MAX(IF((metric_name = "business_space_node_grade_empty"), metric_value, NULL)) / MAX( from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "business_space_node_grade_empty"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) * 100 `empty`,
  MAX(IF((metric_name = "business_space_node_grade_e"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) * 100 AS `e <= 5`,
  MAX(IF((metric_name = "business_space_node_grade_d"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) * 100 AS `d <= 25`,
  MAX(IF((metric_name = "business_space_node_grade_c"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) * 100 AS `c <= 100`,
  MAX(IF((metric_name = "business_space_node_grade_b"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) * 100 AS `b <= 500`,
  MAX(IF((metric_name = "business_space_node_grade_a"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) * 100 AS `a > 500`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Active members on Paid Spaces (panel 184)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, -- MAX(IF((metric_name = "spaces_active_members_sum"), metric_value, NULL)) from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  -- MAX(IF((metric_name = "spaces_active_members_sum"), metric_value, NULL)) AS `member sum`,
  MAX(IF((metric_name = "spaces_active_members_homelab_sum"), metric_value, NULL)) AS `Homelab`,
  MAX(IF((metric_name = "spaces_active_members_business_sum"), metric_value, NULL)) AS `Business`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
ORDER BY
  run_date
```

### Virtual Node count (panel 159)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "total_virtual_nodes_count"), metric_value, NULL)) AS from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "total_virtual_nodes_count"), metric_value, NULL)) AS `total_virtual_nodes_count`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### New Homelab Subscriptions (panel 206)
- Type: state-timeline
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT
  timestamp(date(run_date)) AS date,
  MAX(IF((metric_name = "new_homelab_subs"), metric_value, NULL)) AS `-`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') 
  AND run_date >= DATE('${__from:date}') 
  AND run_date < CURRENT_DATE()
GROUP BY
  date
```

### Daily ARR changes by space (panel 160)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: UNKNOWN
- Interpretation: Computes ab_space_name || ' ' || aa_space_id as space_name, bq_arr_discount, TIMESTAMP(DATE(PARSE_DATE('%Y%m%d', _TABLE_SUFFIX))) from UNKNOWN SOURCES.

```sql
SELECT
  ab_space_name || ' ' || aa_space_id  as space_name,
  bq_arr_discount,
  TIMESTAMP(DATE(PARSE_DATE('%Y%m%d', _TABLE_SUFFIX))) as date,
FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX BETWEEN FORMAT_DATE('%Y%m%d', DATE('${__from:date}')) AND FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  AND ax_trial_ends_at IS NULL
  AND (ce_plan_class = "Business" or aw_sub_plan = "Business" or aw_sub_plan = "Business2024.03") 
GROUP BY
  date,
  space_name,
  bq_arr_discount
ORDER BY
  date, space_name
```

### Discounted ARR Growth $$$ (panel 131)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date run_date, `total ARR discounted`, (`total ARR discounted` - LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) AS from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
Select 
  date
  run_date,
  `total ARR discounted`,
  (`total ARR discounted` - LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`total ARR discounted` - LAG(`total ARR discounted`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`total ARR discounted` - LAG(`total ARR discounted`, 90) OVER (ORDER BY date)) AS change_over_90_days,


  -- ((`total ARR` - LAG(`total ARR`, 7) OVER (ORDER BY date)) / LAG(`total ARR`, 7) OVER (ORDER BY date)) * 100 AS growth_percentage_over_7_days



FROM(
  WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR discounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR discounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
)
```

### Discounted ARR Growth % (panel 134)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date run_date, -- `total ARR discounted`, -- (`total ARR` - LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) AS chan from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
Select 
  date
  run_date,
  -- `total ARR discounted`,
  -- (`total ARR` - LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  -- (`total ARR` - LAG(`total ARR discounted`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  -- (`total ARR` - LAG(`total ARR discounted`, 90) OVER (ORDER BY date)) AS change_over_90_days,


  ((`total ARR discounted` - LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) / LAG(`total ARR discounted`, 7) OVER (ORDER BY date)) * 100 AS growth_percentage_over_7_days,
  ((`total ARR discounted` - LAG(`total ARR discounted`, 30) OVER (ORDER BY date)) / LAG(`total ARR discounted`, 30) OVER (ORDER BY date)) * 100 AS growth_percentage_over_30_days,
  ((`total ARR discounted` - LAG(`total ARR discounted`, 90) OVER (ORDER BY date)) / LAG(`total ARR discounted`, 90) OVER (ORDER BY date)) * 100 AS growth_percentage_over_90_days



FROM(
 WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR discounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business_discount"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab_discount"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR discounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR discounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR discounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR discounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR discounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
)
```

### Un-discounted ARR Growth $$$ (panel 133)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date run_date, `total ARR undiscounted`, (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY dat from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
Select 
  date
  run_date,
  `total ARR undiscounted`,

  (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 90) OVER (ORDER BY date)) AS change_over_90_days,
FROM(
  WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR undiscounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR undiscounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR undiscounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR undiscounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR undiscounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR undiscounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
)
```

### Un-discounted ARR Growth % (panel 136)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date run_date, -- `total ARR undiscounted`, -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER  from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
Select 
  date
  run_date,
  -- `total ARR undiscounted`,
  -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 90) OVER (ORDER BY date)) AS change_over_90_days,


  ((`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) / LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) * 100 AS growth_percentage_over_7_days,
  ((`total ARR undiscounted` - LAG(`total ARR undiscounted`, 30) OVER (ORDER BY date)) / LAG(`total ARR undiscounted`, 30) OVER (ORDER BY date)) * 100 AS growth_percentage_over_30_days,
  ((`total ARR undiscounted` - LAG(`total ARR undiscounted`, 90) OVER (ORDER BY date)) / LAG(`total ARR undiscounted`, 90) OVER (ORDER BY date)) * 100 AS growth_percentage_over_90_days


FROM(
  WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR undiscounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR undiscounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR undiscounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR undiscounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR undiscounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR undiscounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
)
```

### Business paid nodes + Homelab reachable nodes growth (panel 149)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, `metric`, (`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) AS change_over_7_days, (`metric` - LAG(`metr from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,
  `metric`,

  (`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`metric` - LAG(`metric`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`metric` - LAG(`metric`, 90) OVER (ORDER BY date)) AS change_over_90_days,
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    COALESCE(MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) ,0)
    AS `metric`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where  run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Business paid nodes + Homelab reachable nodes growth % (panel 152)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, ((`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) / IF( (LAG(`metric`, 7) OVER (ORDER BY date)) * 100=0 from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,

  ((`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) / IF( (LAG(`metric`, 7) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 7) OVER (ORDER BY date)) * 100) AS growth_percentage_over_7_days,
  ((`metric` - LAG(`metric`, 30) OVER (ORDER BY date)) / IF( (LAG(`metric`, 30) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 30) OVER (ORDER BY date)) * 100) AS growth_percentage_over_30_days,
  ((`metric` - LAG(`metric`, 90) OVER (ORDER BY date)) / IF( (LAG(`metric`, 90) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 90) OVER (ORDER BY date)) * 100) AS growth_percentage_over_90_days


FROM(
  SELECT
    timestamp(date(run_date)) as date,
    COALESCE(MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) ,0) AS `metric`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Reachable Nodes growth (panel 147)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, `nodes_reachable`, (`nodes_reachable` - LAG(`nodes_reachable`, 7) OVER (ORDER BY date)) AS change_over_7_ from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,
  `nodes_reachable`,

  (`nodes_reachable` - LAG(`nodes_reachable`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`nodes_reachable` - LAG(`nodes_reachable`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`nodes_reachable` - LAG(`nodes_reachable`, 90) OVER (ORDER BY date)) AS change_over_90_days,
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    MAX(IF((metric_name = "nodes_reachable"), metric_value, NULL)) AS `nodes_reachable`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Reachable Nodes growth % (panel 148)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, ((`nodes_reachable` - LAG(`nodes_reachable`, 7) OVER (ORDER BY date)) / LAG(`nodes_reachable`, 7) OVER (O from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,

  ((`nodes_reachable` - LAG(`nodes_reachable`, 7) OVER (ORDER BY date)) / LAG(`nodes_reachable`, 7) OVER (ORDER BY date)) * 100 AS growth_percentage_over_7_days,
  ((`nodes_reachable` - LAG(`nodes_reachable`, 30) OVER (ORDER BY date)) / LAG(`nodes_reachable`, 30) OVER (ORDER BY date)) * 100 AS growth_percentage_over_30_days,
  ((`nodes_reachable` - LAG(`nodes_reachable`, 90) OVER (ORDER BY date)) / LAG(`nodes_reachable`, 90) OVER (ORDER BY date)) * 100 AS growth_percentage_over_90_days


FROM(
  SELECT
    timestamp(date(run_date)) as date,
    MAX(IF((metric_name = "nodes_reachable"), metric_value, NULL)) AS `nodes_reachable`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Business paid nodes growth (panel 150)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, `metric`, (`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) AS change_over_7_days, (`metric` - LAG(`metr from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,
  `metric`,

  (`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`metric` - LAG(`metric`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`metric` - LAG(`metric`, 90) OVER (ORDER BY date)) AS change_over_90_days,
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    COALESCE(MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)),0)
    AS `metric`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Business paid nodes growth % (panel 153)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, ((`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) / IF( (LAG(`metric`, 7) OVER (ORDER BY date)) * 100=0 from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,

  ((`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) / IF( (LAG(`metric`, 7) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 7) OVER (ORDER BY date)) * 100) AS growth_percentage_over_7_days,
  ((`metric` - LAG(`metric`, 30) OVER (ORDER BY date)) / IF( (LAG(`metric`, 30) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 30) OVER (ORDER BY date)) * 100) AS growth_percentage_over_30_days,
  ((`metric` - LAG(`metric`, 90) OVER (ORDER BY date)) / IF( (LAG(`metric`, 90) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 90) OVER (ORDER BY date)) * 100) AS growth_percentage_over_90_days
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    COALESCE(MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)),0)
    AS `metric`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Customers (Subscriptions) Growth (panel 145)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, `total_customers`, (`total_customers` - LAG(`total_customers`, 7) OVER (ORDER BY date)) AS change_over_7_ from netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,
  `total_customers`,

  (`total_customers` - LAG(`total_customers`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`total_customers` - LAG(`total_customers`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`total_customers` - LAG(`total_customers`, 90) OVER (ORDER BY date)) AS change_over_90_days,
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) +
    COALESCE(MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)), 0) +
    (SELECT COUNT(*) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) AS `total_customers`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Customers (Subscriptions) Growth % (panel 146)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date, ((`total_customers` - LAG(`total_customers`, 7) OVER (ORDER BY date)) / LAG(`total_customers`, 7) OVER (ORDER BY d from netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date,

  ((`total_customers` - LAG(`total_customers`, 7) OVER (ORDER BY date)) / LAG(`total_customers`, 7) OVER (ORDER BY date)) * 100 AS growth_percentage_over_7_days,
  ((`total_customers` - LAG(`total_customers`, 30) OVER (ORDER BY date)) / LAG(`total_customers`, 30) OVER (ORDER BY date)) * 100 AS growth_percentage_over_30_days,
  ((`total_customers` - LAG(`total_customers`, 90) OVER (ORDER BY date)) / LAG(`total_customers`, 90) OVER (ORDER BY date)) * 100 AS growth_percentage_over_90_days



FROM(
  
    SELECT
      timestamp(date(run_date)) as date,
      MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL)) +
      COALESCE(MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)), 0) +
      (SELECT COUNT(*) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) AS `total_customers`,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
     run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
    GROUP BY
      run_date
  )
```

### Homelab reachable node growth (panel 151)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, `metric`, (`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) AS change_over_7_days, (`metric` - LAG(`metr from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,
  `metric`,

  (`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) AS change_over_7_days,
  (`metric` - LAG(`metric`, 30) OVER (ORDER BY date)) AS change_over_30_days,
  (`metric` - LAG(`metric`, 90) OVER (ORDER BY date)) AS change_over_90_days,
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    + MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL))
    AS `metric`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Homelab reachable node growth % (panel 154)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes date run_date, ((`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) / IF( (LAG(`metric`, 7) OVER (ORDER BY date)) * 100=0 from netdata-analytics-bi.metrics.metrics_daily.

```sql
Select 
  date
  run_date,

  ((`metric` - LAG(`metric`, 7) OVER (ORDER BY date)) / IF( (LAG(`metric`, 7) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 7) OVER (ORDER BY date)) * 100) AS growth_percentage_over_7_days,
  ((`metric` - LAG(`metric`, 30) OVER (ORDER BY date)) / IF( (LAG(`metric`, 30) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 30) OVER (ORDER BY date)) * 100) AS growth_percentage_over_30_days,
  ((`metric` - LAG(`metric`, 90) OVER (ORDER BY date)) / IF( (LAG(`metric`, 90) OVER (ORDER BY date)) * 100=0 ,null, LAG(`metric`, 90) OVER (ORDER BY date)) * 100) AS growth_percentage_over_90_days
FROM(
  SELECT
    timestamp(date(run_date)) as date,
    -- COALESCE(MAX(IF(metric_name = "paid_nodes_business_annual", metric_value, NULL)),0)
    -- + COALESCE(MAX(IF(metric_name = "paid_nodes_business_monthly", metric_value, NULL)),0)
    + COALESCE(MAX(IF(metric_name = "total_reachable_nodes_homelab", metric_value, NULL)) ,0) 
    AS `metric`,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
  GROUP BY
    run_date
)
```

### Reachable Business breakdown by space (panel 161)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: UNKNOWN
- Interpretation: Computes aa_space_id || ' ' || ab_space_name as space_name, ae_reachable_nodes, TIMESTAMP(DATE(PARSE_DATE('%Y%m%d', _TABLE_SUFFIX from UNKNOWN SOURCES.

```sql
SELECT
  aa_space_id || ' ' || ab_space_name  as space_name,
  ae_reachable_nodes,
  TIMESTAMP(DATE(PARSE_DATE('%Y%m%d', _TABLE_SUFFIX))) as date,
FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX BETWEEN FORMAT_DATE('%Y%m%d', DATE('${__from:date}')) AND FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  AND ax_trial_ends_at IS NULL
  AND (ce_plan_class = "Business" or aw_sub_plan = "Business" or aw_sub_plan = "Business2024.03")
GROUP BY
  date,
  space_name,
  ae_reachable_nodes
ORDER BY
  date, space_name
```

### Adjusted Churn (panel 135)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: delta
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_d from netdata-analytics-bi.watch_towers.spaces_latest.

```sql
WITH table as(

-- CHURNERS
-- churn day
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,0,-1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial churn","churn") as status, ca_cur_plan_start_date as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"

-- addition day
UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,-1,1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial addition","addition") as status, cb_prev_plan_start_date as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"


-- NEW UPGRADERS <= 45 DAYS


UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,0,1) as adjustment,
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,"immature addition","addition") as status, ca_cur_plan_start_date as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Upgrade to Business" or ba_plan_change = "Upgrade from trial to Business"

)

select sum(adjustment) as ` `, TIMESTAMP(DATE(adjustment_date))
from table
where adjustment_date > date('2023-11-28') GROUP BY TIMESTAMP(DATE(adjustment_date))
-- where aa_space_id = "5e67db8c-82df-4d71-a13e-1e3b840121b9" or aa_space_id = "b1213c34-9961-4106-ab5c-5fd976ce811c"


-- UNION ALL
-- select * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business" or ba_plan_change = "Upgrade to Business" or ba_plan_change="Upgrade from trial to Business"
```

### Adjusted Churn (panel 135)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: churn
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_d from netdata-analytics-bi.watch_towers.spaces_latest.

```sql
WITH table as(

-- CHURNERS
-- churn day
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,0,-1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial churn","churn") as status, ca_cur_plan_start_date as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"

-- addition day
UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,-1,1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial addition","addition") as status, cb_prev_plan_start_date as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"


-- NEW UPGRADERS <= 45 DAYS


UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,0,1) as adjustment,
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,"immature addition","addition") as status, ca_cur_plan_start_date as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Upgrade to Business" or ba_plan_change = "Upgrade from trial to Business"

)

select sum(adjustment) as ` `, TIMESTAMP(DATE(adjustment_date))
from table
where adjustment_date > date('2023-11-28') and status = "churn" GROUP BY TIMESTAMP(DATE(adjustment_date))
-- where aa_space_id = "5e67db8c-82df-4d71-a13e-1e3b840121b9" or aa_space_id = "b1213c34-9961-4106-ab5c-5fd976ce811c"


-- UNION ALL
-- select * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business" or ba_plan_change = "Upgrade to Business" or ba_plan_change="Upgrade from trial to Business"
```

### Adjusted Churn (panel 135)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: total
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes aa_space_id, adjustment, status, adjustment_date from( -- CHURNERS -- churn day select DATE_DIFF(ca_cur_plan_start_date, from netdata-analytics-bi.watch_towers.spaces_latest.

```sql
with table as (select aa_space_id, adjustment, status, adjustment_date from(


-- CHURNERS
-- churn day
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,0,-1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial churn","churn") as status, DATE(ca_cur_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"

-- addition day
UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,-1,1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial addition","addition") as status, DATE(cb_prev_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"


-- NEW UPGRADERS <= 45 DAYS


UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,0,1) as adjustment,
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,"immature addition","addition") as status, DATE(ca_cur_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Upgrade to Business" or ba_plan_change = "Upgrade from trial to Business"

)
-- where aa_space_id = "5e67db8c-82df-4d71-a13e-1e3b840121b9" or aa_space_id = "b1213c34-9961-4106-ab5c-5fd976ce811c"


-- UNION ALL
-- select * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business" or ba_plan_change = "Upgrade to Business" or ba_plan_change="Upgrade from trial to Business"
)


SELECT MAX(total)+119 as ` `, TIMESTAMP(DATE(adjustment_date)) from (
SELECT
  adjustment_date,
  -- adjustment,
  SUM(adjustment) OVER (ORDER BY adjustment_date) as total
FROM
  table
-- GROUP BY
--   adjustment_date
ORDER BY
  adjustment_date DESC
)

where adjustment_date > DATE("2023-11-28")
group by adjustment_date
order by adjustment_date DESC
```

### Adjusted Churn (panel 135)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: immature additions
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes aa_space_id, adjustment, status, adjustment_date from( -- CHURNERS -- churn day select DATE_DIFF(ca_cur_plan_start_date, from netdata-analytics-bi.watch_towers.spaces_latest.

```sql
with table as (select aa_space_id, adjustment, status, adjustment_date from(


-- CHURNERS
-- churn day
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,0,-1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial churn","churn") as status, DATE(ca_cur_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"

-- addition day
UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,-1,1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial addition","addition") as status, DATE(cb_prev_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"


-- NEW UPGRADERS <= 45 DAYS


UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,0,1) as adjustment,
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,"immature addition","addition") as status, DATE(ca_cur_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Upgrade to Business" or ba_plan_change = "Upgrade from trial to Business"

)
-- where aa_space_id = "5e67db8c-82df-4d71-a13e-1e3b840121b9" or aa_space_id = "b1213c34-9961-4106-ab5c-5fd976ce811c"


-- UNION ALL
-- select * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business" or ba_plan_change = "Upgrade to Business" or ba_plan_change="Upgrade from trial to Business"
)


SELECT MAX(total) as ` `, TIMESTAMP(DATE(adjustment_date)) from (
SELECT
  adjustment_date,
  -- adjustment,
  count(adjustment) OVER (ORDER BY adjustment_date) as total
FROM
  table
WHERE status = "immature addition"
-- GROUP BY
--   adjustment_date
ORDER BY
  adjustment_date DESC
)
where adjustment_date > DATE("2023-11-28")
group by adjustment_date
order by adjustment_date DESC
```

### Adjusted Churn (panel 135)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: total churn
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes aa_space_id, adjustment, status, adjustment_date from( -- CHURNERS -- churn day select DATE_DIFF(ca_cur_plan_start_date, from netdata-analytics-bi.watch_towers.spaces_latest.

```sql
with table as (select aa_space_id, adjustment, status, adjustment_date from(


-- CHURNERS
-- churn day
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,0,-1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial churn","churn") as status, DATE(ca_cur_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"

-- addition day
UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,-1,1) as adjustment,
IF(DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY) <= 45,"trial addition","addition") as status, DATE(cb_prev_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business"


-- NEW UPGRADERS <= 45 DAYS


UNION ALL
select DATE_DIFF(ca_cur_plan_start_date,cb_prev_plan_start_date, DAY), 
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,0,1) as adjustment,
IF(DATE_DIFF(CURRENT_DATE(),ca_cur_plan_start_date, DAY) <= 45,"immature addition","addition") as status, DATE(ca_cur_plan_start_date) as adjustment_date, * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Upgrade to Business" or ba_plan_change = "Upgrade from trial to Business"

)
-- where aa_space_id = "5e67db8c-82df-4d71-a13e-1e3b840121b9" or aa_space_id = "b1213c34-9961-4106-ab5c-5fd976ce811c"


-- UNION ALL
-- select * from `netdata-analytics-bi.watch_towers.spaces_latest` where ba_plan_change = "Downgrade" or ba_plan_change = "Downgrade from Business" or ba_plan_change = "Upgrade to Business" or ba_plan_change="Upgrade from trial to Business"
)


SELECT MAX(total) as ` `, TIMESTAMP(DATE(adjustment_date)) from (
SELECT
  adjustment_date,
  -- adjustment,
  sum(adjustment) OVER (ORDER BY adjustment_date) as total
FROM
  table
WHERE status = "churn"
and adjustment_date > DATE("2023-11-28")
-- GROUP BY
--   adjustment_date
ORDER BY
  adjustment_date DESC
)
where adjustment_date > DATE("2023-11-28")
group by adjustment_date
order by adjustment_date DESC
```

### MRR Growth (panel 106)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: MoM
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: MoM and QoQ

```sql
-- Identify the last day of each month
WITH last_day_of_month_data AS (
  SELECT
    DATE_TRUNC(date, MONTH) as month,
    ARRAY_AGG(MRR ORDER BY date DESC LIMIT 1)[OFFSET(0)] as end_of_month_MRR
  FROM
    (
    SELECT
      timestamp(date(run_date)) as date,
      -- MAX(IF((metric_name = "mrr_business"), metric_value, NULL)) AS `total MRR`,
      MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL)) AS `MRR`,
      -- MAX(IF((metric_name = "mrr_business_month_subs"), metric_value, NULL)) AS `monthly subs MRR`,
      -- MAX(IF((metric_name = "mrr_business_annual_subs"), metric_value, NULL)) AS `annual subs MRR`,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    where run_date <= DATE('${__to:date}') and run_date < CURRENT_DATE()
    GROUP BY
      run_date
  )
  GROUP BY
    month
)

-- Calculate MoM growth
SELECT
  month,
  end_of_month_MRR,
  LAG(end_of_month_MRR, 1) OVER (ORDER BY month) as previous_month_MRR,
  IFNULL(((end_of_month_MRR - LAG(end_of_month_MRR, 1) OVER (ORDER BY month)) / NULLIF(LAG(end_of_month_MRR, 1) OVER (ORDER BY month), 0)) * 100, 0) AS growth
FROM
  last_day_of_month_data
ORDER BY
  month;
```

### MRR Growth (panel 106)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: QoQ
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: MoM and QoQ

```sql
-- Identify the last day of each quarter
WITH last_day_of_quarter_data AS (
  SELECT
    DATE_TRUNC(date, QUARTER) as quarter,
    ARRAY_AGG(MRR ORDER BY date DESC LIMIT 1)[OFFSET(0)] as end_of_quarter_MRR
  FROM
    (
    SELECT
      timestamp(date(run_date)) as date,
      -- MAX(IF((metric_name = "mrr_business"), metric_value, NULL)) AS `total MRR`,
      MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL)) AS `MRR`,
      -- MAX(IF((metric_name = "mrr_business_month_subs"), metric_value, NULL)) AS `monthly subs MRR`,
      -- MAX(IF((metric_name = "mrr_business_annual_subs"), metric_value, NULL)) AS `annual subs MRR`,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    where run_date < DATE('${__to:date}')
    GROUP BY
      run_date
    )
  GROUP BY
    quarter
)

-- Calculate QoQ growth
SELECT
  quarter,
  end_of_quarter_MRR,
  LAG(end_of_quarter_MRR, 1) OVER (ORDER BY quarter) as previous_quarter_MRR,
  IFNULL(((end_of_quarter_MRR - LAG(end_of_quarter_MRR, 1) OVER (ORDER BY quarter)) / NULLIF(LAG(end_of_quarter_MRR, 1) OVER (ORDER BY quarter), 0)) * 100, 0) AS growth
FROM
  last_day_of_quarter_data
ORDER BY
  quarter;
```

### Business Subscriptions (panel 25)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.churn_up_until_2201
- Interpretation: Count of subscriptions

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "subscriptions_total_monthly" or metric_name = "monthly_business_subscriptions"), metric_value, NULL)) AS `monthly`,
  MAX(IF((metric_name = "subscriptions_total_annual"  or metric_name = "annual_business_subscriptions"), metric_value, NULL)) AS `annual`,
  MAX(IF((metric_name = "subscriptions_total" or metric_name = "subscriptions" or metric_name = "total_business_subscriptions"), metric_value, NULL)) AS `total`,
  COALESCE(MAX(b.churn),MAX(IF((metric_name = "total_churn_subs" or metric_name = "total_churned_business_subscriptions"), metric_value, NULL))) as `churn_community`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`

LEFT JOIN (SELECT 
  -- timestamp(DATE(run_time)) as date,
  date(run_time) as run_time, 
  MAX(metric_value) as churn
FROM `netdata-analytics-bi.watch_towers.churn_up_until_2201` 
WHERE
  DATE(run_time) < DATE('2024-01-22') and DATE(run_time) >= date('${__from:date}')
GROUP BY
  run_time) b on run_date = b.run_time
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### ARR Average per Subscription (panel 18)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes * FROM(SELECT timestamp(date(run_date)) as date, MAX(IF((metric_name = "arr_business"), metric_value, NULL)) / MAX(IF((m from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "arr_business"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL))  AS `average_arr`,
  MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL))  AS `average_arr_discount`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date)
```

### MRR - Cloud (panel 109)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: MRR by subscription plan type. Calculated daily.

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "mrr_business"), metric_value, NULL)) AS `total MRR`,
  MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL)) AS `total MRR discounted`,
  MAX(IF((metric_name = "mrr_business_month_subs"), metric_value, NULL)) AS `monthly subs MRR`,
  MAX(IF((metric_name = "mrr_business_annual_subs"), metric_value, NULL)) AS `annual subs MRR`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE() and run_date > DATE("2023-11-28")
GROUP BY
  run_date)
UNION ALL
select
  timestamp(date(_partitiontime)) as date,
  -- sum(subscription_mrr_estimated) as subscription_mrr_estimated_total,
  /* sum(if(has_subscription_community=1,subscription_mrr_estimated,0)) as subscription_mrr_estimated_community,*/
  -- sum(if(has_subscription_pro=1,subscription_mrr_estimated,0)) as subscription_mrr_estimated_pro,
  sum(if(has_subscription_business=1,subscription_mrr_estimated,0)) as `total MRR`,
  null as `monthly subs MRR`,
  null as `annual subs MRR`,
  null as `total MRR discounted`
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date("2023-11-28") 
  and
  (has_subscription = 1 and subscription_trial_ends_at IS NULL)
group by 1
```

### MRR - Cloud (panel 109)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.watch_towers.spaces_asat_20231129
- Interpretation: MRR by subscription plan type. Calculated daily.

```sql
SELECT SUM(bl_arr) FROM `netdata-analytics-bi.watch_towers.spaces_asat_20231129` LIMIT 50
```

### Net Additions (panel 26)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Daily metric coming from watch-towers spaces dataset.

Churn is: Deletions + downgrades that happened yesterday.

Upgrade: Spaces that upgraded from either Community or Trial

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "new_subs" or metric_name = "new_business_subs"), metric_value, NULL)) AS `additions`,
  MAX(IF((metric_name = "churn_business_subs_community"), -metric_value, NULL)) AS `churn_community`,
  MAX(IF((metric_name = "churn_business_subs_deleted"), -metric_value, NULL)) AS `churn_deleted`,
  MAX(IF((metric_name = "churn_subs" or metric_name = "churn_business_subs"), -metric_value, NULL)) AS `churn_total`,
  MAX(IF((metric_name = "new_subs" or metric_name = "new_business_subs"), metric_value, NULL)) - MAX(IF((metric_name = "churn_subs" or metric_name = "churn_business_subs"), metric_value, NULL)) as `net additions`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Cloud Subscription ARR by space node grade (discounted) (panel 34)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: (discounted from Jan 4 onwards)

```sql
SELECT
  timestamp(date(run_date)) as date,
  (MAX(IF((metric_name = "arr_business_grade_empty"), metric_value, NULL)) / MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL))) * 100 AS `empty`,
  (MAX(IF((metric_name = "arr_business_grade_e"), metric_value, NULL)) / MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL))) * 100 AS `e <= 5`,
  (MAX(IF((metric_name = "arr_business_grade_d"), metric_value, NULL)) / MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL))) * 100 AS `d <= 20`,
  (MAX(IF((metric_name = "arr_business_grade_c"), metric_value, NULL)) / MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL))) * 100 AS `c <= 100`,
  (MAX(IF((metric_name = "arr_business_grade_b"), metric_value, NULL)) / MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL))) * 100 AS `b <= 500`,
  (MAX(IF((metric_name = "arr_business_grade_a"), metric_value, NULL)) / MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL))) * 100 AS `a > 500`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### ARR - Cloud (panel 175)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: ARR by subscription plan type. Calculated daily.

```sql
SELECT *--,COALESCE(subscription_arr_estimated_business,0) + COALESCE(subscription_arr_estimated_pro,0) as subscription_arr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "arr_business"), metric_value, NULL)) AS `total ARR`,
  MAX(IF((metric_name = "arr_business_discount"), metric_value, NULL)) AS `total ARR discounted`,
  MAX(IF((metric_name = "arr_business_month_subs"), metric_value, NULL)) AS `monthly subs ARR`,
  MAX(IF((metric_name = "arr_business_annual_subs"), metric_value, NULL)) AS `annual subs ARR`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE() and run_date > DATE("2023-11-28")
GROUP BY
  run_date)
-- UNION ALL
-- select
--   timestamp(date(_partitiontime)) as date,
--   -- sum(subscription_arr_estimated) as subscription_arr_estimated_total,
--   /* sum(if(has_subscription_community=1,subscription_arr_estimated,0)) as subscription_arr_estimated_community,*/
--   -- sum(if(has_subscription_pro=1,subscription_arr_estimated,0)) as subscription_arr_estimated_pro,
--   sum(if(has_subscription_business=1,subscription_arr_estimated,0)) as `total ARR`,
--   null as `monthly subs ARR`,
--   null as `annual subs ARR`,
--   null as `total ARR discounted`
-- from
--   `netdata-analytics-bi.data360.space360_daily`
-- where
--   date(_partitiontime) >= date('${__from:date}')
--   and
--   date(_partitiontime) <= date("2023-11-28") 
--   and
--   (has_subscription = 1 and subscription_trial_ends_at IS NULL)
-- group by 1
```

### ARR - Cloud (panel 175)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.watch_towers.spaces_asat_20231129
- Interpretation: ARR by subscription plan type. Calculated daily.

```sql
SELECT SUM(bl_arr) FROM `netdata-analytics-bi.watch_towers.spaces_asat_20231129` LIMIT 50
```

### Paid Spaces per Node Grade (panel 35)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_est from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "subs_space_node_grade_empty" or metric_name = "business_space_node_grade_empty"), metric_value, NULL)) AS `empty =0`,
  MAX(IF((metric_name = "subs_space_node_grade_e" or metric_name = "business_space_node_grade_e"), metric_value, NULL)) AS `e <=5`,
  MAX(IF((metric_name = "subs_space_node_grade_d" or metric_name = "business_space_node_grade_d"), metric_value, NULL)) AS `d <=20`,
  MAX(IF((metric_name = "subs_space_node_grade_c" or metric_name = "business_space_node_grade_c"), metric_value, NULL)) AS `c <=100`,
  MAX(IF((metric_name = "subs_space_node_grade_b" or metric_name = "business_space_node_grade_b"), metric_value, NULL)) AS `b <=500`,
  MAX(IF((metric_name = "subs_space_node_grade_a" or metric_name = "business_space_node_grade_a"), metric_value, NULL)) AS `a >500`,
  
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date)
```

### Average Discount per Node Grade (panel 48)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Sum of discounts per grade / space count on each grade

```sql
SELECT *--,COALESCE(businesscription_mrr_estimated_business,0) + COALESCE(businesscription_mrr_estimated_pro,0) as businesscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "discount_sum_grade_empty_business" or metric_name = "discount_sum_grade_empty_business"), metric_value, NULL)) / MAX(IF((metric_name = "business_space_node_grade_empty" or metric_name = "business_space_node_grade_empty"), metric_value, NULL)) AS `empty =0`,
  MAX(IF((metric_name = "discount_sum_grade_e_business" or metric_name = "discount_sum_grade_empty_e"), metric_value, NULL)) / MAX(IF((metric_name = "business_space_node_grade_e" or metric_name = "business_space_node_grade_e"), metric_value, NULL)) AS `e <=5`,
  MAX(IF((metric_name = "discount_sum_grade_d_business" or metric_name = "discount_sum_grade_empty_d"), metric_value, NULL)) / MAX(IF((metric_name = "business_space_node_grade_d" or metric_name = "business_space_node_grade_d"), metric_value, NULL)) AS `d <=20`,
  MAX(IF((metric_name = "discount_sum_grade_c_business" or metric_name = "discount_sum_grade_empty_c"), metric_value, NULL)) / MAX(IF((metric_name = "business_space_node_grade_c" or metric_name = "business_space_node_grade_c"), metric_value, NULL)) AS `c <=100`,
  MAX(IF((metric_name = "discount_sum_grade_b_business" or metric_name = "discount_sum_grade_empty_b"), metric_value, NULL)) / MAX(IF((metric_name = "business_space_node_grade_b" or metric_name = "business_space_node_grade_b"), metric_value, NULL)) AS `b <=500`,
  MAX(IF((metric_name = "discount_sum_grade_a_business" or metric_name = "discount_sum_grade_empty_a"), metric_value, NULL)) / MAX(IF((metric_name = "business_space_node_grade_a" or metric_name = "business_space_node_grade_a"), metric_value, NULL)) AS `a >500`,
  
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date)
```

### MRR per Subscription (panel 112)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes * FROM(SELECT timestamp(date(run_date)) as date, MAX(IF((metric_name = "mrr_business"), metric_value, NULL)) / MAX(IF((m from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "mrr_business"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL))  AS `average_mrr`,
  MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL)) / MAX(IF((metric_name = "total_business_subscriptions"), metric_value, NULL))  AS `average_mrr_discount`,
  -- MAX(IF((metric_name = "mrr_pro"), metric_value, NULL)) AS `subscription_mrr_estimated_pro`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date)
```

### Paid nodes per subscription (Average) (panel 47)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_busin from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) / MAX(IF((metric_name = "subscriptions_total_annual" or metric_name = "annual_business_subscriptions"), metric_value, NULL)) AS `annual`,
  MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL)) / MAX(IF((metric_name = "subscriptions_total_monthly" or metric_name = "monthly_business_subscriptions"), metric_value, NULL)) AS `monthly`,
  (MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL))) / MAX(IF((metric_name = "subscriptions_total" or metric_name = "subscriptions" or metric_name = "total_business_subscriptions"), metric_value, NULL)) AS `total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Average price per node (discounted) (panel 46)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, -- MAX(IF(metric_name = "mrr_business_grade_empty", metric_value, NULL)) /  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  -- MAX(IF(metric_name = "mrr_business_grade_empty", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_grade_empty" or metric_name = "paid_nodes_grade_empty_business", metric_value, NULL)) AS `empty`,
  MAX(IF(metric_name = "mrr_business_grade_e", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_grade_e" or metric_name = "paid_nodes_grade_e_business", metric_value, NULL)) AS `e <= 5`,
  MAX(IF(metric_name = "mrr_business_grade_d", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_grade_d" or metric_name = "paid_nodes_grade_d_business", metric_value, NULL)) AS `d <= 20`,
  MAX(IF(metric_name = "mrr_business_grade_c", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_grade_c" or metric_name = "paid_nodes_grade_c_business", metric_value, NULL)) AS `c <= 100`,
  MAX(IF(metric_name = "mrr_business_grade_b", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_grade_b" or metric_name = "paid_nodes_grade_b_business", metric_value, NULL)) AS `b <= 500`,
  MAX(IF(metric_name = "mrr_business_grade_a", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_grade_a" or metric_name = "paid_nodes_grade_a_business", metric_value, NULL)) AS `a > 500`,
  MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL)) / (MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL))) as `total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Cloud Subscription MRR by space node grade (discounted) (panel 42)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: (discounted from Jan 4 onwards)

```sql
SELECT
  timestamp(date(run_date)) as date,
  (MAX(IF((metric_name = "mrr_business_grade_empty"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL))) * 100 AS `empty`,
  (MAX(IF((metric_name = "mrr_business_grade_e"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL))) * 100 AS `e <= 5`,
  (MAX(IF((metric_name = "mrr_business_grade_d"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL))) * 100 AS `d <= 20`,
  (MAX(IF((metric_name = "mrr_business_grade_c"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL))) * 100 AS `c <= 100`,
  (MAX(IF((metric_name = "mrr_business_grade_b"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL))) * 100 AS `b <= 500`,
  (MAX(IF((metric_name = "mrr_business_grade_a"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL))) * 100 AS `a > 500`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Paid nodes (panel 44)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: these are the billing_period_nodes_live sum for the monthly subs and the greater of committed nodes or billing_period_nodes_live metric for annual.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) AS `annual`,
  MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL)) AS `monthly`,
  MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL)) as `total`,
  MAX(IF(metric_name = "paid_nodes_reachable" or metric_name = "paid_nodes_reachable_business", metric_value, NULL)) AS `total_reachable`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Subscription conversion percentages (panel 60)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, (MAX(IF(( metric_name = "business_subs_coming_from_trial"), metric_value, N from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  (MAX(IF(( metric_name = "business_subs_coming_from_trial"), metric_value, NULL)) /MAX(IF(( metric_name = "total_business_subscriptions"), metric_value, NULL))) * 100 AS `came from trial`,
  (MAX(IF(( metric_name = "business_subs_coming_from_free"), metric_value, NULL)) /MAX(IF(( metric_name = "total_business_subscriptions"), metric_value, NULL))) * 100 AS `came from free`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Average Discount per Plan period (panel 58)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Sum of discounts per plan period / space count on each case

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "discount_sum_annual_subs" or metric_name = "discount_sum_business_annual_subs"), metric_value, NULL)) / MAX(IF((metric_name = "subscriptions_total_annual" or metric_name = "annual_business_subscriptions"), metric_value, NULL)) AS `annual`,
  MAX(IF((metric_name = "discount_sum_monthly_subs" or metric_name = "discount_sum_business_monthly_subs"), metric_value, NULL)) / MAX(IF((metric_name = "subscriptions_total_monthly" or metric_name = "monthly_business_subscriptions"), metric_value, NULL)) AS `monthly`,

  (MAX(IF((metric_name = "discount_sum_annual_subs" or metric_name = "discount_sum_business_annual_subs"), metric_value, NULL)) + MAX(IF((metric_name = "discount_sum_monthly_subs" or metric_name = "discount_sum_business_monthly_subs"), metric_value, NULL))) / MAX(IF((metric_name = "subscriptions_total" or metric_name = "total_business_subscriptions"), metric_value, NULL)) AS `total`,

FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date)
```

### Space count based on node grade (panel 185)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, MAX(IF((metric_name = "business_space_node_grade_empty"), metric_value, NULL)) AS `em from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "business_space_node_grade_empty"), metric_value, NULL)) AS `empty`,
  MAX(IF((metric_name = "business_space_node_grade_e"), metric_value, NULL))  AS `e <= 5`,
  MAX(IF((metric_name = "business_space_node_grade_d"), metric_value, NULL))  AS `d <= 20`,
  MAX(IF((metric_name = "business_space_node_grade_c"), metric_value, NULL))   AS `c <= 100`,
  MAX(IF((metric_name = "business_space_node_grade_b"), metric_value, NULL))   AS `b <= 500`,
  MAX(IF((metric_name = "business_space_node_grade_a"), metric_value, NULL))  AS `a > 500`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Average price per node per plan period (discounted) (panel 59)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF(metric_name = "mrr_business_monthly_subs_discounted", metric_value,  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "mrr_business_monthly_subs_discounted", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL)) AS `monthly`,
  MAX(IF(metric_name = "mrr_business_annual_subs_discounted", metric_value, NULL)) / MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) AS `annual`,
  MAX(IF((metric_name = "mrr_business_discount"), metric_value, NULL)) / (MAX(IF(metric_name = "paid_nodes_annual" or metric_name = "paid_nodes_business_annual", metric_value, NULL)) + MAX(IF(metric_name = "paid_nodes_monthly" or metric_name = "paid_nodes_business_monthly", metric_value, NULL))) as `total`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}') and run_date < CURRENT_DATE()
GROUP BY
  run_date
```

### Reachable Homelab breakdown by space (panel 162)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: UNKNOWN
- Interpretation: Computes aa_space_id || ' ' || ab_space_name as space_name, ae_reachable_nodes, TIMESTAMP(DATE(PARSE_DATE('%Y%m%d', _TABLE_SUFFIX from UNKNOWN SOURCES.

```sql
SELECT
  aa_space_id || ' ' || ab_space_name  as space_name,
  ae_reachable_nodes,
  TIMESTAMP(DATE(PARSE_DATE('%Y%m%d', _TABLE_SUFFIX))) as date,
FROM
  `netdata-analytics-bi.watch_towers.spaces_asat_*`
WHERE
  _TABLE_SUFFIX BETWEEN FORMAT_DATE('%Y%m%d', DATE('${__from:date}')) AND FORMAT_DATE('%Y%m%d', DATE('${__to:date}') - 1)
  AND ax_trial_ends_at IS NULL
  AND (ce_plan_class = "Homelab") --and ae_reachable_nodes > 50
GROUP BY
  date,
  space_name,
  ae_reachable_nodes
ORDER BY
  date, space_name
```

### Homelab Subscriptions (panel 105)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)) AS `total`,
  MAX(IF((metric_name = "total_churned_homelab_subscriptions"), metric_value, NULL)) as `churn_community`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`

WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### MRR Growth (panel 79)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: MoM
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: MoM and QoQ

```sql
-- Identify the last day of each month
WITH last_day_of_month_data AS (
  SELECT
    DATE_TRUNC(date, MONTH) as month,
    ARRAY_AGG(MRR ORDER BY date DESC LIMIT 1)[OFFSET(0)] as end_of_month_MRR
  FROM
    (
    SELECT
      timestamp(date(run_date)) as date,
      -- MAX(IF((metric_name = "mrr_homelab"), metric_value, NULL)) AS `total MRR`,
      MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL)) AS `MRR`,
      -- MAX(IF((metric_name = "mrr_homelab_month_subs"), metric_value, NULL)) AS `monthly subs MRR`,
      -- MAX(IF((metric_name = "mrr_homelab_annual_subs"), metric_value, NULL)) AS `annual subs MRR`,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}') and run_date > DATE('${__from:date}')
    GROUP BY
      run_date
  )
  GROUP BY
    month
)

-- Calculate MoM growth
SELECT
  month,
  end_of_month_MRR,
  LAG(end_of_month_MRR, 1) OVER (ORDER BY month) as previous_month_MRR,
  IFNULL(((end_of_month_MRR - LAG(end_of_month_MRR, 1) OVER (ORDER BY month)) / NULLIF(LAG(end_of_month_MRR, 1) OVER (ORDER BY month), 0)) * 100, 0) AS growth
FROM
  last_day_of_month_data
ORDER BY
  month;
```

### MRR Growth (panel 79)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: QoQ
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: MoM and QoQ

```sql
-- Identify the last day of each quarter
WITH last_day_of_quarter_data AS (
  SELECT
    DATE_TRUNC(date, QUARTER) as quarter,
    ARRAY_AGG(MRR ORDER BY date DESC LIMIT 1)[OFFSET(0)] as end_of_quarter_MRR
  FROM
    (
    SELECT
      timestamp(date(run_date)) as date,
      -- MAX(IF((metric_name = "mrr_homelab"), metric_value, NULL)) AS `total MRR`,
      MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL)) AS `MRR`,
      -- MAX(IF((metric_name = "mrr_homelab_month_subs"), metric_value, NULL)) AS `monthly subs MRR`,
      -- MAX(IF((metric_name = "mrr_homelab_annual_subs"), metric_value, NULL)) AS `annual subs MRR`,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}') and run_date > DATE("2023-11-28")
    GROUP BY
      run_date
    )
  GROUP BY
    quarter
)

-- Calculate QoQ growth
SELECT
  quarter,
  end_of_quarter_MRR,
  LAG(end_of_quarter_MRR, 1) OVER (ORDER BY quarter) as previous_quarter_MRR,
  IFNULL(((end_of_quarter_MRR - LAG(end_of_quarter_MRR, 1) OVER (ORDER BY quarter)) / NULLIF(LAG(end_of_quarter_MRR, 1) OVER (ORDER BY quarter), 0)) * 100, 0) AS growth
FROM
  last_day_of_quarter_data
ORDER BY
  quarter;
```

### Net Additions (panel 107)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Daily metric coming from watch-towers spaces dataset.

Churn is: Deletions + downgrades that happened yesterday.

Upgrade: Spaces that upgraded from either Community or Trial

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "new_subs" or metric_name = "new_homelab_subs"), metric_value, NULL)) AS `additions`,
  MAX(IF((metric_name = "churn_homelab_subs_community"), -metric_value, NULL)) AS `churn_community`,
  MAX(IF((metric_name = "churn_homelab_subs_deleted"), -metric_value, NULL)) AS `churn_deleted`,
  MAX(IF((metric_name = "churn_subs" or metric_name = "churn_homelab_subs"), -metric_value, NULL)) AS `churn_total`,
  MAX(IF((metric_name = "new_subs" or metric_name = "new_homelab_subs"), metric_value, NULL)) - MAX(IF((metric_name = "churn_subs" or metric_name = "churn_homelab_subs"), metric_value, NULL)) as `net additions`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= DATE('${__from:date}') 
GROUP BY
  run_date
```

### Homelab ARR Average per Subscription (panel 108)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes * FROM(SELECT timestamp(date(run_date)) as date, MAX(IF((metric_name = "arr_homelab"), metric_value, NULL)) / MAX(IF((me from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "arr_homelab"), metric_value, NULL)) / MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL))  AS `average_arr`,
  MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL)) / MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL))  AS `average_arr_discount`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= DATE('${__from:date}') 
GROUP BY
  run_date)
```

### MRR - Homelab (panel 6)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: MRR by subscription plan type. Calculated daily.

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_homelab,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "mrr_homelab"), metric_value, NULL)) AS `total MRR`,
  MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL)) AS `total MRR discounted`,
  MAX(IF((metric_name = "mrr_homelab_month_subs"), metric_value, NULL)) AS `monthly subs MRR`,
  MAX(IF((metric_name = "mrr_homelab_annual_subs"), metric_value, NULL)) AS `annual subs MRR`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date > DATE("2023-11-28")
GROUP BY
  run_date)
```

### MRR - Homelab (panel 6)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.watch_towers.spaces_asat_20231129
- Interpretation: MRR by subscription plan type. Calculated daily.

```sql
SELECT SUM(bl_arr) FROM `netdata-analytics-bi.watch_towers.spaces_asat_20231129` LIMIT 50
```

### Homelab Spaces per Node Grade (panel 110)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes *--,COALESCE(subscription_mrr_estimated_homelab,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_esti from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_homelab,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "homelab_space_node_grade_empty"), metric_value, NULL)) AS `empty =0`,
  MAX(IF((metric_name = "homelab_space_node_grade_e"), metric_value, NULL)) AS `e <=5`,
  MAX(IF((metric_name = "homelab_space_node_grade_d"), metric_value, NULL)) AS `d <=20`,
  MAX(IF((metric_name = "homelab_space_node_grade_c"), metric_value, NULL)) AS `c <=100`,
  MAX(IF((metric_name = "homelab_space_node_grade_b"), metric_value, NULL)) AS `b <=500`,
  MAX(IF((metric_name = "homelab_space_node_grade_a"), metric_value, NULL)) AS `a >500`,
  
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date)
```

### Homelab ARR by space node grade (discounted) (panel 111)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: (discounted from Jan 4 onwards)

```sql
SELECT
  timestamp(date(run_date)) as date,
  (MAX(IF((metric_name = "arr_homelab_grade_empty"), metric_value, NULL)) / MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL))) * 100 AS `empty`,
  (MAX(IF((metric_name = "arr_homelab_grade_e"), metric_value, NULL)) / MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL))) * 100 AS `e <= 5`,
  (MAX(IF((metric_name = "arr_homelab_grade_d"), metric_value, NULL)) / MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL))) * 100 AS `d <= 20`,
  (MAX(IF((metric_name = "arr_homelab_grade_c"), metric_value, NULL)) / MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL))) * 100 AS `c <= 100`,
  (MAX(IF((metric_name = "arr_homelab_grade_b"), metric_value, NULL)) / MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL))) * 100 AS `b <= 500`,
  (MAX(IF((metric_name = "arr_homelab_grade_a"), metric_value, NULL)) / MAX(IF((metric_name = "arr_homelab_discount"), metric_value, NULL))) * 100 AS `a > 500`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= DATE('${__from:date}')
GROUP BY
  run_date
```

### Homelab MRR by space node grade (discounted) (panel 115)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, (MAX(IF((metric_name = "mrr_homelab_grade_empty"), metric_value, NULL)) / MAX(IF((met from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  (MAX(IF((metric_name = "mrr_homelab_grade_empty"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL))) * 100 AS `empty`,
  (MAX(IF((metric_name = "mrr_homelab_grade_e"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL))) * 100 AS `e <= 5`,
  (MAX(IF((metric_name = "mrr_homelab_grade_d"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL))) * 100 AS `d <= 20`,
  (MAX(IF((metric_name = "mrr_homelab_grade_c"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL))) * 100 AS `c <= 100`,
  (MAX(IF((metric_name = "mrr_homelab_grade_b"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL))) * 100 AS `b <= 500`,
  (MAX(IF((metric_name = "mrr_homelab_grade_a"), metric_value, NULL)) / MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL))) * 100 AS `a > 500`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= DATE('${__from:date}')
GROUP BY
  run_date
```

### Subscription conversion percentages (panel 118)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, ( MAX( IF( (metric_name = "homelab_subs_coming_from_trial"), metric_value,  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  (
    MAX(
      IF(
        (metric_name = "homelab_subs_coming_from_trial"),
        metric_value,
        NULL
      )
    ) / 
    IF (
      MAX(
        IF(
          (metric_name = "total_homelab_subscriptions"),
          metric_value,
          NULL
        )
      ) =0,
      null,
      MAX(
        IF(
          (metric_name = "total_homelab_subscriptions"),
          metric_value,
          NULL
        )
      )
  )) * 100 AS `came from trial`,
  (
    MAX(
      IF(
        (metric_name = "homelab_subs_coming_from_free"),
        metric_value,
        NULL
      )
    ) / 
    IF (
      MAX(
        IF(
          (metric_name = "total_homelab_subscriptions"),
          metric_value,
          NULL
        )
      ) =0,
      null,
      MAX(
        IF(
          (metric_name = "total_homelab_subscriptions"),
          metric_value,
          NULL
        )
      )
  )) * 100 AS `came from free`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}')
  and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Homelab average nodes per subscription (panel 113)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, (MAX(IF(metric_name = "paid_nodes_homelab_annual", metric_value, NULL)) / M from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  (MAX(IF(metric_name = "paid_nodes_homelab_annual", metric_value, NULL)) / MAX(IF( metric_name = "total_homelab_subscriptions", metric_value, NULL))) AS `total`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Homelab MRR per Subscription (panel 17)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes *--,COALESCE(subscription_mrr_estimated_homelab,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_esti from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_homelab,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "mrr_homelab"), metric_value, NULL)) / MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL))  AS `average_mrr`,
  MAX(IF((metric_name = "mrr_homelab_discount"), metric_value, NULL)) / MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL))  AS `average_mrr_discount`,
  -- MAX(IF((metric_name = "mrr_pro"), metric_value, NULL)) AS `subscription_mrr_estimated_pro`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date)
```

### Space Activity Aging distribution (panel 31)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: As coming from watch_towers spaces, this shows how many spaces are in each inactivity bin

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "inactive_bin_90_count"), metric_value, NULL)) AS `last active 61-90d`,
  MAX(IF((metric_name = "inactive_bin_60_count"), metric_value, NULL)) AS `last active 31-60d`,
  MAX(IF((metric_name = "inactive_bin_30_count"), metric_value, NULL)) AS `last active 16-30d`,
  MAX(IF((metric_name = "inactive_bin_15_count"), metric_value, NULL)) AS `last active 8-15d`,
  MAX(IF((metric_name = "inactive_bin_7_count"), metric_value, NULL)) AS `last active 3-7d`,
  MAX(IF((metric_name = "inactive_bin_2_count"), metric_value, NULL)) AS `last active 2d`,
  MAX(IF((metric_name = "inactive_bin_1_count"), metric_value, NULL)) AS `last active 1d`,
  MAX(IF((metric_name = "inactive_bin_0_count"), metric_value, NULL)) AS `active today`,
  
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date)
```

### Space reachable node count grade distribution (panel 32)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_est from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "space_node_grade_a"), metric_value, NULL)) AS `a > 500`,
  MAX(IF((metric_name = "space_node_grade_b"), metric_value, NULL)) AS `b <= 500`,
  MAX(IF((metric_name = "space_node_grade_c"), metric_value, NULL)) AS `c <= 100`,
  MAX(IF((metric_name = "space_node_grade_d"), metric_value, NULL)) AS `d <= 20`,
  MAX(IF((metric_name = "space_node_grade_e"), metric_value, NULL)) AS `e <= 5`,
  MAX(IF((metric_name = "space_node_grade_empty"), metric_value, NULL)) AS `empty =0`,
  
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date)
```

### Average Discount per Plan (panel 155)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Sum of discounts per plan / total spaces on homelab

```sql
SELECT *--,COALESCE(subscription_mrr_estimated_business,0) + COALESCE(subscription_mrr_estimated_pro,0) as subscription_mrr_estimated_total,
FROM(SELECT
  timestamp(date(run_date)) as date,
  MAX(IF((metric_name = "discount_sum_homelab_annual_subs"), metric_value, NULL)) / MAX(IF((metric_name = "total_homelab_subscriptions"), metric_value, NULL)) AS `average discount`,
  -- MAX(IF((metric_name = "discount_sum_monthly_subs" or metric_name = "discount_sum_business_monthly_subs"), metric_value, NULL)) / MAX(IF((metric_name = "subscriptions_total_monthly" or metric_name = "monthly_business_subscriptions"), metric_value, NULL)) AS `monthly`,

  -- (MAX(IF((metric_name = "discount_sum_annual_subs" or metric_name = "discount_sum_business_annual_subs"), metric_value, NULL)) + MAX(IF((metric_name = "discount_sum_monthly_subs" or metric_name = "discount_sum_business_monthly_subs"), metric_value, NULL))) / MAX(IF((metric_name = "subscriptions_total" or metric_name = "total_business_subscriptions"), metric_value, NULL)) AS `total`,

FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date)
```

### Trial Subscription Counts Daily (panel 1)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Count of subscriptions by plan and if trial.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "trials_total", metric_value, NULL)) AS `trial_subscriptions`,
  -- MAX(IF(metric_name = "subscriptions_total", metric_value, NULL)) AS `subscriptions_business`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Trials Delta (Weekly Rolling Average) (panel 36)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: These numbers sum up to the delta of yesterday's trial count to today's trial count.

```sql
SELECT
  date,
  AVG(deleted) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as deleted_avg,
  AVG(upgraded_from_trial) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as upgraded_avg,
  AVG(trial_expired) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as expired_avg,
  AVG(new_trials) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as new_trials_avg,
  AVG(opt_outs) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as opt_outs_avg,
  AVG(delta) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as delta_avg
FROM
  (
    SELECT
      timestamp(date(run_date)) as date,
      run_date,
      MAX(IF(metric_name = "trial_spaces_deleted", -metric_value, NULL)) AS `deleted`,
      MAX(IF(metric_name = "trial_spaces_upgrade" or metric_name = "trial_spaces_upgrade_business", -metric_value, NULL)) AS `upgraded_from_trial`,
      MAX(IF(metric_name = "trial_spaces_trial_ended", -metric_value, NULL)) AS `trial_expired`,
      MAX(IF(metric_name = "trial_spaces_trial_new_spaces", metric_value, NULL)) AS `new_trials`,
      MAX(IF(metric_name = "trial_spaces_opt_out", -metric_value, NULL)) AS `opt_outs`,
      
      MAX(IF(metric_name = "trial_spaces_trial_new_spaces", metric_value, NULL)) -  MAX(IF(metric_name = "trial_spaces_deleted", metric_value, NULL)) -  MAX(IF(metric_name = "trial_spaces_opt_out", metric_value, NULL)) - MAX(IF(metric_name = "trial_spaces_upgrade" or metric_name = "trial_spaces_upgrade_business", metric_value, NULL)) -  MAX(IF(metric_name = "trial_spaces_trial_ended", metric_value, NULL)) AS `delta`,

    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
    GROUP BY
      run_date
  )
ORDER BY
  date;
```

### Trials Delta (Weekly Rolling Average) (panel 36)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: B
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: These numbers sum up to the delta of yesterday's trial count to today's trial count.

```sql
SELECT
      timestamp(date(run_date)) as date,
      run_date,
      MAX(IF(metric_name = "trial_spaces_deleted", -metric_value, NULL)) AS `deleted`,
      MAX(IF(metric_name = "trial_spaces_upgrade", -metric_value, NULL)) AS `upgraded_from_trial`,
      MAX(IF(metric_name = "trial_spaces_trial_ended", -metric_value, NULL)) AS `trial_expired`,
      MAX(IF(metric_name = "trial_spaces_trial_new_spaces", metric_value, NULL)) AS `new_trials`,
      MAX(IF(metric_name = "trial_spaces_opt_out", -metric_value, NULL)) AS `opt_outs`,
      
      MAX(IF(metric_name = "trial_spaces_trial_new_spaces", metric_value, NULL)) -  MAX(IF(metric_name = "trial_spaces_deleted", metric_value, NULL)) -  MAX(IF(metric_name = "trial_spaces_opt_out", metric_value, NULL)) - MAX(IF(metric_name = "trial_spaces_upgrade", metric_value, NULL)) -  MAX(IF(metric_name = "trial_spaces_trial_ended", metric_value, NULL)) AS `delta`,

    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
    GROUP BY
      run_date
```

### Trial Same day changes IMPORTANT (panel 37)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: These numbers are important, they are not counted up to the trial sum at the end of day, and some are huge wins while others are huge losses!

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "trial_spaces_created_and_deleted_yesterday", -metric_value, NULL)) AS `created_and_deleted_day_1`,
  MAX(IF(metric_name = "trial_spaces_created_and_opt_out_sameday", -metric_value, NULL)) AS `created_and_opt_out_sameday`,
  MAX(IF(metric_name = "trial_spaces_created_and_upgrade_sameday" or metric_name = "trial_spaces_created_and_upgrade_business_sameday", metric_value, NULL)) AS `created_and_upgrade_sameday`,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Trial spaces with >5 nodes (reachable + unreachable) (panel 27)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "trial_spaces_with_5plus_nodes"), metric_value, NULL) from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "trial_spaces_with_5plus_nodes"), metric_value, NULL)) AS `>=5 nodes spaces`,
  MAX(IF((metric_name = "trial_spaces_6_or_more_nodes"), metric_value, NULL)) AS `spaces`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Business spaces with >5 nodes (reachable + unreachable) (panel 62)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "paid_spaces_6_or_more_nodes" or metric_name = "busin from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "paid_spaces_6_or_more_nodes" or metric_name = "business_spaces_6_or_more_nodes"), metric_value, NULL)) AS `spaces`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Homelab spaces with >5 nodes (reachable + unreachable) (panel 119)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "homelab_spaces_6_or_more_nodes"), metric_value, NULL from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "homelab_spaces_6_or_more_nodes"), metric_value, NULL)) AS `spaces`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Free (Community2023.11) spaces with >5 nodes (reachable + unreachable) (panel 63)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "free_spaces_6_or_more_nodes"), metric_value, NULL))  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "free_spaces_6_or_more_nodes"), metric_value, NULL)) AS `spaces`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Trial spaces w/>5 nodes reachable nodes sum (panel 28)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "trial_5plus_nodes_reachable_sum"), metric_value, NUL from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "trial_5plus_nodes_reachable_sum"), metric_value, NULL)) AS `>=5 reachable_nodes`,
  MAX(IF((metric_name = "trial_6_or_more_nodes_reachable_sum"), metric_value, NULL)) AS `reachable_nodes`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Business spaces w/>5 nodes reachable nodes sum (panel 64)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "paid_6_or_more_nodes_reachable_sum" or metric_name = from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "paid_6_or_more_nodes_reachable_sum" or metric_name = "business_6_or_more_nodes_reachable_sum"), metric_value, NULL)) AS `reachable_nodes`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Homelab spaces w/>5 nodes reachable nodes sum (panel 120)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "homelab_6_or_more_nodes_reachable_sum"), metric_valu from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "homelab_6_or_more_nodes_reachable_sum"), metric_value, NULL)) AS `reachable_nodes`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Free (Community2023.11) spaces w/>5 nodes reachable nodes sum (panel 65)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, MAX(IF((metric_name = "free_6_or_more_nodes_reachable_sum"), metric_value,  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "free_6_or_more_nodes_reachable_sum"), metric_value, NULL)) AS `reachable_nodes`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Yesterday expiring trials, Outcome distribution (panel 45)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: This table presents trials that would end yesterday, and what the spaces did

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "trial_spaces_ended_yesterday_deleted", metric_value, NULL)) / (IF( MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 = 0 ,null ,MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 ))  AS `space deleted`,
  MAX(IF(metric_name = "trial_spaces_ended_yesterday_opt_out", metric_value, NULL)) / (IF( MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 = 0 ,null ,MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 )) AS `opted out`,
  MAX(IF(metric_name = "trial_spaces_ended_yesterday_upgrade" or metric_name = "trial_spaces_ended_yesterday_upgrade_business", metric_value, NULL)) / (IF( MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 = 0 ,null ,MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 )) AS `upgraded`,
  MAX(IF(metric_name = "trial_spaces_ended_yesterday_ended", metric_value, NULL)) / (IF( MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 = 0 ,null ,MAX(IF(metric_name = "trial_spaces_ended_yesterday_total", metric_value, NULL)) * 100 )) AS `trial expired`,

FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Lifetime Trial metrics (starting 1/1/24)) (panel 43)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, (upgraded_from_trial / (total - new_trials)) * 100 as upgraded, (deleted /  from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  timestamp(date(run_date)) as date,
  run_date,
  (upgraded_from_trial / (total - new_trials)) * 100 as upgraded,
  (deleted / (total - new_trials)) * 100 as deleted,
  (opt_outs / (total - new_trials)) * 100 as opted_out,
  -- (trial_expired / total) * 100 as trial_expired,
  -- (new_trials / total) * 100 as new_trials,
FROM(

SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "trial_spaces_deleted_lifetime_counter", metric_value, NULL)) AS `deleted`,
  MAX(IF(metric_name = "trial_spaces_opt_out_lifetime_counter", metric_value, NULL)) AS `opt_outs`,
  MAX(IF(metric_name = "trial_spaces_trial_ended_lifetime_counter", metric_value, NULL)) AS `trial_expired`,
  MAX(IF(metric_name = "trial_spaces_upgrade_lifetime_counter" or metric_name = "trial_spaces_upgrade_lifetime_counter_business", metric_value, NULL)) AS `upgraded_from_trial`,
  MAX(IF(metric_name = "trial_spaces_trial_new_spaces_lifetime_counter", metric_value, NULL)) AS `new_trials`,
  
  MAX(IF(metric_name = "trial_spaces_trial_new_spaces_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_upgrade_lifetime_counter" or metric_name = "trial_spaces_upgrade_lifetime_counter_business", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_trial_ended_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_opt_out_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_deleted_lifetime_counter", metric_value, NULL)) as `total`



FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
  )
```

### Lifetime Trial metrics (panel 61)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date, deleted as deleted, opt_outs as opted_out, upgraded_from_trial as upgraded, from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  timestamp(date(run_date)) as date,
  run_date,
  deleted as deleted,
  opt_outs as opted_out,
  upgraded_from_trial as upgraded,
  trial_expired as trial_expired,
  new_trials as new_trials,
  total
FROM(

SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF(metric_name = "trial_spaces_deleted_lifetime_counter", metric_value, NULL)) AS `deleted`,
  MAX(IF(metric_name = "trial_spaces_opt_out_lifetime_counter", metric_value, NULL)) AS `opt_outs`,
  MAX(IF(metric_name = "trial_spaces_trial_ended_lifetime_counter", metric_value, NULL)) AS `trial_expired`,
  MAX(IF(metric_name = "trial_spaces_upgrade_lifetime_counter", metric_value, NULL)) AS `upgraded_from_trial`,
  MAX(IF(metric_name = "trial_spaces_trial_new_spaces_lifetime_counter", metric_value, NULL)) AS `new_trials`,
  
  MAX(IF(metric_name = "trial_spaces_trial_new_spaces_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_upgrade_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_trial_ended_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_opt_out_lifetime_counter", metric_value, NULL)) +
  MAX(IF(metric_name = "trial_spaces_deleted_lifetime_counter", metric_value, NULL)) as `total`



FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
  )
```

### Latest Trial (Opt Out - Space Creation) date difference Histogram (panel 80)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: People that are on Community2023.11 and have plan_change = "Opt out of trial".

negative values are used to display people with null difference in the day, either we don't have the date they changed plans due to it being back in time before implementing the field or it is a same day action.

```sql
SELECT CURRENT_DATE() AS calculation_date,
ifnull(DATE_DIFF(date(bu_prev_sub_plan_date), date(au_created_at), DAY), -1) as metric_value,
"asat" AS metric_granularity,
FROM `netdata-analytics-bi.watch_towers.spaces_latest`
WHERE aw_sub_plan = "Community2023.11" and ba_plan_change = "Opt out of trial"
```

### Latest (Upgrade from trial - Space Creation) date difference Histogram (panel 81)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: People that are on Business and have plan_change = "Upgraded from Trial".

negative values are used to display people with null difference in the day, either we don't have the date they changed plans due to it being back in time before implementing the field or it is a same day action.

```sql
SELECT CURRENT_DATE() AS calculation_date,
ifnull(DATE_DIFF(date(bu_prev_sub_plan_date), date(au_created_at), DAY), -1) as metric_value,
"asat" AS metric_granularity,
FROM `netdata-analytics-bi.watch_towers.spaces_latest`
WHERE (aw_sub_plan = "Business" or aw_sub_plan = "Homelab") and ax_trial_ends_at IS NULL and (ba_plan_change = "Upgrade from trial to Business" or ba_plan_change = "Upgrade from trial to Homelab")
```

### Trial plan reachable node sum (panel 66)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time)) as date, date(run_time), MAX(trial_reachable_node_sum) as reachable_nodes from netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  timestamp(DATE(run_time)) as date,
  date(run_time),
  MAX(trial_reachable_node_sum) as reachable_nodes 
FROM `netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118` 
WHERE
  DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
GROUP BY
  run_time
UNION ALL
SELECT
  timestamp(date(run_date)) as date,
  run_date as run_time,
  MAX(IF(metric_name = "trial_reachable_node_sum", metric_value, NULL)) AS reachable_nodes,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
GROUP BY
  run_date
```

### Trial plan reachable node sum percent change over 30 days (panel 75)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time)) as date, value AS current_value, LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago, val from netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(DATE(run_time)) as date,
  value AS current_value,
  LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago,
  value - LAG(value, 30) OVER (ORDER BY date) AS change_from_30_days_ago,
  (value - LAG(value, 30) OVER (ORDER BY date)) / LAG(value, 30) OVER (ORDER BY date) * 100 AS percent_change_from_30_days_ago
FROM
  (  (
  -- SELECT 
  --   timestamp(DATE(run_time)) as date,
  --   date(run_time) as run_time_a,
  --   MAX(trial_reachable_node_sum) as value 
  -- FROM `netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118` 
  -- WHERE
  --   DATE(run_time) < DATE('2024-01-18') --and DATE(run_time) >= date('${__from:date}')
  -- GROUP BY
  --   run_time
  -- UNION ALL
  SELECT
    timestamp(date(run_date)) as date,
    run_date as run_time,
    MAX(IF(metric_name = "trial_reachable_node_sum", metric_value, NULL)) AS value,
  FROM
    `netdata-analytics-bi.metrics.metrics_daily`
  WHERE
    run_date <= DATE('${__to:date}') 
    -- and 
    -- run_date >= date('2024-01-18')
  GROUP BY
    run_date))
ORDER BY
  run_time
```

### Trial plan reachable nodes histogram (panel 71)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: This chart takes into consideration only people that have > 0 nodes.

```sql
-- SELECT
--   timestamp(date(run_date)) as date,
--   run_date as run_time,
--   MAX(IF(metric_name = "trial_reachable_node_sum_avg", metric_value, NULL)) AS average,
-- FROM
--   `netdata-analytics-bi.metrics.metrics_daily`
-- WHERE
--   run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
-- GROUP BY
--   run_date

-- SELECT CURRENT_DATE() AS calculation_date,
-- DATE('{{ ds }}') AS run_date,
-- DATE('{{ ds }}') AS metric_date,
-- "business_reachable_node_sum_avg" AS metric_name,
SELECT
ae_reachable_nodes AS metric_value,
-- "asat" AS metric_granularity,
FROM `netdata-analytics-bi.watch_towers.spaces_latest`
WHERE ax_trial_ends_at is NOT NULL
and ce_plan_class = "Business"
and ae_reachable_nodes > 0
```

### Trial plan reachable nodes histogram >5 (panel 207)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: This chart takes into consideration only people that have > 5 nodes.

```sql
-- SELECT
--   timestamp(date(run_date)) as date,
--   run_date as run_time,
--   MAX(IF(metric_name = "trial_reachable_node_sum_avg", metric_value, NULL)) AS average,
-- FROM
--   `netdata-analytics-bi.metrics.metrics_daily`
-- WHERE
--   run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
-- GROUP BY
--   run_date

-- SELECT CURRENT_DATE() AS calculation_date,
-- DATE('{{ ds }}') AS run_date,
-- DATE('{{ ds }}') AS metric_date,
-- "business_reachable_node_sum_avg" AS metric_name,
SELECT
ae_reachable_nodes AS metric_value,
-- "asat" AS metric_granularity,
FROM `netdata-analytics-bi.watch_towers.spaces_latest`
WHERE ax_trial_ends_at is NOT NULL
and ce_plan_class = "Business"
and ae_reachable_nodes > 5
```

### Community2311 plan reachable node sum (panel 69)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time)) as date, date(run_time), MAX(metric_value) as reachable_nodes from netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  timestamp(DATE(run_time)) as date,
  date(run_time), 
  MAX(metric_value) as reachable_nodes 
FROM `netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118` 
WHERE
  DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
GROUP BY
  run_time
UNION ALL
SELECT
  timestamp(date(run_date)) as date,
  run_date as run_time,
  MAX(IF(metric_name = "community2311_reachable_node_sum", metric_value, NULL)) AS reachable_nodes,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
GROUP BY
  run_date
```

### Community2311 reachable node sum percent change over 30 days (panel 77)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time_a)) as date, value AS current_value, LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago, v from netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(DATE(run_time_a)) as date,
  value AS current_value,
  LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago,
  value - LAG(value, 30) OVER (ORDER BY date) AS change_from_30_days_ago,
  (value - LAG(value, 30) OVER (ORDER BY date)) / LAG(value, 30) OVER (ORDER BY date) * 100 AS percent_change_from_30_days_ago
FROM
  (  (
    -- SELECT 
    --   timestamp(DATE(run_time)) as date,
    --   date(run_time) as run_time_a, 
    --   MAX(metric_value) as value 
    -- FROM `netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118` 
    -- WHERE
    --   DATE(run_time) < DATE('2024-01-18') --and DATE(run_time) >= date('${__from:date}')
    -- GROUP BY
    --   run_time
    -- UNION ALL
    SELECT
      timestamp(date(run_date)) as date,
      run_date as run_time_a,
      MAX(IF(metric_name = "community2311_reachable_node_sum", metric_value, NULL)) AS value,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}') 
      --and 
      --run_date >= date('2024-01-18')
    GROUP BY
      run_date
    ))
ORDER BY
  run_time_a
```

### Community2311 plan reachable nodes histogram (panel 73)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: This chart takes into consideration only people that have > 0 nodes.

```sql
-- SELECT 
--   timestamp(DATE(run_time)) as date,
--   date(run_time), 
--   MAX(metric_value) as reachable_nodes 
-- FROM `netdata-analytics-bi.watch_towers.community2311_reachable_node_sum_unitl_0118` 
-- WHERE
--   DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
-- GROUP BY
--   run_time
-- UNION ALL

-- SELECT
--   timestamp(date(run_date)) as date,
--   run_date as run_time,
--   MAX(IF(metric_name = "community2311_reachable_node_sum_avg", metric_value, NULL)) AS average,
-- FROM
--   `netdata-analytics-bi.metrics.metrics_daily`
-- WHERE
--   run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
-- GROUP BY
--   run_date

SELECT CURRENT_DATE() AS calculation_date,
-- DATE('{{ ds }}') AS run_date,
-- DATE('{{ ds }}') AS metric_date,
-- "business_reachable_node_sum_avg" AS metric_name,
ae_reachable_nodes AS metric_value,
"asat" AS metric_granularity,
FROM `netdata-analytics-bi.watch_towers.spaces_latest`
WHERE ax_trial_ends_at is NULL
and aw_sub_plan = "Community2023.11"
and ae_reachable_nodes > 0
```

### Business plan reachable node sum (panel 70)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time)) as date, date(run_time), MAX(metric_value) as reachable_nodes from netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  timestamp(DATE(run_time)) as date,
  date(run_time), 
  MAX(metric_value) as reachable_nodes 
FROM `netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118` 
WHERE
  DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
GROUP BY
  run_time
UNION ALL
SELECT
  timestamp(date(run_date)) as date,
  run_date as run_time,
  MAX(IF(metric_name = "business_reachable_node_sum", metric_value, NULL)) AS reachable_nodes,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
GROUP BY
  run_date
```

### Business reachable node sum percent change over 30 days (panel 78)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time_a)) as date, value AS current_value, LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago, v from netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(DATE(run_time_a)) as date,
  value AS current_value,
  LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago,
  value - LAG(value, 30) OVER (ORDER BY date) AS change_from_30_days_ago,
  (value - LAG(value, 30) OVER (ORDER BY date)) / LAG(value, 30) OVER (ORDER BY date) * 100 AS percent_change_from_30_days_ago
FROM
  (  (
    -- SELECT 
    --   timestamp(DATE(run_time)) as date,
    --   date(run_time) as run_time_a, 
    --   MAX(metric_value) as value 
    -- FROM `netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118` 
    -- WHERE
    --   DATE(run_time) < DATE('2024-01-18') --and DATE(run_time) >= date('${__from:date}')
    -- GROUP BY
    --   run_time
    -- UNION ALL
    SELECT
      timestamp(date(run_date)) as date,
      run_date as run_time_a,
      MAX(IF(metric_name = "business_reachable_node_sum", metric_value, NULL)) AS value,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}')
      -- and 
      -- run_date >= date('2024-01-18')
    GROUP BY
      run_date
    ))
ORDER BY
  run_time_a
```

### Business plan reachable nodes histogram (panel 74)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: This chart takes into consideration only people that have > 0 nodes.

```sql
-- SELECT 
--   timestamp(DATE(run_time)) as date,
--   date(run_time), 
--   MAX(metric_value) as reachable_nodes 
-- FROM `netdata-analytics-bi.watch_towers.business_reachable_node_sum_until_0118` 
-- WHERE
--   DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
-- GROUP BY
--   run_time
-- UNION ALL


-- SELECT
--   timestamp(date(run_date)) as date,
--   run_date as run_time,
--   MAX(IF(metric_name = "business_reachable_node_sum_avg", metric_value, NULL)) AS average,
-- FROM
--   `netdata-analytics-bi.metrics.metrics_daily`
-- WHERE
--   run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
-- GROUP BY
--   run_date


  SELECT 
  -- CURRENT_DATE() AS calculation_date,
    -- DATE('{{ ds }}') AS run_date,
    -- DATE('{{ ds }}') AS metric_date,
    -- "business_reachable_node_sum_avg" AS metric_name,
    ae_reachable_nodes AS metric_value,
    -- "asat" AS metric_granularity,
    FROM `netdata-analytics-bi.watch_towers.spaces_latest`
  WHERE ax_trial_ends_at is NULL
    and ce_plan_class = "Business"
    and ae_reachable_nodes > 0
```

### Homelab plan reachable node sum (panel 121)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(date(run_date)) as date, run_date as run_time, MAX(IF(metric_name = "homelab_reachable_node_sum", metric_value from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date as run_time,
  MAX(IF(metric_name = "homelab_reachable_node_sum", metric_value, NULL)) AS reachable_nodes,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
GROUP BY
  run_date
```

### Homelab reachable node sum percent change over 30 days (panel 122)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time_a)) as date, value AS current_value, LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago, v from netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT
  timestamp(DATE(run_time_a)) as date,
  value AS current_value,
  LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago,
  value - LAG(value, 30) OVER (ORDER BY date) AS change_from_30_days_ago,
  (value - LAG(value, 30) OVER (ORDER BY date)) / LAG(value, 30) OVER (ORDER BY date) * 100 AS percent_change_from_30_days_ago
FROM
  (  (
    SELECT
      timestamp(date(run_date)) as date,
      run_date as run_time_a,
      MAX(IF(metric_name = "homelab_reachable_node_sum", metric_value, NULL)) AS value,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      run_date <= DATE('${__to:date}')
    GROUP BY
      run_date
    ))
ORDER BY
  run_time_a
```

### Homelab plan reachable nodes histogram (panel 123)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: This chart takes into consideration only people that have > 0 nodes.

```sql
SELECT 
    -- CURRENT_DATE() AS calculation_date,
    ae_reachable_nodes AS metric_value,
    -- "asat" AS metric_granularity,
    FROM `netdata-analytics-bi.watch_towers.spaces_latest`
  WHERE ax_trial_ends_at is NULL
    and ce_plan_class = "Homelab"
    and ae_reachable_nodes > 0
```

### [PLANS SUNSET] Community and Early Bird plan reachable node sum (panel 68)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.community_and_early_bird_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Computes timestamp(DATE(run_time)) as date, date(run_time), MAX(metric_value) as reachable_nodes from netdata-analytics-bi.watch_towers.community_and_early_bird_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily.

```sql
SELECT 
  timestamp(DATE(run_time)) as date,
  date(run_time), 
  MAX(metric_value) as reachable_nodes 
FROM `netdata-analytics-bi.watch_towers.community_and_early_bird_reachable_node_sum_until_0118` 
WHERE
  DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
GROUP BY
  run_time
UNION ALL
SELECT
  timestamp(date(run_date)) as date,
  run_date as run_time,
  MAX(IF(metric_name = "comm_earlyb_reachable_node_sum", metric_value, NULL)) AS reachable_nodes,
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
GROUP BY
  run_date
```

### [PLANS SUNSET] Community and Early bird reachable node sum percent change over 30 days (panel 76)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.community_and_early_bird_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118
- Interpretation: Computes timestamp(DATE(run_time_a)) as date, value AS current_value, LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago, v from netdata-analytics-bi.watch_towers.community_and_early_bird_reachable_node_sum_until_0118, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118.

```sql
SELECT
  timestamp(DATE(run_time_a)) as date,
  value AS current_value,
  LAG(value, 30) OVER (ORDER BY date) AS value_30_days_ago,
  value - LAG(value, 30) OVER (ORDER BY date) AS change_from_30_days_ago,
  (value - LAG(value, 30) OVER (ORDER BY date)) / LAG(value, 30) OVER (ORDER BY date) * 100 AS percent_change_from_30_days_ago
FROM
  (  (
    SELECT 
      timestamp(DATE(run_time)) as date,
      date(run_time) as run_time_a, 
      MAX(metric_value) as value 
    FROM `netdata-analytics-bi.watch_towers.community_and_early_bird_reachable_node_sum_until_0118` 
    WHERE
      DATE(run_time) < DATE('2024-01-18') --and DATE(run_time) >= date('${__from:date}')
    GROUP BY
      run_time
    UNION ALL
    SELECT
      timestamp(date(run_date)) as date,
      run_date as run_time_a,
      MAX(IF(metric_name = "comm_earlyb_reachable_node_sum", metric_value, NULL)) AS value,
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE
      --run_date <= DATE('${__to:date}') and 
      run_date >= date('2024-01-18')
    GROUP BY
      run_date













    
  -- SELECT 
  --   timestamp(DATE(run_time)) as date,
  --   date(run_time) as run_time_a,
  --   MAX(trial_reachable_node_sum) as value 
  -- FROM `netdata-analytics-bi.watch_towers.trial_reachable_node_sum_until_0118` 
  -- WHERE
  --   DATE(run_time) < DATE('2024-01-18') and DATE(run_time) >= date('${__from:date}')
  -- GROUP BY
  --   run_time
  -- UNION ALL
  -- SELECT
  --   timestamp(date(run_date)) as date,
  --   run_date as run_time,
  --   MAX(IF(metric_name = "trial_reachable_node_sum", metric_value, NULL)) AS value,
  -- FROM
  --   `netdata-analytics-bi.metrics.metrics_daily`
  -- WHERE
  --   run_date <= DATE('${__to:date}') and run_date >= date('2024-01-18')
  -- GROUP BY
  --   run_date)
    ))
ORDER BY
  run_time_a
```

### [PLANS SUNSET] Community and Early Bird plan reachable nodes histogram (panel 72)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: This chart takes into consideration only people that have > 0 nodes.

```sql
-- SELECT
--   timestamp(date(run_date)) as date,
--   run_date as run_time,
--   MAX(IF(metric_name = "comm_earlyb_reachable_node_sum_avg", metric_value, NULL)) AS average,
-- FROM
--   `netdata-analytics-bi.metrics.metrics_daily`
-- WHERE
--   run_date <= DATE('${__to:date}') and run_date >= DATE('${__from:date}')
-- GROUP BY
--   run_date


  SELECT CURRENT_DATE() AS calculation_date,
    -- DATE('{{ ds }}') AS run_date,
    -- DATE('{{ ds }}') AS metric_date,
    -- "business_reachable_node_sum_avg" AS metric_name,
    ae_reachable_nodes AS metric_value,
    "asat" AS metric_granularity,
    FROM `netdata-analytics-bi.watch_towers.spaces_latest`
  WHERE ax_trial_ends_at is NULL and (aw_sub_plan = "Community" or aw_sub_plan = "EarlyBird") and
     ae_reachable_nodes > 0
```

### $ Cloud Subscription ARR + ON PREM by space node grade (discounted) (panel 172)
- Type: barchart
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.watch_towers.manual_360_bq
- Interpretation: (discounted from Jan 4 onwards)

```sql
SELECT
  on_prem_date as date,
  (business_empty + onprem_empty)  as `empty`,
  (business_e + onprem_e)  as `e <= 5`,
  (business_d + onprem_d)  as `d <= 20`,
  (business_c + onprem_c)  as `c <= 100`,
  (business_b + onprem_b)  as `b <= 500`,
  (business_a + onprem_a)  as `a > 500`,
FROM
  (
    SELECT
      timestamp(date(run_date)) as business_date,
      MAX(IF((metric_name = "arr_business_grade_empty"),metric_value,NULL)) AS business_empty,
      MAX(IF((metric_name = "arr_business_grade_e"),metric_value,NULL)) AS business_e,
      MAX(IF((metric_name = "arr_business_grade_d"),metric_value,NULL)) AS business_d,
      MAX(IF((metric_name = "arr_business_grade_c"),metric_value,NULL)) AS business_c,
      MAX(IF((metric_name = "arr_business_grade_b"),metric_value,NULL)) AS business_b,
      MAX(IF((metric_name = "arr_business_grade_a"),metric_value,NULL)) AS business_a,
      MAX(IF((metric_name = "arr_business_discount"),metric_value,NULL)) as business_arr_total
    FROM
      `netdata-analytics-bi.metrics.metrics_daily`
    WHERE run_date < CURRENT_DATE()
    GROUP BY timestamp(date(run_date))
  )
LEFT JOIN (
    Select
      on_prem_date,
      sum(IF(grade = "EMPTY", annual_price, 0)) OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_empty,
      sum(IF(grade = "E", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_e,
      sum(IF(grade = "D", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_d,
      sum(IF(grade = "C", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_c,
      sum(IF(grade = "B", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_b,
      sum(IF(grade = "A", annual_price, 0))  OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS onprem_a,
      sum(annual_price) OVER (ORDER BY on_prem_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as on_prem_total
    FROM
        (
          SELECT
            timestamp(date) as on_prem_date
          FROM
            UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2024-12-12")) AS date
        ) d
        LEFT JOIN (
          SELECT
            timestamp(date(start_date)) as sheet_date,
            annual_price,
            CASE
              WHEN current_node_count > 0
              and current_node_count <= 5 THEN "E"
              WHEN current_node_count > 0
              and current_node_count <= 20 THEN "D"
              WHEN current_node_count > 0
              and current_node_count <= 100 THEN "C"
              WHEN current_node_count > 0
              and current_node_count <= 500 THEN "B"
              WHEN current_node_count > 500 THEN "A"
              ELSE "EMPTY"
            END as grade,
          FROM
            `netdata-analytics-bi.watch_towers.manual_360_bq`
          WHERE
            plan_type = "on-prem" -- GROUP BY
            --   date,grade
        ) a on a.sheet_date = d.on_prem_date
    GROUP BY
      on_prem_date,
      grade,
      annual_price
    ) a on business_date = a.on_prem_date
  -- WHERE
  --     on_prem_date <= DATE('${__to:date}')
  --     and run_date >= date('${__from:date}')
  --     and run_date < CURRENT_DATE()
    -- GROUP BY
    --   on_prem_date)
WHERE
  date(on_prem_date) < CURRENT_DATE()
  and  date(on_prem_date) >= date('${__from:date}') and date(on_prem_date) <= DATE('${__to:date}')
-- GROUP BY on_prem_date
ORDER BY on_prem_date
```

### Paid Space Age Histogram (panel 19)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_latest, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes -- space_created_days_ago as space_age_days -- from netdata-analytics-bi.data360.space360_latest, netdata-analytics-bi.watch_towers.spaces_latest.

```sql
-- select
--   space_created_days_ago as space_age_days
-- from
--   `netdata-analytics-bi.data360.space360_latest`
-- where
--   has_paid_subscription = 1

SELECT 
DATE_DIFF(CURRENT_DATE(),DATE(au_created_at), DAY) as age
FROM 
`netdata-analytics-bi.watch_towers.spaces_latest`
WHERE
(aw_sub_plan LIKE "Business" or aw_sub_plan LIKE "Pro") and ax_trial_ends_at IS NULL
```

### Early opt-out count from Active spaces (panel 29)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Active spaces are spaces that are active + spaces with <=30 days if inactivity

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "total_active_trial_opt_outs"), metric_value, NULL)) AS `opt_outs`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Un-discounted ARR (panel 52)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date, `total ARR undiscounted`, -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) AS from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
SELECT 
  date,
  
  `total ARR undiscounted`,
 -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) AS change_over_7_days,
 -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 30) OVER (ORDER BY date)) AS change_over_30_days,
 -- (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 90) OVER (ORDER BY date)) AS change_over_90_days,
  

FROM
  (WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR undiscounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR undiscounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR undiscounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR undiscounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR undiscounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR undiscounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
)
ORDER BY date ASC
```

### (untitled panel) (panel 138)
- Type: stat
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date, -- `total ARR undiscounted`, (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) AS from netdata-analytics-bi.watch_towers.arr_forecast, netdata-analytics-bi.watch_towers.manual_360_bq, netdata-analytics-bi.metrics.metrics_daily, netdata-analytics-bi.data360.space360_daily.

```sql
SELECT 
  date,
  
--   `total ARR undiscounted`,
 (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 7) OVER (ORDER BY date)) AS last_7_days,
 (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 30) OVER (ORDER BY date)) AS last_30_days,
 (`total ARR undiscounted` - LAG(`total ARR undiscounted`, 90) OVER (ORDER BY date)) AS last_90_days,
  

FROM
  (WITH main_timeseries AS (
  Select
    d.date,
    `Target_ARR__2_8M__`,
    `Target_ARR__1M__`,
    `total ARR undiscounted`,
  from
    (SELECT
      timestamp(date) as date
    FROM
      UNNEST(GENERATE_DATE_ARRAY('2023-01-01', "2028-12-12")) AS date) d
  LEFT JOIN
  (SELECT
      Date as date,
      Target_ARR__2_8M__,
      Target_ARR__1M__
    FROM
      `netdata-analytics-bi.watch_towers.arr_forecast`

  ) a ON d.date = a.date
  LEFT JOIN (
    SELECT
      *
    FROM
      (
        SELECT
          timestamp(date(run_date)) as date,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) AS `total ARR`,
          MAX(
            IF(
              (metric_name = "arr_business"),
              metric_value,
              NULL
            )
          ) + COALESCE(
            MAX(
              IF(
                (metric_name = "arr_homelab"),
                metric_value,
                NULL
              )
            ),
            0
          ) -- + (SELECT SUM(annual_price) FROM `netdata-analytics-bi.watch_towers.manual_360_bq`) 
          AS `total ARR undiscounted`,
        FROM
          `netdata-analytics-bi.metrics.metrics_daily`
        WHERE
          run_date > DATE("2023-11-28")
          -- and run_date <= date('${__to:date}')
          and run_date < CURRENT_DATE()
        GROUP BY
          run_date
      )
    UNION
    ALL
    select
      timestamp(date(_partitiontime)) as date,
      12 * sum(
        if(
          has_subscription_business = 1,
          subscription_mrr_estimated,
          0
        )
      ) as `total ARR`,
      -- null AS `monthly subs ARR`,
      -- null AS `annual subs ARR`,
      0 AS `total ARR undiscounted`
    from
      `netdata-analytics-bi.data360.space360_daily`
    where
      -- date(_partitiontime) >= date('${__from:date}')and 
      date(_partitiontime) <= date('2023-11-28')
      and (
        has_subscription = 1
        and subscription_trial_ends_at IS NULL
      )
    group by
      1

  ) b on a.date = b.date 
),
spikes AS (
  -- Replace with your actual spikes query
  SELECT
      timestamp(date(start_date)) as date,
      IF (sum(annual_price) > 0, sum(annual_price), 0) AS `total ARR on-prem`,

    FROM
      `netdata-analytics-bi.watch_towers.manual_360_bq`
    GROUP BY
      date
),
combined AS (
  -- Combine the main timeseries with the spikes, filling missing dates
  SELECT
    m.date,
    m.`total ARR undiscounted`,
    COALESCE(s.`total ARR on-prem`, 0) AS spike_value,
    m.`Target_ARR__2_8M__`,
    m.`Target_ARR__1M__`,
  FROM
    main_timeseries m
  LEFT JOIN
    spikes s
  ON
    m.date = s.date
)
SELECT
  date,
  `total ARR undiscounted` + SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS `total ARR undiscounted`,
  -- SUM(spike_value) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
  `Target_ARR__2_8M__`,
  `Target_ARR__1M__`,
FROM
  combined
WHERE
  date is not null
ORDER BY
  date
)
ORDER BY date ASC
```

### Subscription Space Node Counts Daily (panel 4)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Sum of nodes by subscription plan type.

```sql
select
  timestamp(date(_partitiontime)) as date,
  /*
  sum(committed_nodes) as committed_nodes,
  sum(if(has_subscription_community=1,committed_nodes,null)) as committed_nodes_community,
  sum(if(has_subscription_pro=1,committed_nodes,null)) as committed_nodes_pro,
  sum(if(has_subscription_business=1,committed_nodes,null)) as committed_nodes_business,
  */
  /* sum(node_count) as node_count, */
  /* sum(if(has_subscription_community=1,node_count,null)) as node_count_community, */
  sum(if(has_subscription_pro=1,node_count_is_reachable,null)) as node_count_pro,
  sum(if((has_subscription_business=1 and subscription_trial_ends_at IS NULL),node_count_is_reachable,null)) as node_count_business,
  sum(if(has_subscription_pro=1,node_count,null)) + sum(if(has_subscription_business=1,node_count_is_reachable,null)) as node_count_total,
  sum(if((has_trial_subscription=1 or ( has_subscription_business=1  and subscription_trial_ends_at IS NOT NULL )),node_count_is_reachable,0)) as node_count_trial,
  /*
  sum(node_count_is_reachable) as node_reachable_count,
  sum(if(has_subscription_community=1,node_count_is_reachable,null)) as node_reachable_count_community,
  sum(if(has_subscription_pro=1,node_count_is_reachable,null)) as node_reachable_count_pro,
  sum(if(has_subscription_business=1,node_count_is_reachable,null)) as node_reachable_count_business,
  */
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
  and
  has_subscription = 1
group by 1
```

### % Paid Nodes (Of Reachable) (panel 9)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, sum(subscription_paid_nodes) / sum(node_count_is_reachable) as paid_nodes_pct, from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  sum(subscription_paid_nodes) / sum(node_count_is_reachable) as paid_nodes_pct,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1
```

### Percentage of Active trial Spaces that opted-out (panel 30)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.metrics.metrics_daily
- Interpretation: Active spaces are spaces that are active + spaces with <=30 days if inactivity

```sql
SELECT
  timestamp(date(run_date)) as date,
  run_date,
  MAX(IF((metric_name = "percentage_active_trial_opt_outs"), metric_value, NULL)) AS `percent`
FROM
  `netdata-analytics-bi.metrics.metrics_daily`
WHERE
  run_date <= DATE('${__to:date}') and run_date >= date('${__from:date}')
GROUP BY
  run_date
```

### Subscription Committed Node Counts (Annual Plan) (panel 3)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Sum of committed nodes by plan type.

```sql
select
  timestamp(date(_partitiontime)) as date,
  sum(committed_nodes) as total_committed_nodes,
  /*sum(if(has_subscription_community=1,committed_nodes,null)) as committed_nodes_community,*/
 -- sum(if(has_subscription_pro=1,committed_nodes,null)) as committed_nodes_pro,
  --sum(if(has_subscription_business=1,committed_nodes,null)) as committed_nodes_business,
  /*
  sum(node_count) as node_count,
  sum(if(has_subscription_community=1,node_count,null)) as node_count_community,
  sum(if(has_subscription_pro=1,node_count,null)) as node_count_pro,
  sum(if(has_subscription_business=1,node_count,null)) as node_count_business,
  sum(node_count_is_reachable) as node_reachable_count,
  sum(if(has_subscription_community=1,node_count_is_reachable,null)) as node_reachable_count_community,
  sum(if(has_subscription_pro=1,node_count_is_reachable,null)) as node_reachable_count_pro,
  sum(if(has_subscription_business=1,node_count_is_reachable,null)) as node_reachable_count_business,
  */
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
  and
  has_subscription = 1
group by 1
```

### Paid Nodes (Commited & Non Committed) (panel 10)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, sum(subscription_paid_nodes) as paid_nodes, sum(subscription_paid_nodes_committ from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  sum(subscription_paid_nodes) as paid_nodes,
  sum(subscription_paid_nodes_committed) as paid_nodes_committed,
  sum(subscription_paid_nodes_noncommitted) as paid_nodes_noncommitted,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
  and
  (has_subscription = 1 and subscription_trial_ends_at IS NULL)
group by 1
```

### Paid Nodes (panel 8)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, sum(subscription_paid_nodes) as paid_nodes, sum(if(has_subscription_pro=1,subsc from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  sum(subscription_paid_nodes) as paid_nodes,
  sum(if(has_subscription_pro=1,subscription_paid_nodes,0)) as paid_nodes_pro,
  sum(if(has_subscription_business=1,subscription_paid_nodes,0)) as paid_nodes_business,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
  and
  (has_subscription = 1 and subscription_trial_ends_at IS NULL)
group by 1
```

### Subscription Space Node Reachable Counts Daily (panel 5)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Sum of reachable nodes for spaces with subscriptions by plan type.

```sql
select
  timestamp(date(_partitiontime)) as date,
  /*
  sum(committed_nodes) as committed_nodes,
  sum(if(has_subscription_community=1,committed_nodes,null)) as committed_nodes_community,
  sum(if(has_subscription_pro=1,committed_nodes,null)) as committed_nodes_pro,
  sum(if(has_subscription_business=1,committed_nodes,null)) as committed_nodes_business,
  sum(node_count) as node_count,
  sum(if(has_subscription_community=1,node_count,null)) as node_count_community,
  sum(if(has_subscription_pro=1,node_count,null)) as node_count_pro,
  sum(if(has_subscription_business=1,node_count,null)) as node_count_business,
  */
  sum(node_count_is_reachable) as node_reachable_count,
  sum(if(has_subscription_community=1,node_count_is_reachable,null)) as node_reachable_count_churned,
  sum(if(has_subscription_pro=1,node_count_is_reachable,null)) as node_reachable_count_pro,
  sum(if((has_subscription_business=1 and subscription_trial_ends_at IS NULL),node_count_is_reachable,null)) as node_reachable_count_business,
  sum(if((has_trial_subscription=1 or ( has_subscription_business=1  and subscription_trial_ends_at IS NOT NULL )),node_count_is_reachable,0)) as node_reachable_count_trial,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
  and
  has_subscription = 1
group by 1
```

### Paid Space Node Reachable Histogram (panel 20)
- Type: histogram
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_latest, netdata-analytics-bi.watch_towers.spaces_latest
- Interpretation: Computes -- node_count_is_reachable -- from netdata-analytics-bi.data360.space360_latest, netdata-analytics-bi.watch_towers.spaces_latest.

```sql
-- select
--   node_count_is_reachable
-- from
--   `netdata-analytics-bi.data360.space360_latest`
-- where
--   has_paid_subscription = 1 and subscription_trial_ends_at IS NULL


SELECT 
ae_reachable_nodes as reachable_nodes
FROM 
`netdata-analytics-bi.watch_towers.spaces_latest`
WHERE
(aw_sub_plan LIKE "Business" or aw_sub_plan LIKE "Pro") and ax_trial_ends_at IS NULL
```

### Node Counts (Reachable) (panel 12)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, sum(node_count_is_reachable) as reachable, --sum(if(has_paid_subscription=1,nod from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  sum(node_count_is_reachable) as reachable,
  --sum(if(has_paid_subscription=1,node_count_is_reachable,0)) as paid,
  --sum(if(has_trial_subscription=1,node_count_is_reachable,0)) as trial,
  --sum(if(has_paid_subscription=1 and has_subscription_pro=1,node_count_is_reachable,0)) as pro,
  --sum(if(has_paid_subscription=1 and has_subscription_business=1,node_count_is_reachable,0)) as business,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1
```

### Node Counts (Paid & Trial) (panel 13)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, --sum(node_count_is_reachable) as reachable, sum(if(has_paid_subscription=1,nod from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  --sum(node_count_is_reachable) as reachable,
  sum(if(has_paid_subscription=1,node_count_is_reachable,0)) as paid,
  --sum(if(has_trial_subscription=1,node_count_is_reachable,0)) as trial,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1,node_count_is_reachable,0)) as pro,
  sum(if(has_paid_subscription=1 and has_subscription_business=1,node_count_is_reachable,0)) as business,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1
```

### Space Counts (panel 15)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, count(distinct space_id) as spaces, count(distinct space_group_id) as space_gro from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  count(distinct space_id) as spaces,
  count(distinct space_group_id) as space_groups,
  --count(distinct if(active_space=1,space_id,null)) as spaces,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1
```

### Space Status (panel 16)
- Type: timeseries
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes timestamp(date(_partitiontime)) as date, count(distinct if(space_status='inactive',space_id,null)) as inactive, count(di from netdata-analytics-bi.data360.space360_daily.

```sql
select
  timestamp(date(_partitiontime)) as date,
  count(distinct if(space_status='inactive',space_id,null)) as inactive,
  count(distinct if(space_status='test',space_id,null)) as test,
  count(distinct if(space_status='empty',space_id,null)) as empty,
  count(distinct if(space_status='active',space_id,null)) as active,
  count(distinct if(space_status='churned',space_id,null)) as churned,
  count(distinct if(space_status='paid',space_id,null)) as paid,
  count(distinct if(space_status='trial',space_id,null)) as trial,
  count(distinct if(space_status='spam',space_id,null)) as spam,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}')
  /*
  -- if you wanted to just look at spaces by age
  and
  space_age_days <= 90
  */
group by 1
```

### Space Flows (panel 24)
- Type: table
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.data360.space360_daily_deleted
- Interpretation: Computes date(_partitiontime) as date, -- early sum(if(lower(plan_clean)='earlybird',1,0)) as earlybird, sum(if(lower(plan_clean) from netdata-analytics-bi.data360.space360_daily, netdata-analytics-bi.data360.space360_daily_deleted.

```sql
with

space_counts as 
(
select
  date(_partitiontime) as date,
  
  -- early
  sum(if(lower(plan_clean)='earlybird',1,0)) 
  as earlybird,
  sum(if(lower(plan_clean)='earlybird' and lower(plan_clean_yesterday)!='earlybird',1,0)) 
  as earlybird_new,
  sum(if(lower(plan_clean)!='earlybird' and lower(plan_clean_yesterday)='earlybird',1,0)) 
  as earlybird_lost,

  -- community
  sum(if(lower(plan_clean)='community',1,0)) 
  as community,
  sum(if(lower(plan_clean)='community' and lower(plan_clean_yesterday)!='community',1,0)) 
  as community_new,
  sum(if(lower(plan_clean)!='community' and lower(plan_clean_yesterday)='community',1,0)) 
  as community_lost,

  -- pro
  sum(if(lower(plan_clean)='pro',1,0)) 
  as pro,
  sum(if(lower(plan_clean)='pro' and lower(plan_clean_yesterday)!='pro',1,0)) 
  as pro_new,
  sum(if(lower(plan_clean)!='pro' and lower(plan_clean_yesterday)='pro',1,0)) 
  as pro_lost,

  -- business
  sum(if(lower(plan_clean)='business' and subscription_trial_ends_at IS NULL,1,0)) 
  as business,
  sum(if(lower(plan_clean)='business' and lower(plan_clean_yesterday)!='business' and subscription_trial_ends_at IS NULL,1,0)) 
  as business_new,
  sum(if(lower(plan_clean)!='business' and lower(plan_clean_yesterday)='business' and subscription_trial_ends_at IS NULL,1,0)) 
  as business_lost,

  -- attempt of trials by Fotis
  sum(if(lower(plan_clean)='business' and subscription_trial_ends_at IS NOT NULL,1,0)) 
  as trial,
  sum(if(lower(plan_clean)='business' and lower(plan_clean_yesterday)!='business' and subscription_trial_ends_at IS NOT NULL,1,0)) 
  as trial_new,
  --can't do lost at the moment
  -- sum(if(lower(plan_clean)!='business' and lower(plan_clean_yesterday)='business' and subscription_trial_ends_at IS NULL,1,0)) 
  -- as business_lost,
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1 
),

space_deletes as
(
select
  date(_partitiontime) as date,
  
  sum(if(lower(plan_clean)='earlybird',1,0)) as earlybird_deleted,
  sum(if(lower(plan_clean)='community',1,0)) as community_deleted,
  sum(if(lower(plan_clean)='pro',1,0)) as pro_deleted,
  sum(if(lower(plan_clean)='business',1,0)) as business_deleted,
  sum(if(lower(plan_clean)='trial',1,0)) as trial_deleted,
  
from
  `netdata-analytics-bi.data360.space360_daily_deleted`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1 
)

select
  coalesce(space_counts.date,space_deletes.date) as date,
  
  earlybird,
  earlybird_new,
  earlybird_lost,
  earlybird_deleted,

  community,
  community_new,
  community_lost,
  community_deleted,

  pro,
  pro_new,
  pro_lost,
  pro_deleted,

  business,
  business_new,
  business_lost,
  business_deleted,

  trial,
  trial_new
from
  space_counts 
left outer join
  space_deletes
on
  space_counts.date = space_deletes.date
order by 1 desc
```

### Node Flows (panel 22)
- Type: table
- Datasource UID: AFVKEGK4k
- Project: netdata-analytics-bi
- Ref: A
- Tables: netdata-analytics-bi.data360.space360_daily
- Interpretation: Computes date(_partitiontime) as date, -- could do weekly but would need be more careful about what aggs then per col --date_trun from netdata-analytics-bi.data360.space360_daily.

```sql
select
  date(_partitiontime) as date,
  -- could do weekly but would need be more careful about what aggs then per col
  --date_trunc(date(_partitiontime),week) as week,

  -- early bird
  sum(if(has_subscription=0,node_count_is_reachable,null)) 
  as early_bird,
  sum(if(has_subscription=0,node_count_is_reachable_plus,null)) 
  as early_bird_plus,
  sum(if(has_subscription=0,node_count_is_reachable_minus,null)) 
  as early_bird_minus,
  sum(if(has_subscription=0,node_count_is_reachable_delta,null)) 
  as early_bird_delta,

  -- community
  sum(if(has_subscription_community=1,node_count_is_reachable,null)) 
  as community,
  sum(if(has_subscription_community=1,node_count_is_reachable_plus,null)) 
  as community_plus,
  sum(if(has_subscription_community=1,node_count_is_reachable_minus,null)) 
  as community_minus,
  sum(if(has_subscription_community=1,node_count_is_reachable_delta,null)) 
  as community_delta,

  -- pro monthly
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable,null)) 
  as pro_monthly,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_plus,null)) 
  as pro_monthly_plus,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_minus,null)) 
  as pro_monthly_minus,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_delta,null)) 
  as pro_monthly_delta,
  sum(if(subscription_has_churn_today=1 and has_subscription_pro_yesterday=1 and has_subscription_monthly_yesterday=1,node_count_is_reachable_yesterday,null)) 
  as pro_monthly_churn,

  -- pro annual
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable,null)) 
  as pro_annual,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_plus,null)) 
  as pro_annual_plus,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_minus,null)) 
  as pro_annual_minus,
  sum(if(has_paid_subscription=1 and has_subscription_pro=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_delta,null)) 
  as pro_annual_delta,
  sum(if(subscription_has_churn_today=1 and has_subscription_pro_yesterday=1 and has_subscription_annual_yesterday=1,node_count_is_reachable_yesterday,null)) 
  as pro_annual_churn,
  
  -- business monthly
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable,null)) 
  as business_monthly,
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_plus,null)) 
  as business_monthly_plus,
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_minus,null)) 
  as business_monthly_minus,
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_monthly=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_delta,null)) 
  as business_monthly_delta,
  sum(if(subscription_has_churn_today=1 and has_subscription_business_yesterday=1 and has_subscription_monthly_yesterday=1,node_count_is_reachable_yesterday,null)) 
  as business_monthly_churn,

  -- business annual
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable,null)) 
  as business_annual,
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_plus,null)) 
  as business_annual_plus,
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_minus,null)) 
  as business_annual_minus,
  sum(if(has_paid_subscription=1 and has_subscription_business=1 and has_subscription_annual=1 and subscription_trial_ends_at IS NULL,node_count_is_reachable_delta,null)) 
  as business_annual_delta,
  sum(if(subscription_has_churn_today=1 and has_subscription_business_yesterday=1 and has_subscription_annual_yesterday=1,node_count_is_reachable_yesterday,null)) 
  as business_annual_churn,

  -- business_trial
  sum(if(has_subscription_business=1 and subscription_trial_ends_at IS NOT NULL,node_count_is_reachable,null)) 
  as business_trial,
  sum(if(has_subscription_business=1 and subscription_trial_ends_at IS NOT NULL,node_count_is_reachable_plus,null)) 
  as business_trial_plus,
  sum(if(has_subscription_business=1 and subscription_trial_ends_at IS NOT NULL,node_count_is_reachable_minus,null)) 
  as business_trial_minus,
  sum(if(has_subscription_business=1 and subscription_trial_ends_at IS NOT NULL,node_count_is_reachable_delta,null)) 
  as business_trial_delta,
  
from
  `netdata-analytics-bi.data360.space360_daily`
where
  date(_partitiontime) >= date('${__from:date}')
  and
  date(_partitiontime) <= date('${__to:date}') 
group by 1
```


<!-- END: GRAFANA-BQ-QUERIES -->
