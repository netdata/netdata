#!/sbin/openrc-run
# SPDX-License-Identifier: GPL-3.0-or-later

# The user netdata is configured to run as.
# If you edit its configuration file to set a different
# user, set it here too, to have its files switch ownership
: "${NETDATA_OWNER:=netdata:netdata}"

# The timeout in seconds to wait for netdata
# to save its database on disk and exit.
: "${NETDATA_WAIT_EXIT_TIMEOUT:=60}"

# When set to 1, if netdata does not exit in
# NETDATA_WAIT_EXIT_TIMEOUT, we will force it
# to exit.
: "${NETDATA_FORCE_EXIT:=0}"

# When set to 1, we use netdatacli for reload/rotate/save commands instead of s-s-d.
: "${NETDATA_USE_NETDATACLI:=0}"

extra_started_commands="reload rotate save"
pidfile="@localstatedir_POST@/run/netdata/netdata.pid"
command_prefix="@sbindir_POST@"
command="${command_prefix}/netdata"
command_args="-P ${pidfile} ${NETDATA_EXTRA_ARGS}"
start_stop_daemon_args="-u ${NETDATA_OWNER}"
required_files="/etc/netdata/netdata.conf"
if [ "${NETDATA_FORCE_EXIT}" -eq 1 ]; then
    retry="TERM/${NETDATA_WAIT_EXIT_TIMEOUT}/KILL/1"
else
    retry="TERM/${NETDATA_WAIT_EXIT_TIMEOUT}"
fi

depend() {
    use logger
    need net
    after apache2 squid nginx mysql named opensips upsd hostapd postfix lm_sensors
}

start_pre() {
    checkpath -o ${NETDATA_OWNER} -d @localstatedir_POST@/cache/netdata @localstatedir_POST@/run/netdata
}

reload() {
    ebegin "Reloading Netdata health configuration"
    if [ "${NETDATA_USE_NETDATACLI}" = 1 ]; then
        "${command_prefix}/netdatacli" reload-health >/dev/null
        eend $? "Failed to reload Netdata health configuration"
    else
        start-stop-daemon --signal SIGUSR2 --pidfile "${pidfile}"
        eend $? "Failed to reload Netdata health configuration"
    fi
}

rotate() {
    ebegin "Reopening Netdata log files"
    if [ "${NETDATA_USE_NETDATACLI}" = 1 ]; then
        "${command_prefix}/netdatacli" reopen-logs >/dev/null
        eend $? "Failed to reopen Netdata log files"
    else
        start-stop-daemon --signal SIGHUP --pidfile "${pidfile}"
        eend $? "Failed to reopen Netdata log files"
    fi
}

save() {
    ebegin "Saving Netdata database"
    if [ "${NETDATA_USE_NETDATACLI}" = 1 ]; then
        "${command_prefix}/netdatacli" save-database >/dev/null
        eend $? "Failed to save Netdata database"
    else
        start-stop-daemon --signal SIGUSR1 --pidfile "${pidfile}"
        eend $? "Failed to save Netdata database"
    fi
}
