<!DOCTYPE html>
<html>
<head>
  <style>
    #wrapper {
      width: 600px;
      border: 1px solid black;
      overflow: hidden;
    }
    #form {
      width: 400px;
      float:left; 
    }
    #results {
      overflow: hidden;
    }

    table {
      table-layout: fixed;
      width: 80%;
      border-collapse: collapse;
      border: 3px solid rgb(0, 0, 0);
    }

    thead th:nth-child(1) {
      width: 20%;
    }

    thead th:nth-child(2) {
      width: 80%;
    }

    th,
    td {
      padding: 5px;
    }
  </style>
</head>
<body>

<h2>Logs management queries</h2>
<hr>

<!-- <select id="myselect" onchange="change_myselect(this.value)">
  <option value="">Choose an option:</option>
  <option value="customers">Customers</option>
  <option value="products">Products</option>
  <option value="suppliers">Suppliers</option>
</select> -->

<h3>Query parameters</h3>

<form id="form" name="query_form" action="javascript:submit_query()"">
  <label for="req_from">Requested from:</label>
  <input type="text" id="req_from" name="req_from"><br><br>
  <label for="req_until">Requested until:</label>
  <input type="text" id="req_until" name="req_until" ><br><br>
  <label for="quota">Quota in bytes:</label>
  <input type="text" id="quota" name="quota" ><br><br>
  <label for="keyword">Keyword / regex:</label>
  <input type="text" id="keyword" name="keyword" ><br><br>
  <label for="keyword_is_regex">Keyword is a regular expression:</label>
  <input type="checkbox" id="keyword_is_regex" name="keyword_is_regex" ><br><br>
  <label for="keyword_case_sensitive">Case-sensitive keyword / regex search:</label>
  <input type="checkbox" id="keyword_case_sensitive" name="keyword_case_sensitive" ><br><br>
  <input type="submit" value="Submit">
</form>

<div id="results"></div>

<script>
document.getElementById('req_from').value = '1';
document.getElementById('req_until').value = '100000000000000';
document.getElementById('quota').value = '524288';
document.getElementById('keyword_is_regex').checked = true;
document.getElementById('keyword_case_sensitive').checked = false;

function submit_query() {
  // const dbParam = JSON.stringify({table:sel,limit:20});
  const xmlhttp = new XMLHttpRequest();
  xmlhttp.onload = function() {
    results_obj = JSON.parse(this.responseText);
    console.log(results_obj);
    text =  "<h3>Results</h3>" +
            "API version: " + results_obj.api_version + "<br>" +
            "Requested from: " + results_obj.requested_from + "<br>" +
            "Requested until: " + results_obj.requested_until + "<br>" +
            "Actual from: " + results_obj.actual_from + "<br>" +
            "Actual until: " + results_obj.actual_until + "<br>" +
            "Keyword matches on this page: " + results_obj.keyword_matches + "<br>" +
            "User time: " + results_obj.user_time + "<br>" +
            "System time: " + results_obj.system_time + "<br>" +
            "Error code: " + results_obj.error_code + "<br>" +
            "Error message: " + results_obj.error + "<br>";
    text += "<br><table border='1'><thead><tr><th>Collection time</th><th>Log Record</th></thead>";
    
      results_obj.data.forEach(function(data_entry) {
      datetime = new Date(data_entry[0]); // The 0 there is the key, which sets the date to the epoch
      data_entry[1].forEach(function(log_entry) {
        text += "<tr><td>" + datetime + "</td><td>" + log_entry + "</td></tr>";
      });
    });
    text += "</table>";
    document.getElementById("results").innerHTML = text;
  }
  req_from = document.getElementById("req_from");
  req_from_value = encodeURIComponent(req_from.value);
  req_until = document.getElementById("req_until");
  req_until_value = encodeURIComponent(req_until.value);
  quota = document.getElementById("quota");
  quota_value = encodeURIComponent(quota.value);
  keyword = document.getElementById("keyword");
  keyword_value = encodeURIComponent(keyword.value);
  sanitize_keyword = document.getElementById('keyword_is_regex').checked ? "0" : "1";
  ignore_case = document.getElementById('keyword_case_sensitive').checked ? "0" : "1";
  xmlhttp.open("GET", "http://localhost:19999/api/v1/logsmanagement?" + 
                      "from=" + req_from_value + 
                      "&until=" + req_until_value + 
                      "&quota=" + quota_value +
                      "&keyword=" + keyword_value +
                      "&sanitize_keyword=" + sanitize_keyword +
                      "&ignore_case=" + ignore_case +
                      "&chart_name=Systemd%20Logs", true);
  xmlhttp.send(null);
}
</script>

</body>
</html>
