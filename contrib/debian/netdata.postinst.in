#! /bin/sh

set -e

dpkg-maintscript-helper dir_to_symlink \
	/var/lib/netdata/www/.well-known /usr/share/netdata/www/.well-known 1.18.1~ netdata -- "$@"
dpkg-maintscript-helper dir_to_symlink \
	/var/lib/netdata/www/css /usr/share/netdata/www/css 1.18.1~ netdata -- "$@"
dpkg-maintscript-helper dir_to_symlink \
	/var/lib/netdata/www/fonts /usr/share/netdata/www/fonts 1.18.1~ netdata -- "$@"
dpkg-maintscript-helper dir_to_symlink \
	/var/lib/netdata/www/images /usr/share/netdata/www/images 1.18.1~ netdata -- "$@"
dpkg-maintscript-helper dir_to_symlink \
	/var/lib/netdata/www/lib /usr/share/netdata/www/lib 1.18.1~ netdata -- "$@"
dpkg-maintscript-helper dir_to_symlink \
	/var/lib/netdata/www/static /usr/share/netdata/www/static 1.18.1~ netdata -- "$@"

case "$1" in
  configure)
        if [ -z "$2" ]; then
          if ! getent group netdata >/dev/null; then
              addgroup --quiet --system netdata
          fi

          if ! getent passwd netdata >/dev/null; then
              adduser --quiet --system --ingroup netdata --home /var/lib/netdata --no-create-home netdata
          fi

          if ! dpkg-statoverride --list /var/lib/netdata >/dev/null 2>&1; then
              dpkg-statoverride --update --add netdata netdata 0755 /var/lib/netdata
          fi

          if ! dpkg-statoverride --list /var/lib/netdata/www >/dev/null 2>&1; then
              dpkg-statoverride --update --add root netdata 0755 /var/lib/netdata/www
          fi

          if ! dpkg-statoverride --list /var/cache/netdata >/dev/null 2>&1; then
              dpkg-statoverride --update --add netdata netdata 0755 /var/cache/netdata
          fi

        fi

        dpkg-statoverride --update --add --force root netdata 0775 /var/lib/netdata/registry
        chown -R root:netdata /usr/share/netdata
        chown -R root:netdata /usr/libexec/netdata/plugins.d
	chown -R root:netdata /var/lib/netdata/www
        setcap cap_dac_read_search,cap_sys_ptrace+ep /usr/libexec/netdata/plugins.d/apps.plugin

#PERMS#
        ;;
esac

#DEBHELPER#

exit 0
